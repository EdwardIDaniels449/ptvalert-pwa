<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Google Maps API加载测试 v2</title>
    
    <!-- 加载API守卫 -->
    <script src="./js/api-loading-guard.js"></script>
    
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        #map {
            height: 40%;
            width: 100%;
        }
        
        .controls {
            padding: 15px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
        }
        
        .status {
            padding: 10px;
            background: #e9f7ef;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
        }
        
        .status span {
            font-weight: bold;
        }
        
        button {
            padding: 8px 15px;
            margin: 5px;
            background: #0071e3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        #log {
            height: 30%;
            overflow-y: auto;
            padding: 10px;
            background: #f0f0f0;
            border-top: 1px solid #ddd;
            font-family: monospace;
            font-size: 14px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .error { color: red; }
        .warn { color: orange; }
        .info { color: blue; }
        .success { color: green; }
    </style>
</head>
<body>
    <div class="controls">
        <h2>Google Maps API加载测试 v2</h2>
        <p>此页面测试API守卫是否能防止多种方式重复加载Google Maps API</p>
        
        <div class="status">
            <div>
                API已加载: <span id="loadedStatus">检查中...</span>
            </div>
            <div>
                API正在加载: <span id="loadingStatus">检查中...</span>
            </div>
            <div>
                地图已初始化: <span id="mapInitStatus">否</span>
            </div>
            <div>
                标记数量: <span id="markerCount">0</span>
            </div>
        </div>
        
        <h3>测试方法:</h3>
        <div class="button-group">
            <button id="loadApiBtn1">加载API (方式1 - script标签)</button>
            <button id="loadApiBtn2">加载API (方式2 - 动态脚本)</button>
            <button id="loadApiBtn3">加载API (方式3 - document.write)</button>
            <button id="loadApiBtn4">加载API (方式4 - eval)</button>
            <button id="loadApiBtn5">加载API (方式5 - innerHTML)</button>
        </div>
        
        <h3>地图操作:</h3>
        <div class="button-group">
            <button id="loadMapBtn">初始化地图</button>
            <button id="addMarkerBtn">添加标记</button>
            <button id="clearMarkersBtn">清除标记</button>
            <button id="clearLogBtn">清空日志</button>
        </div>
    </div>
    
    <div id="map"></div>
    
    <div id="log"></div>
    
    <script>
        // 全局变量
        let map = null;
        let markers = [];
        
        // 重写console方法以捕获日志
        const originalConsole = {
            log: console.log,
            warn: console.warn,
            error: console.error,
            info: console.info
        };
        
        const logDiv = document.getElementById('log');
        
        function addLogEntry(type, ...args) {
            const message = args.map(arg => {
                if (typeof arg === 'object') {
                    try {
                        return JSON.stringify(arg);
                    } catch (e) {
                        return arg.toString();
                    }
                }
                return arg;
            }).join(' ');
            
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${type}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // 调用原始console方法
            originalConsole[type](...args);
        }
        
        console.log = (...args) => addLogEntry('info', ...args);
        console.warn = (...args) => addLogEntry('warn', ...args);
        console.error = (...args) => addLogEntry('error', ...args);
        console.info = (...args) => addLogEntry('info', ...args);
        
        // 更新状态显示
        function updateStatus() {
            document.getElementById('loadedStatus').textContent = 
                window.GOOGLE_MAPS_LOADED ? '是' : '否';
            document.getElementById('loadingStatus').textContent = 
                window.GOOGLE_MAPS_LOADING ? '是' : '否';
            document.getElementById('mapInitStatus').textContent = 
                map ? '是' : '否';
            document.getElementById('markerCount').textContent = 
                markers.length;
            
            // 设置状态颜色
            document.getElementById('loadedStatus').style.color = 
                window.GOOGLE_MAPS_LOADED ? 'green' : 'red';
            document.getElementById('loadingStatus').style.color = 
                window.GOOGLE_MAPS_LOADING ? 'orange' : 'green';
            document.getElementById('mapInitStatus').style.color = 
                map ? 'green' : 'red';
        }
        
        // 定期更新状态
        setInterval(updateStatus, 1000);
        
        // 清空日志
        document.getElementById('clearLogBtn').addEventListener('click', function() {
            logDiv.innerHTML = '';
        });
        
        // 清除标记
        document.getElementById('clearMarkersBtn').addEventListener('click', function() {
            console.log('清除所有标记');
            if (markers.length > 0) {
                markers.forEach(marker => marker.setMap(null));
                markers = [];
                updateStatus();
            }
        });
        
        // 测试加载API - 方式1：直接添加script标签
        document.getElementById('loadApiBtn1').addEventListener('click', function() {
            console.log('尝试加载Google Maps API (方式1 - script标签)');
            
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyCE-oMIlcnOeqplgMmL9y1qcU6A9-HBu9U&callback=onMapsLoaded&v=' + new Date().getTime();
            script.async = true;
            script.defer = true;
            
            window.onMapsLoaded = function() {
                console.log('onMapsLoaded回调被触发');
            };
            
            document.head.appendChild(script);
        });
        
        // 测试加载API - 方式2：动态创建脚本
        document.getElementById('loadApiBtn2').addEventListener('click', function() {
            console.log('尝试加载Google Maps API (方式2 - 动态脚本)');
            
            // 创建临时回调
            window.tempMapCallback = function() {
                console.log('tempMapCallback回调被触发');
            };
            
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyCE-oMIlcnOeqplgMmL9y1qcU6A9-HBu9U&callback=tempMapCallback&v=' + new Date().getTime();
            script.async = true;
            document.head.appendChild(script);
        });
        
        // 测试加载API - 方式3：document.write
        document.getElementById('loadApiBtn3').addEventListener('click', function() {
            console.log('尝试加载Google Maps API (方式3 - document.write)');
            
            // 创建临时回调
            window.docWriteCallback = function() {
                console.log('docWriteCallback回调被触发');
            };
            
            // 尝试使用document.write注入脚本
            const scriptHtml = `<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCE-oMIlcnOeqplgMmL9y1qcU6A9-HBu9U&callback=docWriteCallback&v=${new Date().getTime()}" async defer><\/script>`;
            
            // 使用iframe来避免破坏当前页面
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            try {
                iframe.contentDocument.write(scriptHtml);
                iframe.contentDocument.close();
            } catch (e) {
                console.error('document.write注入失败:', e);
            }
        });
        
        // 测试加载API - 方式4：eval
        document.getElementById('loadApiBtn4').addEventListener('click', function() {
            console.log('尝试加载Google Maps API (方式4 - eval)');
            
            // 创建临时回调
            window.evalCallback = function() {
                console.log('evalCallback回调被触发');
            };
            
            // 尝试使用eval注入脚本
            const evalCode = `
                const scriptEl = document.createElement('script');
                scriptEl.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyCE-oMIlcnOeqplgMmL9y1qcU6A9-HBu9U&callback=evalCallback&v=${new Date().getTime()}';
                scriptEl.async = true;
                document.head.appendChild(scriptEl);
            `;
            
            try {
                eval(evalCode);
            } catch (e) {
                console.error('eval注入失败:', e);
            }
        });
        
        // 测试加载API - 方式5：innerHTML
        document.getElementById('loadApiBtn5').addEventListener('click', function() {
            console.log('尝试加载Google Maps API (方式5 - innerHTML)');
            
            // 创建临时回调
            window.innerHTMLCallback = function() {
                console.log('innerHTMLCallback回调被触发');
            };
            
            // 尝试使用innerHTML注入脚本
            const container = document.createElement('div');
            container.innerHTML = `<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCE-oMIlcnOeqplgMmL9y1qcU6A9-HBu9U&callback=innerHTMLCallback&v=${new Date().getTime()}" async defer><\/script>`;
            
            document.body.appendChild(container);
        });
        
        // 初始化地图
        document.getElementById('loadMapBtn').addEventListener('click', function() {
            console.log('尝试初始化地图');
            
            if (!window.google || !window.google.maps) {
                console.error('Google Maps API未加载，无法初始化地图');
                return;
            }
            
            try {
                // 如果地图已初始化，不再重复创建
                if (map) {
                    console.log('地图已初始化，将居中显示');
                    map.setCenter({lat: -37.8136, lng: 144.9631});
                    return;
                }
                
                map = new google.maps.Map(document.getElementById('map'), {
                    center: {lat: -37.8136, lng: 144.9631},
                    zoom: 13
                });
                
                console.log('地图初始化成功');
                updateStatus();
            } catch (e) {
                console.error('初始化地图时出错:', e);
            }
        });
        
        // 添加标记
        document.getElementById('addMarkerBtn').addEventListener('click', function() {
            console.log('尝试添加标记');
            
            if (!window.google || !window.google.maps || !map) {
                console.error('地图未初始化，无法添加标记');
                return;
            }
            
            try {
                // 随机坐标，在墨尔本附近
                const lat = -37.8136 + (Math.random() - 0.5) * 0.05;
                const lng = 144.9631 + (Math.random() - 0.5) * 0.05;
                
                const marker = new google.maps.Marker({
                    position: {lat, lng},
                    map: map,
                    title: '标记 #' + (markers.length + 1),
                    animation: google.maps.Animation.DROP
                });
                
                markers.push(marker);
                console.log('标记添加成功，位置:', lat, lng);
                updateStatus();
            } catch (e) {
                console.error('添加标记时出错:', e);
            }
        });
        
        // 初始化页面
        window.addEventListener('load', function() {
            console.log('页面加载完成');
            
            // 打印当前Google Maps API状态
            console.log('当前API状态:',
                window.GOOGLE_MAPS_LOADED ? '已加载' :
                window.GOOGLE_MAPS_LOADING ? '正在加载' : '未加载'
            );
            
            // 更新状态显示
            updateStatus();
            
            // 注册Google Maps加载事件监听器
            document.addEventListener('google_maps_loaded', function() {
                console.log('收到Maps API加载完成事件');
                updateStatus();
            });
        });
    </script>
</body>
</html> 
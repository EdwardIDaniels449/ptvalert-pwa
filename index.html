<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- å…¨å±€å˜é‡åˆå§‹åŒ– - å¿…é¡»æœ€å…ˆåŠ è½½ -->
    <script>
      // å¢¨å°”æœ¬ä¸­å¿ƒåæ ‡ - å…¨å±€å˜é‡
      window.MELBOURNE_CENTER = {lat: -37.8136, lng: 144.9631};
      
      // åˆå§‹åŒ–å…¨å±€å˜é‡
      window.currentLang = localStorage.getItem('preferredLanguage') || 'zh'; // Default language
      // Define isMobile globally here if it originates from index.html
      window.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      console.log('[index.html] Global isMobile:', window.isMobile);
    </script>
    
    <!-- PWA Manifestä¿®å¤è„šæœ¬ - è§£å†³ç§»åŠ¨è®¾å¤‡ä¸Šçš„PWAé—®é¢˜ -->
    <script src="js/manifest-fix.js"></script>
    
    <!-- çº¯Google Mapsä¿®å¤è„šæœ¬ - åœ¨å…¶ä»–è„šæœ¬ä¹‹å‰åŠ è½½ -->
    <script src="js/pure-google-maps-fix.js?v=2023051602"></script>
    
    <!-- ç´§æ€¥é‡å®šå‘è„šæœ¬ - å¿…é¡»æœ€å…ˆåŠ è½½ -->
    <script src="redirect.js"></script>
    <!-- Cloudflareé…ç½® - å¿…é¡»æœ€å…ˆåŠ è½½ -->
    <script src="cloudflare-config.js"></script>
    <!-- å…¨é¢APIä¿®å¤è„šæœ¬ - å¿…é¡»æœ€å…ˆåŠ è½½ -->
    <script src="fix-api-mode.js"></script>
    <!-- APIè¯Šæ–­å¼¹çª—ç§»é™¤è„šæœ¬ -->
    <script src="js/remove-api-popup.js"></script>
    <!-- å¼•ç”¨é”™è¯¯ä¿®å¤è„šæœ¬ - å¿…é¡»æœ€å…ˆåŠ è½½ -->
    <script src="js/reference-error-fix.js"></script>
    <!-- åœ°å›¾åŠ è½½è¾…åŠ©è„šæœ¬ -->
    <script src="js/map-loader.js"></script>
    <meta name="theme-color" content="#ffffff">
    <!-- ç´§æ€¥ä¿®å¤ç¼“å­˜å‡½æ•°æœªå®šä¹‰é”™è¯¯ -->
    <script src="emergency-fix.js"></script>
    <!-- åœ°å›¾ç´§æ€¥ä¿®å¤è„šæœ¬ - è§£å†³Google Maps APIåŠ è½½é—®é¢˜ -->
    <script src="map-emergency-fix.js"></script>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="description" content="å¢¨å°”æœ¬äº¤é€šä¿¡æ¯å…±äº«å¹³å°">
    <meta name="apple-mobile-web-app-title" content="PtvAlert">
    
    <!-- å…¨å±€å˜é‡ä¿®å¤è„šæœ¬ - å¿…é¡»æœ€å…ˆåŠ è½½ -->
    <script src="./js/globals-fix.js"></script>
    <script src="./js/cache-functions.js"></script>
    <!-- å¼ºåˆ¶ä½¿ç”¨çœŸå®API -->
    <script src="force-real-api.js"></script>
    <script src="config.js"></script>
    <script src="vapid-keys.js"></script>
    <script src="push-client.js"></script>
    
    <!-- Firebaseä¸CloudflareåŒæ­¥è„šæœ¬ -->
    <script src="./js/firebase-to-cloudflare-sync.js"></script>
    
    <!-- ä¿®å¤ç‰ˆService Workeræ³¨å†Œè„šæœ¬ -->
    <script>
        // ç¡®ä¿Service Workeræ­£ç¡®æ³¨å†Œ
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async function() {
                try {
                    console.log('[Service Worker] å¼€å§‹æ³¨å†ŒService Worker...');
                    
                    // å…ˆå¸è½½æ‰€æœ‰ç°æœ‰çš„Service Worker
                    try {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for (let registration of registrations) {
                            console.log('[Service Worker] å¸è½½æ—§çš„Service Worker:', registration.scope);
                            await registration.unregister();
                        }
                        console.log('[Service Worker] æ‰€æœ‰æ—§Service Workerå·²å¸è½½');
                    } catch (unregError) {
                        console.warn('[Service Worker] å¸è½½æ—§Service Workeræ—¶å‡ºé”™:', unregError);
                    }
                    
                    // ä¸ºä¸åŒç¯å¢ƒå‡†å¤‡æ­£ç¡®çš„Service Workerè·¯å¾„
                    let swPath = './service-worker.js';
                    
                    // æ£€æµ‹GitHub Pagesç¯å¢ƒå¹¶ä¿®æ­£è·¯å¾„
                    if (window.location.hostname.includes('github.io')) {
                        const pathSegments = window.location.pathname.split('/');
                        if (pathSegments.length >= 2 && pathSegments[1]) {
                            const repoName = pathSegments[1];
                            swPath = '/' + repoName + '/service-worker.js';
                            console.log('[Service Worker] æ£€æµ‹åˆ°GitHub Pagesç¯å¢ƒï¼Œä½¿ç”¨è·¯å¾„:', swPath);
                        }
                    }
                    
                    // é’ˆå¯¹ç§»åŠ¨è®¾å¤‡ä½¿ç”¨æ›´ç®€å•çš„æ³¨å†Œæµç¨‹
                    if (window.isMobile) {
                        console.log('[Service Worker] æ£€æµ‹åˆ°ç§»åŠ¨è®¾å¤‡ï¼Œä½¿ç”¨ç®€åŒ–æ³¨å†Œæµç¨‹');
                        
                        try {
                            const registration = await navigator.serviceWorker.register(swPath);
                            console.log('[Service Worker] ç§»åŠ¨è®¾å¤‡æ³¨å†ŒæˆåŠŸ:', registration.scope);
                        } catch (mobileError) {
                            console.error('[Service Worker] ç§»åŠ¨è®¾å¤‡æ³¨å†Œå¤±è´¥:', mobileError);
                            console.log('[Service Worker] å°è¯•ä½¿ç”¨å¤‡ç”¨Service Worker');
                            
                            try {
                                const fallbackReg = await navigator.serviceWorker.register('./fallback-service-worker.js');
                                console.log('[Service Worker] å¤‡ç”¨Service Workeræ³¨å†ŒæˆåŠŸ:', fallbackReg.scope);
                            } catch (fallbackError) {
                                console.error('[Service Worker] å¤‡ç”¨Service Workerä¹Ÿæ³¨å†Œå¤±è´¥:', fallbackError);
                                
                                // ä½¿ç”¨å†…è”æœ€å°Service Workerä½œä¸ºæœ€åçš„å…œåº•æ–¹æ¡ˆ
                                try {
                                    const minimalSW = new Blob([
                                        `self.addEventListener('install', () => self.skipWaiting());
                                        self.addEventListener('activate', e => e.waitUntil(clients.claim()));
                                        self.addEventListener('fetch', e => e.respondWith(fetch(e.request).catch(() => 
                                            new Response('ç¦»çº¿æ¨¡å¼ï¼Œè¯·ç¨åé‡è¯•'))));`
                                    ], {type: 'application/javascript'});
                                    
                                    const minimalURL = URL.createObjectURL(minimalSW);
                                    const minimalReg = await navigator.serviceWorker.register(minimalURL);
                                    console.log('[Service Worker] å†…è”æœ€å°Service Workeræ³¨å†ŒæˆåŠŸ');
                                } catch (inlineError) {
                                    console.error('[Service Worker] æ‰€æœ‰æ³¨å†Œæ–¹æ³•éƒ½å¤±è´¥');
                                }
                            }
                        }
                        return;
                    }
                    
                    // æ¡Œé¢è®¾å¤‡ä½¿ç”¨æ ‡å‡†æ³¨å†Œæµç¨‹
                    try {
                        const registration = await navigator.serviceWorker.register(swPath, {
                            scope: './'
                        });
                        console.log('[Service Worker] æ³¨å†ŒæˆåŠŸ:', registration.scope);
                    } catch (mainError) {
                        console.error('[Service Worker] ä¸»Service Workeræ³¨å†Œå¤±è´¥:', mainError);
                        
                        try {
                            console.log('[Service Worker] å°è¯•æ³¨å†Œå¤‡ç”¨Service Worker');
                            const fallbackReg = await navigator.serviceWorker.register('./fallback-service-worker.js', {
                                scope: './'
                            });
                            console.log('[Service Worker] å¤‡ç”¨Service Workeræ³¨å†ŒæˆåŠŸ:', fallbackReg.scope);
                        } catch (fallbackError) {
                            console.error('[Service Worker] å¤‡ç”¨Service Workeræ³¨å†Œä¹Ÿå¤±è´¥:', fallbackError);
                            
                            if (window.location.hostname.includes('github.io')) {
                                console.log('[Service Worker] å°è¯•ä½¿ç”¨å†…è”Service Worker');
                                
                                const minimalSWBlob = new Blob([`
                                    self.addEventListener('install', () => self.skipWaiting());
                                    self.addEventListener('activate', event => event.waitUntil(clients.claim()));
                                    self.addEventListener('fetch', event => event.respondWith(fetch(event.request)));
                                    console.log('å†…è”æœ€å°Service Workerå·²æ¿€æ´»');
                                `], {type: 'application/javascript'});
                                
                                const minimalSWUrl = URL.createObjectURL(minimalSWBlob);
                                
                                try {
                                    const inlineReg = await navigator.serviceWorker.register(minimalSWUrl, {
                                        scope: './'
                                    });
                                    console.log('[Service Worker] å†…è”Service Workeræ³¨å†ŒæˆåŠŸ:', inlineReg.scope);
                                } catch (inlineError) {
                                    console.error('[Service Worker] æ‰€æœ‰Service Workeræ³¨å†Œæ–¹æ³•éƒ½å¤±è´¥');
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('[Service Worker] å¤„ç†æœåŠ¡å·¥ä½œçº¿ç¨‹æ—¶å‡ºé”™:', error);
                }
            });
        }
    </script>
    
    <title>PtvAlert - åœ°å›¾æ ‡è®°ç³»ç»Ÿ</title>
    
    <!-- Manifestå’Œå›¾æ ‡ -->
    <link rel="manifest" href="./manifest.json">
    <!-- å†…è”åŸºæœ¬faviconé¿å…404é”™è¯¯ -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    
    <script>
        // å¤„ç†GitHub Pagesç¯å¢ƒä¸‹å›¾æ ‡è·¯å¾„é—®é¢˜
        if (window.location.hostname.includes('github.io')) {
            const pathSegments = window.location.pathname.split('/');
            if (pathSegments.length >= 2 && pathSegments[1]) {
                const repoName = pathSegments[1];
                const basePath = '/' + repoName;
                
                // æ›´æ–°å›¾æ ‡é“¾æ¥
                document.querySelectorAll('link[rel="icon"], link[rel="apple-touch-icon"], link[rel="manifest"]').forEach(link => {
                    const href = link.getAttribute('href');
                    if (href && href.startsWith('./')) {
                        link.setAttribute('href', basePath + href.substring(1));
                        console.log('[è·¯å¾„ä¿®å¤] æ›´æ–°èµ„æºè·¯å¾„:', href, '->', basePath + href.substring(1));
                    }
                });
            }
        }
    </script>
    
    <!-- æ ·å¼è¡¨ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    
    <!-- æ·»åŠ Firebase SDK è„šæœ¬ -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <!-- URLä¿®å¤å·¥å…· - å¤„ç†æ¨é€é€šçŸ¥URLé—®é¢˜ -->
    <script src="./js/url-fix.js?v=1.0.0"></script>
    
    <!-- æ¨é€é€šçŸ¥å¤„ç†è„šæœ¬ -->
    <script src="./js/notification-handler.js?v=2.0.1_20231121" id="notification-handler-script"></script>
    
    <!-- URLä¿®å¤è„šæœ¬ - ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„åŸŸå -->
    <script>
        (function() {
            // ç­‰å¾…notification-handleråŠ è½½å®Œæˆ
            window.setTimeout(function() {
                try {
                    // æ£€æŸ¥å…¨å±€å˜é‡API_BASE_URLæ˜¯å¦å­˜åœ¨
                    if (typeof API_BASE_URL !== 'undefined') {
                        // å¦‚æœä½¿ç”¨äº†é”™è¯¯çš„åŸŸåï¼Œåˆ™ä¿®å¤å®ƒ
                        if (API_BASE_URL.includes('your-subdomain.workers.dev')) {
                            console.warn('å‘ç°é”™è¯¯çš„API_BASE_URL:', API_BASE_URL);
                            API_BASE_URL = 'https://ptvalert.pages.dev';
                            console.warn('å·²ä¿®å¤ä¸º:', API_BASE_URL);
                        }
                    }
                } catch (e) {
                    console.error('æ£€æŸ¥æˆ–ä¿®å¤API_BASE_URLå¤±è´¥:', e);
                }
            }, 100);
        })();
    </script>
    
    <!-- å…ˆåŠ è½½è¾…åŠ©è„šæœ¬ï¼Œç¡®ä¿å®ƒä»¬åœ¨Google Maps APIä¹‹å‰åˆå§‹åŒ– -->
    <!-- åœ°å›¾åŠ è½½ä¿®å¤è„šæœ¬ï¼Œå¿…é¡»æœ€å…ˆåŠ è½½ -->
    <script src="js/fix-google-maps-callback.js"></script>

    <!-- Google Maps API è„šæœ¬ï¼Œæ·»åŠ è¶…æ—¶å‚æ•° -->
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCE-oMIlcnOeqplgMmL9y1qcU6A9-HBu9U&callback=googleMapsLoadedCallback&libraries=places&v=weekly"></script>

    <!-- åœ¨Google Maps APIåŠ è½½ååŠ è½½è¿™äº›è„šæœ¬ -->
    <script src="js/ui-controller.js"></script>
    <script src="js/data-connector.js"></script>
    <script src="js/app-connector.js"></script>
    <script src="js/functionality-recovery.js"></script>
    <script src="js/marker-handler.js"></script>
    
    <!-- æ·»åŠ Firebaseåˆå§‹åŒ–è„šæœ¬ -->
    <script src="js/firebase-initializer.js"></script>
</head>
<body>
    <!-- å³ä¸Šè§’è¯­è¨€åˆ‡æ¢æŒ‰é’® -->
    <button id="langSwitchBtn" style="position:fixed;top:18px;right:18px;z-index:1001;background:rgba(255,255,255,0.8);color:#333;border-radius:20px;padding:6px 12px;font-size:14px;font-weight:bold;box-shadow:0 2px 12px rgba(0,0,0,0.18);border:2px solid #0071e3;cursor:pointer;display:flex;align-items:center;gap:6px;transition:background 0.2s,border 0.2s;">
      <span style="font-size:16px;">ğŸŒ</span>
      <span id="langSwitchText">EN</span>
    </button>
    
    <!-- ç”¨æˆ·èœå• - å®Œå…¨éšè—ï¼Œä¸æ˜¾ç¤ºä»»ä½•å†…å®¹ -->
    <!-- ç§»é™¤æ‰€æœ‰ç”¨æˆ·èœå•ç›¸å…³ä»£ç  -->
    
    <!-- æ·»åŠ å¼¹å¹•å®¹å™¨ -->
    <div class="danmaku-container" id="danmakuContainer"></div>
    
    <!-- åœ°å›¾å®¹å™¨ -->
    <div id="map"></div>
    
    <!-- åœ°å›¾æ§åˆ¶ -->
    <div class="map-control">
        <div style="display:flex;gap:10px;margin-bottom:10px;">
            <button class="add-report-btn" id="addReportBtn" style="flex:1;background-color:white;color:#333;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;border:none;box-shadow:0 2px 10px rgba(0,0,0,0.3);cursor:pointer;">+ æ·»åŠ æŠ¥å‘Š</button>
            <button class="add-report-btn" id="quickAddBtn" style="flex:1;background-color:#34c759;color:white;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;border:none;box-shadow:0 2px 10px rgba(0,0,0,0.3);cursor:pointer;">+ ç›´æ¥æ·»åŠ æè¿°</button>
        </div>
        <div id="addReportTip" style="display:none;text-align:center;background-color:rgba(0,0,0,0.7);color:white;padding:10px;border-radius:8px;margin-top:10px;font-weight:bold;">è¯·åœ¨åœ°å›¾ä¸Šç‚¹é€‰ä½ç½®</div>
    </div>
    
    <!-- æ¨é€é€šçŸ¥æŒ‰é’® -->
    <div style="position:fixed;bottom:100px;right:20px;z-index:2000;">
        <button id="requestPushPermission" style="background-color:#0071e3;color:white;border:none;padding:10px 15px;border-radius:8px;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.3);display:flex;align-items:center;gap:6px;">
            <span style="font-size:20px;">ğŸ””</span>
            <span id="pushBtnText">å¯ç”¨æ¨é€é€šçŸ¥</span>
        </button>
    </div>
    
    <!-- æŠ¥å‘Šè®¡æ•°å™¨å¼¹çª— - é»˜è®¤éšè—ï¼Œä½¿ç”¨ä¸­å¤®å¼¹çª—è€Œéå³ä¾§è“è‰²å¼¹çª— -->
    <div class="popup-base" id="reportCounterPopup" style="display:none;">
        <h3 id="reportSuccessTitle" style="margin:0 0 15px 0;font-size:20px;font-weight:bold;">æŠ¥å‘Šæäº¤æˆåŠŸ!</h3>
        <div style="margin:15px 0;">
            <div style="font-size:18px;margin-bottom:10px;">
                <span id="reportCountText">ä»Šæ—¥å·²æ”¶åˆ°</span> 
                <span id="reportCount" style="font-weight:bold;font-size:24px;color:#4CAF50;">0</span> 
                <span id="reportCountSuffix">æ¡æŠ¥å‘Š</span>
            </div>
            <div style="font-size:14px;color:#aaa;" id="reportCounterThankYou">
                æ„Ÿè°¢æ‚¨çš„è´¡çŒ®!
            </div>
        </div>
        <button onclick="document.getElementById('reportCounterPopup').style.display='none';document.body.style.pointerEvents='auto';" class="popup-btn" style="background:#0071e3;color:white;border:none;padding:12px 20px;border-radius:8px;font-weight:bold;margin-top:15px;width:100%;">
            <span id="reportCounterCloseBtn">å…³é—­</span>
        </button>
    </div>
    
    <!-- æŠ¥å‘Šè¡¨å• -->
    <div class="report-form" id="reportForm" style="position:fixed; bottom:0; left:0; right:0; background-color:#1c1c1e; padding:20px; border-radius:20px 20px 0 0; box-shadow:0 -2px 10px rgba(0,0,0,0.5); z-index:2000; transform:translateY(100%); transition:transform 0.3s ease-in-out;">
        <div class="form-header">
            <h2 class="form-title" id="formTitle">æ–°æŠ¥å‘Š</h2>
            <button class="form-close" id="formClose" style="background:none;border:none;color:#fff;font-size:24px;cursor:pointer;">&times;</button>
        </div>
        
        <div class="form-group">
            <label class="form-label" id="photoLabel">ç…§ç‰‡</label>
            <div class="image-preview" style="width:100%;height:200px;border-radius:8px;background-color:#2c2c2e;display:flex;align-items:center;justify-content:center;margin-bottom:15px;overflow:hidden;position:relative;cursor:pointer;">
                <img src="" class="preview-img" id="previewImg" style="max-width:100%;max-height:100%;display:none;">
                <span class="image-placeholder" id="imagePlaceholder">ç‚¹å‡»æ·»åŠ ç…§ç‰‡</span>
                <input type="file" id="imageInput" accept="image/*" style="position:absolute;left:0;top:0;width:100%;height:100%;opacity:0;cursor:pointer;z-index:2;">
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label" id="descLabel">æè¿°</label>
            <textarea class="form-textarea" id="descriptionInput" placeholder="è¯·æè¿°æ‚¨çœ‹åˆ°çš„æƒ…å†µ..." style="width:100%;padding:12px;border-radius:8px;border:1px solid #444;background-color:#2c2c2e;color:#fff;font-size:16px;min-height:100px;resize:vertical;"></textarea>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
                <button id="geocodeLocationBtn" style="padding:6px 12px;background-color:#0077cc;color:white;border:none;border-radius:6px;font-size:14px;cursor:pointer;">æ ¹æ®æè¿°å®šä½</button>
                <button id="currentLocationBtn" style="padding:6px 12px;margin-left:8px;background-color:#34c759;color:white;border:none;border-radius:6px;font-size:14px;cursor:pointer;">ä½¿ç”¨å½“å‰ä½ç½®</button>
                <span style="font-size:12px;color:#999;margin-left:8px;flex:1;text-align:right;">æç¤º: è¾“å…¥åœ°ç‚¹æè¿°åç‚¹å‡»ï¼Œæˆ–ä½¿ç”¨Ctrl+Enterå¿«æ·é”®</span>
            </div>
            <div id="geocodeStatus" style="margin-top:5px;font-size:14px;color:#ffcc00;display:none;"></div>
        </div>
        
        <div style="display:flex;gap:10px;margin-top:15px;">
            <button class="submit-btn" id="submitReport" onclick="handleEmergencySubmit(event)" style="flex:1;background-color:#0071e3;color:white;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;position:relative;z-index:10000;">ç¡®å®š</button>
            <button class="reset-location-btn" id="resetLocationBtn" style="flex:1;background-color:#ffc107;color:#000;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;">é‡æ–°é€‰ç‚¹</button>
            <button class="cancel-btn" id="cancelReport" style="flex:1;background-color:#3a3a3c;color:white;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- å¿«é€Ÿæè¿°å¼¹çª— -->
    <div class="popup-base" id="quickAddForm" style="display:none; top:50%; left:50%; transform:translate(-50%, -50%); width:90%; max-width:400px; padding:20px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h2 id="quickFormTitle" style="font-size:20px;color:#fff;margin:0;">å¿«é€Ÿæ·»åŠ æè¿°</h2>
            <button id="quickAddClose" class="popup-btn" style="background:none;border:none;color:#fff;font-size:24px;margin:0;padding:0;">&times;</button>
        </div>
        
        <div>
            <label id="quickDescLabel" style="display:block;margin-bottom:8px;color:#fff;">æè¿°</label>
            <textarea id="quickDescInput" placeholder="è¯·ç®€å•æè¿°æ‚¨çœ‹åˆ°çš„æƒ…å†µ..." style="width:100%;padding:12px;border-radius:8px;border:1px solid #444;background-color:#2c2c2e;color:#fff;font-size:16px;min-height:100px;resize:vertical;"></textarea>
            <p style="font-size:12px;color:#999;margin-top:5px;">æç¤º: å°†ä½¿ç”¨åœ°å›¾ä¸­å¿ƒä½œä¸ºä½ç½®</p>
        </div>
        
        <div style="display:flex;gap:10px;margin-top:15px;">
            <button id="submitQuickAdd" class="popup-btn" style="flex:1;background-color:#0071e3;color:white;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;">ç¡®å®š</button>
            <button id="cancelQuickAdd" class="popup-btn" style="flex:1;background-color:#3a3a3c;color:white;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- æ·»åŠ ç´§æ€¥æäº¤å¤„ç†è„šæœ¬ -->
    <script>
    function handleEmergencySubmit(event) {
        event.preventDefault();
        console.log('ç´§æ€¥æäº¤æŒ‰é’®è¢«ç‚¹å‡»');
        
        try {
            const description = document.getElementById('descriptionInput').value;
            
            if (!description) {
                alert('è¯·è¾“å…¥æè¿°');
                return;
            }
            
            if (!window.selectedLocation) {
                alert('è¯·é€‰æ‹©ä½ç½®');
                return;
            }
            
            // å…³é—­è¡¨å•
            const reportForm = document.getElementById('reportForm');
            if (reportForm) {
                reportForm.style.transform = 'translateY(100%)';
                setTimeout(function() {
                    reportForm.style.display = 'none';
                }, 300);
            }
            
            // è·å–å›¾ç‰‡æ•°æ®
            const previewImg = document.getElementById('previewImg');
            const imageData = previewImg && previewImg.style.display !== 'none' ? previewImg.src : null;
            
            // åˆ›å»ºæŠ¥å‘Šæ•°æ®
            const reportData = {
                description: description,
                location: window.selectedLocation,
                image: imageData,
                timestamp: new Date().toISOString(),
                user: 'anonymous-user'
            };
            
            // ç›´æ¥æ·»åŠ æ ‡è®°åˆ°åœ°å›¾
            if (window.map && typeof google === 'object' && google.maps) {
                // ç¡®ä¿markersæ•°ç»„å·²åˆå§‹åŒ–
                if (!window.markers) {
                    window.markers = [];
                }
                
                // åˆ›å»ºæ ‡è®°
                const marker = new google.maps.Marker({
                    position: window.selectedLocation,
                    map: window.map,
                    animation: google.maps.Animation.DROP,
                    title: description,
                    label: {
                        text: 'ğŸ¶',
                        fontSize: '24px'
                    },
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 0
                    },
                    optimized: false
                });
                
                // ä¿å­˜æ ‡è®°
                window.markers.push(marker);
                
                // ä¸ºæ ‡è®°æ·»åŠ ç‚¹å‡»äº‹ä»¶
                marker.addListener('click', function() {
                    // å…³é—­ä»»ä½•å·²æ‰“å¼€çš„ä¿¡æ¯çª—å£
                    if (window.openedInfoWindow) {
                        window.openedInfoWindow.close();
                    }
                    
                    // åˆ›å»ºä¿¡æ¯çª—å£å†…å®¹ï¼ŒåŒ…æ‹¬æè¿°å’Œå¯èƒ½çš„å›¾ç‰‡
                    let content = '<div style="padding:10px;max-width:300px;">';
                    
                    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ·»åŠ å›¾ç‰‡
                    if (imageData) {
                        content += `<div style="margin-bottom:10px;"><img src="${imageData}" style="max-width:100%;max-height:150px;border-radius:4px;"></div>`;
                    }
                    
                    // æ·»åŠ æè¿°
                    content += `<div style="font-size:14px;margin-bottom:10px;">${description}</div>`;
                    
                    // æ·»åŠ æ—¶é—´æˆ³
                    const now = new Date();
                    content += `<div style="font-size:12px;color:#666;">${now.toLocaleDateString()} ${now.toLocaleTimeString()}</div>`;
                    
                    content += '</div>';
                    
                    // åˆ›å»ºå¹¶æ‰“å¼€ä¿¡æ¯çª—å£
                    const infoWindow = new google.maps.InfoWindow({
                        content: content,
                        maxWidth: 300
                    });
                    
                    infoWindow.open(window.map, marker);
                    
                    // ä¿å­˜å½“å‰æ‰“å¼€çš„ä¿¡æ¯çª—å£
                    window.openedInfoWindow = infoWindow;
                });
                
                // å°è¯•ä¿å­˜æ ‡è®°åˆ°localStorage
                try {
                    const markerData = window.markers.map(function(m) {
                        return {
                            lat: m.getPosition().lat(),
                            lng: m.getPosition().lng(),
                            description: m.getTitle() || '',
                            image: m === marker ? imageData : null
                        };
                    });
                    
                    localStorage.setItem('savedMarkers', JSON.stringify(markerData));
                    console.log('æ ‡è®°å·²ä¿å­˜åˆ°localStorage');
                } catch (error) {
                    console.error('ä¿å­˜æ ‡è®°åˆ°localStorageå¤±è´¥:', error);
                }
            } else {
                console.error('åœ°å›¾æœªåˆå§‹åŒ–ï¼Œæ— æ³•æ·»åŠ æ ‡è®°');
            }
            
            // æ˜¾ç¤ºæˆåŠŸå¼¹çª—
            const reportCounterPopup = document.getElementById('reportCounterPopup');
            if (reportCounterPopup) {
                reportCounterPopup.style.zIndex = '15000';
                reportCounterPopup.style.display = 'block';
                
                // 3ç§’åè‡ªåŠ¨å…³é—­
                setTimeout(function() {
                    reportCounterPopup.style.display = 'none';
                }, 3000);
            }
            
            console.log('ç´§æ€¥æäº¤æˆåŠŸ');
        } catch (error) {
            console.error('ç´§æ€¥æäº¤å¤±è´¥:', error);
            alert('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }
    </script>

    <!-- æ·»åŠ æ ‡è®°è‡ªåŠ¨æ¸…ç†è„šæœ¬ -->
    <script src="js/marker-cleanup-service.js"></script>
    
    <!-- æ·»åŠ æ ‡è®°æ¸…ç†ä¿®å¤è„šæœ¬ -->
    <script src="js/marker-cleanup-fix.js"></script>
</body>

<!-- è¾…åŠ©è„šæœ¬ -->
    <script>
  // å¤„ç†åœ°å›¾åˆå§‹åŒ–é”™è¯¯çš„å‡½æ•°
  function handleMapInitError() {
    // å¦‚æœå·²ç»æœ‰ç¦»çº¿æ¨¡å¼å¤„ç†ï¼Œä¸å†æ˜¾ç¤ºé¢å¤–çš„é”™è¯¯
    if (window.mapsInitialized || document.getElementById('offlineMapNotice')) {
      return;
    }
    
    // åˆ›å»ºä¸€ä¸ªç®€å•çš„åœ°å›¾æ›¿ä»£å…ƒç´ 
    const mapElement = document.getElementById('map');
    if (mapElement) {
      mapElement.style.backgroundImage = 'linear-gradient(to bottom, #cfd9df 0%, #e2ebf0 100%)';
      mapElement.style.backgroundSize = 'cover';
    }
    
    // åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿçš„åœ°å›¾å¯¹è±¡
    window.map = window.map || {
      getCenter: function() {
        return {
          lat: function() { return MELBOURNE_CENTER.lat; },
          lng: function() { return MELBOURNE_CENTER.lng; }
        };
      },
      setCenter: function() { return this; },
      addListener: function() { return { remove: function() {} }; }
    };
    
    // æç¤ºç”¨æˆ·
    const notice = document.createElement('div');
    notice.id = 'offlineMapNotice';
    notice.style.cssText = 'position:fixed;top:50px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);color:white;padding:10px 20px;border-radius:20px;z-index:1000;font-size:14px;text-align:center;';
    notice.textContent = 'åœ°å›¾åŠ è½½å—é™ï¼Œä½†æ‚¨ä»å¯æ·»åŠ æŠ¥å‘Š';
    document.body.appendChild(notice);
    
    // 5ç§’åç§»é™¤é€šçŸ¥
    setTimeout(function() {
      if (notice.parentNode) {
        notice.style.opacity = '0';
        notice.style.transition = 'opacity 0.5s';
        setTimeout(function() {
          if (notice.parentNode) {
            notice.parentNode.removeChild(notice);
          }
        }, 500);
      }
    }, 5000);
    
    // æ ‡è®°åœ°å›¾å·²åˆå§‹åŒ–ï¼ˆé¿å…é‡å¤æ˜¾ç¤ºé”™è¯¯ï¼‰
    window.mapsInitialized = true;
  }
    </script>

</html>


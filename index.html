<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- 全局变量初始化 - 必须最先加载 -->
    <script>
      // 墨尔本中心坐标 - 全局变量
      window.MELBOURNE_CENTER = {lat: -37.8136, lng: 144.9631};
      
      // 初始化全局变量
      window.currentLang = localStorage.getItem('preferredLanguage') || 'zh'; // Default language
      // Define isMobile globally here if it originates from index.html
      window.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      console.log('[index.html] Global isMobile:', window.isMobile);
    </script>
    
    <!-- PWA Manifest修复脚本 - 解决移动设备上的PWA问题 -->
    <script src="js/manifest-fix.js"></script>
    
    <!-- 纯Google Maps修复脚本 - 在其他脚本之前加载 -->
    <script src="js/pure-google-maps-fix.js?v=2023051602"></script>
    
    <!-- 紧急重定向脚本 - 必须最先加载 -->
    <script src="redirect.js"></script>
    <!-- Cloudflare配置 - 必须最先加载 -->
    <script src="cloudflare-config.js"></script>
    <!-- 全面API修复脚本 - 必须最先加载 -->
    <script src="fix-api-mode.js"></script>
    <!-- API诊断弹窗移除脚本 -->
    <script src="js/remove-api-popup.js"></script>
    <!-- 引用错误修复脚本 - 必须最先加载 -->
    <script src="js/reference-error-fix.js"></script>
    <!-- 地图加载辅助脚本 -->
    <script src="js/map-loader.js"></script>
    <meta name="theme-color" content="#ffffff">
    <!-- 紧急修复缓存函数未定义错误 -->
    <script src="emergency-fix.js"></script>
    <!-- 地图紧急修复脚本 - 解决Google Maps API加载问题 -->
    <script src="map-emergency-fix.js"></script>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="description" content="墨尔本交通信息共享平台">
    <meta name="apple-mobile-web-app-title" content="PtvAlert">
    
    <!-- 全局变量修复脚本 - 必须最先加载 -->
    <script src="./js/globals-fix.js"></script>
    <script src="./js/cache-functions.js"></script>
    <!-- 强制使用真实API -->
    <script src="force-real-api.js"></script>
    <script src="config.js"></script>
    <script src="vapid-keys.js"></script>
    <script src="push-client.js"></script>
    
    <!-- Firebase与Cloudflare同步脚本 -->
    <script src="./js/firebase-to-cloudflare-sync.js"></script>
    
    <!-- 修复版Service Worker注册脚本 -->
    <script>
        // 确保Service Worker正确注册
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async function() {
                try {
                    console.log('[Service Worker] 开始注册Service Worker...');
                    
                    // 先卸载所有现有的Service Worker
                    try {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for (let registration of registrations) {
                            console.log('[Service Worker] 卸载旧的Service Worker:', registration.scope);
                            await registration.unregister();
                        }
                        console.log('[Service Worker] 所有旧Service Worker已卸载');
                    } catch (unregError) {
                        console.warn('[Service Worker] 卸载旧Service Worker时出错:', unregError);
                    }
                    
                    // 为不同环境准备正确的Service Worker路径
                    let swPath = './service-worker.js';
                    
                    // 检测GitHub Pages环境并修正路径
                    if (window.location.hostname.includes('github.io')) {
                        const pathSegments = window.location.pathname.split('/');
                        if (pathSegments.length >= 2 && pathSegments[1]) {
                            const repoName = pathSegments[1];
                            swPath = '/' + repoName + '/service-worker.js';
                            console.log('[Service Worker] 检测到GitHub Pages环境，使用路径:', swPath);
                        }
                    }
                    
                    // 针对移动设备使用更简单的注册流程
                    if (window.isMobile) {
                        console.log('[Service Worker] 检测到移动设备，使用简化注册流程');
                        
                        try {
                            const registration = await navigator.serviceWorker.register(swPath);
                            console.log('[Service Worker] 移动设备注册成功:', registration.scope);
                        } catch (mobileError) {
                            console.error('[Service Worker] 移动设备注册失败:', mobileError);
                            console.log('[Service Worker] 尝试使用备用Service Worker');
                            
                            try {
                                const fallbackReg = await navigator.serviceWorker.register('./fallback-service-worker.js');
                                console.log('[Service Worker] 备用Service Worker注册成功:', fallbackReg.scope);
                            } catch (fallbackError) {
                                console.error('[Service Worker] 备用Service Worker也注册失败:', fallbackError);
                                
                                // 使用内联最小Service Worker作为最后的兜底方案
                                try {
                                    const minimalSW = new Blob([
                                        `self.addEventListener('install', () => self.skipWaiting());
                                        self.addEventListener('activate', e => e.waitUntil(clients.claim()));
                                        self.addEventListener('fetch', e => e.respondWith(fetch(e.request).catch(() => 
                                            new Response('离线模式，请稍后重试'))));`
                                    ], {type: 'application/javascript'});
                                    
                                    const minimalURL = URL.createObjectURL(minimalSW);
                                    const minimalReg = await navigator.serviceWorker.register(minimalURL);
                                    console.log('[Service Worker] 内联最小Service Worker注册成功');
                                } catch (inlineError) {
                                    console.error('[Service Worker] 所有注册方法都失败');
                                }
                            }
                        }
                        return;
                    }
                    
                    // 桌面设备使用标准注册流程
                    try {
                        const registration = await navigator.serviceWorker.register(swPath, {
                            scope: './'
                        });
                        console.log('[Service Worker] 注册成功:', registration.scope);
                    } catch (mainError) {
                        console.error('[Service Worker] 主Service Worker注册失败:', mainError);
                        
                        try {
                            console.log('[Service Worker] 尝试注册备用Service Worker');
                            const fallbackReg = await navigator.serviceWorker.register('./fallback-service-worker.js', {
                                scope: './'
                            });
                            console.log('[Service Worker] 备用Service Worker注册成功:', fallbackReg.scope);
                        } catch (fallbackError) {
                            console.error('[Service Worker] 备用Service Worker注册也失败:', fallbackError);
                            
                            if (window.location.hostname.includes('github.io')) {
                                console.log('[Service Worker] 尝试使用内联Service Worker');
                                
                                const minimalSWBlob = new Blob([`
                                    self.addEventListener('install', () => self.skipWaiting());
                                    self.addEventListener('activate', event => event.waitUntil(clients.claim()));
                                    self.addEventListener('fetch', event => event.respondWith(fetch(event.request)));
                                    console.log('内联最小Service Worker已激活');
                                `], {type: 'application/javascript'});
                                
                                const minimalSWUrl = URL.createObjectURL(minimalSWBlob);
                                
                                try {
                                    const inlineReg = await navigator.serviceWorker.register(minimalSWUrl, {
                                        scope: './'
                                    });
                                    console.log('[Service Worker] 内联Service Worker注册成功:', inlineReg.scope);
                                } catch (inlineError) {
                                    console.error('[Service Worker] 所有Service Worker注册方法都失败');
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('[Service Worker] 处理服务工作线程时出错:', error);
                }
            });
        }
    </script>
    
    <title>PtvAlert - 地图标记系统</title>
    
    <!-- Manifest和图标 -->
    <link rel="manifest" href="./manifest.json">
    <!-- 内联基本favicon避免404错误 -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    
    <script>
        // 处理GitHub Pages环境下图标路径问题
        if (window.location.hostname.includes('github.io')) {
            const pathSegments = window.location.pathname.split('/');
            if (pathSegments.length >= 2 && pathSegments[1]) {
                const repoName = pathSegments[1];
                const basePath = '/' + repoName;
                
                // 更新图标链接
                document.querySelectorAll('link[rel="icon"], link[rel="apple-touch-icon"], link[rel="manifest"]').forEach(link => {
                    const href = link.getAttribute('href');
                    if (href && href.startsWith('./')) {
                        link.setAttribute('href', basePath + href.substring(1));
                        console.log('[路径修复] 更新资源路径:', href, '->', basePath + href.substring(1));
                    }
                });
            }
        }
    </script>
    
    <!-- 样式表 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    
    <!-- 添加Firebase SDK 脚本 -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <!-- URL修复工具 - 处理推送通知URL问题 -->
    <script src="./js/url-fix.js?v=1.0.0"></script>
    
    <!-- 推送通知处理脚本 -->
    <script src="./js/notification-handler.js?v=2.0.1_20231121" id="notification-handler-script"></script>
    
    <!-- URL修复脚本 - 确保使用正确的域名 -->
    <script>
        (function() {
            // 等待notification-handler加载完成
            window.setTimeout(function() {
                try {
                    // 检查全局变量API_BASE_URL是否存在
                    if (typeof API_BASE_URL !== 'undefined') {
                        // 如果使用了错误的域名，则修复它
                        if (API_BASE_URL.includes('your-subdomain.workers.dev')) {
                            console.warn('发现错误的API_BASE_URL:', API_BASE_URL);
                            API_BASE_URL = 'https://ptvalert.pages.dev';
                            console.warn('已修复为:', API_BASE_URL);
                        }
                    }
                } catch (e) {
                    console.error('检查或修复API_BASE_URL失败:', e);
                }
            }, 100);
        })();
    </script>
    
    <!-- 先加载辅助脚本，确保它们在Google Maps API之前初始化 -->
    <!-- 地图加载修复脚本，必须最先加载 -->
    <script src="js/fix-google-maps-callback.js"></script>

    <!-- Google Maps API 脚本，添加超时参数 -->
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCE-oMIlcnOeqplgMmL9y1qcU6A9-HBu9U&callback=googleMapsLoadedCallback&libraries=places&v=weekly"></script>

    <!-- 在Google Maps API加载后加载这些脚本 -->
    <script src="js/ui-controller.js"></script>
    <script src="js/data-connector.js"></script>
    <script src="js/app-connector.js"></script>
    <script src="js/functionality-recovery.js"></script>
    <script src="js/marker-handler.js"></script>
    
    <!-- 添加Firebase初始化脚本 -->
    <script src="js/firebase-initializer.js"></script>
</head>
<body>
    <!-- 右上角语言切换按钮 -->
    <button id="langSwitchBtn" style="position:fixed;top:18px;right:18px;z-index:1001;background:rgba(255,255,255,0.8);color:#333;border-radius:20px;padding:6px 12px;font-size:14px;font-weight:bold;box-shadow:0 2px 12px rgba(0,0,0,0.18);border:2px solid #0071e3;cursor:pointer;display:flex;align-items:center;gap:6px;transition:background 0.2s,border 0.2s;">
      <span style="font-size:16px;">🌐</span>
      <span id="langSwitchText">EN</span>
    </button>
    
    <!-- 用户菜单 - 完全隐藏，不显示任何内容 -->
    <!-- 移除所有用户菜单相关代码 -->
    
    <!-- 添加弹幕容器 -->
    <div class="danmaku-container" id="danmakuContainer"></div>
    
    <!-- 地图容器 -->
    <div id="map"></div>
    
    <!-- 地图控制 -->
    <div class="map-control">
        <div style="display:flex;gap:10px;margin-bottom:10px;">
            <button class="add-report-btn" id="addReportBtn" style="flex:1;background-color:white;color:#333;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;border:none;box-shadow:0 2px 10px rgba(0,0,0,0.3);cursor:pointer;">+ 添加报告</button>
            <button class="add-report-btn" id="quickAddBtn" style="flex:1;background-color:#34c759;color:white;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;border:none;box-shadow:0 2px 10px rgba(0,0,0,0.3);cursor:pointer;">+ 直接添加描述</button>
        </div>
        <div id="addReportTip" style="display:none;text-align:center;background-color:rgba(0,0,0,0.7);color:white;padding:10px;border-radius:8px;margin-top:10px;font-weight:bold;">请在地图上点选位置</div>
    </div>
    
    <!-- 推送通知按钮 -->
    <div style="position:fixed;bottom:100px;right:20px;z-index:2000;">
        <button id="requestPushPermission" style="background-color:#0071e3;color:white;border:none;padding:10px 15px;border-radius:8px;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.3);display:flex;align-items:center;gap:6px;">
            <span style="font-size:20px;">🔔</span>
            <span id="pushBtnText">启用推送通知</span>
        </button>
    </div>
    
    <!-- 报告计数器弹窗 - 默认隐藏，使用中央弹窗而非右侧蓝色弹窗 -->
    <div class="popup-base" id="reportCounterPopup" style="display:none;">
        <h3 id="reportSuccessTitle" style="margin:0 0 15px 0;font-size:20px;font-weight:bold;">报告提交成功!</h3>
        <div style="margin:15px 0;">
            <div style="font-size:18px;margin-bottom:10px;">
                <span id="reportCountText">今日已收到</span> 
                <span id="reportCount" style="font-weight:bold;font-size:24px;color:#4CAF50;">0</span> 
                <span id="reportCountSuffix">条报告</span>
            </div>
            <div style="font-size:14px;color:#aaa;" id="reportCounterThankYou">
                感谢您的贡献!
            </div>
        </div>
        <button onclick="document.getElementById('reportCounterPopup').style.display='none';document.body.style.pointerEvents='auto';" class="popup-btn" style="background:#0071e3;color:white;border:none;padding:12px 20px;border-radius:8px;font-weight:bold;margin-top:15px;width:100%;">
            <span id="reportCounterCloseBtn">关闭</span>
        </button>
    </div>
    
    <!-- 报告表单 -->
    <div class="report-form" id="reportForm" style="position:fixed; bottom:0; left:0; right:0; background-color:#1c1c1e; padding:20px; border-radius:20px 20px 0 0; box-shadow:0 -2px 10px rgba(0,0,0,0.5); z-index:2000; transform:translateY(100%); transition:transform 0.3s ease-in-out;">
        <div class="form-header">
            <h2 class="form-title" id="formTitle">新报告</h2>
            <button class="form-close" id="formClose" style="background:none;border:none;color:#fff;font-size:24px;cursor:pointer;">&times;</button>
        </div>
        
        <div class="form-group">
            <label class="form-label" id="photoLabel">照片</label>
            <div class="image-preview" style="width:100%;height:200px;border-radius:8px;background-color:#2c2c2e;display:flex;align-items:center;justify-content:center;margin-bottom:15px;overflow:hidden;position:relative;cursor:pointer;">
                <img src="" class="preview-img" id="previewImg" style="max-width:100%;max-height:100%;display:none;">
                <span class="image-placeholder" id="imagePlaceholder">点击添加照片</span>
                <input type="file" id="imageInput" accept="image/*" style="position:absolute;left:0;top:0;width:100%;height:100%;opacity:0;cursor:pointer;z-index:2;">
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label" id="descLabel">描述</label>
            <textarea class="form-textarea" id="descriptionInput" placeholder="请描述您看到的情况..." style="width:100%;padding:12px;border-radius:8px;border:1px solid #444;background-color:#2c2c2e;color:#fff;font-size:16px;min-height:100px;resize:vertical;"></textarea>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
                <button id="geocodeLocationBtn" style="padding:6px 12px;background-color:#0077cc;color:white;border:none;border-radius:6px;font-size:14px;cursor:pointer;">根据描述定位</button>
                <button id="currentLocationBtn" style="padding:6px 12px;margin-left:8px;background-color:#34c759;color:white;border:none;border-radius:6px;font-size:14px;cursor:pointer;">使用当前位置</button>
                <span style="font-size:12px;color:#999;margin-left:8px;flex:1;text-align:right;">提示: 输入地点描述后点击，或使用Ctrl+Enter快捷键</span>
            </div>
            <div id="geocodeStatus" style="margin-top:5px;font-size:14px;color:#ffcc00;display:none;"></div>
        </div>
        
        <div style="display:flex;gap:10px;margin-top:15px;">
            <button class="submit-btn" id="submitReport" onclick="handleEmergencySubmit(event)" style="flex:1;background-color:#0071e3;color:white;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;position:relative;z-index:10000;">确定</button>
            <button class="reset-location-btn" id="resetLocationBtn" style="flex:1;background-color:#ffc107;color:#000;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;">重新选点</button>
            <button class="cancel-btn" id="cancelReport" style="flex:1;background-color:#3a3a3c;color:white;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;">取消</button>
        </div>
    </div>

    <!-- 快速描述弹窗 -->
    <div class="popup-base" id="quickAddForm" style="display:none; top:50%; left:50%; transform:translate(-50%, -50%); width:90%; max-width:400px; padding:20px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h2 id="quickFormTitle" style="font-size:20px;color:#fff;margin:0;">快速添加描述</h2>
            <button id="quickAddClose" class="popup-btn" style="background:none;border:none;color:#fff;font-size:24px;margin:0;padding:0;">&times;</button>
        </div>
        
        <div>
            <label id="quickDescLabel" style="display:block;margin-bottom:8px;color:#fff;">描述</label>
            <textarea id="quickDescInput" placeholder="请简单描述您看到的情况..." style="width:100%;padding:12px;border-radius:8px;border:1px solid #444;background-color:#2c2c2e;color:#fff;font-size:16px;min-height:100px;resize:vertical;"></textarea>
            <p style="font-size:12px;color:#999;margin-top:5px;">提示: 将使用地图中心作为位置</p>
        </div>
        
        <div style="display:flex;gap:10px;margin-top:15px;">
            <button id="submitQuickAdd" class="popup-btn" style="flex:1;background-color:#0071e3;color:white;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;">确定</button>
            <button id="cancelQuickAdd" class="popup-btn" style="flex:1;background-color:#3a3a3c;color:white;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;">取消</button>
        </div>
    </div>

    <!-- 添加紧急提交处理脚本 -->
    <script>
    function handleEmergencySubmit(event) {
        event.preventDefault();
        console.log('紧急提交按钮被点击');
        
        try {
            const description = document.getElementById('descriptionInput').value;
            
            if (!description) {
                alert('请输入描述');
                return;
            }
            
            if (!window.selectedLocation) {
                alert('请选择位置');
                return;
            }
            
            // 关闭表单
            const reportForm = document.getElementById('reportForm');
            if (reportForm) {
                reportForm.style.transform = 'translateY(100%)';
                setTimeout(function() {
                    reportForm.style.display = 'none';
                }, 300);
            }
            
            // 获取图片数据
            const previewImg = document.getElementById('previewImg');
            const imageData = previewImg && previewImg.style.display !== 'none' ? previewImg.src : null;
            
            // 创建报告数据
            const reportData = {
                description: description,
                location: window.selectedLocation,
                image: imageData,
                timestamp: new Date().toISOString(),
                user: 'anonymous-user'
            };
            
            // 直接添加标记到地图
            if (window.map && typeof google === 'object' && google.maps) {
                // 确保markers数组已初始化
                if (!window.markers) {
                    window.markers = [];
                }
                
                // 创建标记
                const marker = new google.maps.Marker({
                    position: window.selectedLocation,
                    map: window.map,
                    animation: google.maps.Animation.DROP,
                    title: description,
                    label: {
                        text: '🐶',
                        fontSize: '24px'
                    },
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 0
                    },
                    optimized: false
                });
                
                // 保存标记
                window.markers.push(marker);
                
                // 为标记添加点击事件
                marker.addListener('click', function() {
                    // 关闭任何已打开的信息窗口
                    if (window.openedInfoWindow) {
                        window.openedInfoWindow.close();
                    }
                    
                    // 创建信息窗口内容，包括描述和可能的图片
                    let content = '<div style="padding:10px;max-width:300px;">';
                    
                    // 如果有图片，添加图片
                    if (imageData) {
                        content += `<div style="margin-bottom:10px;"><img src="${imageData}" style="max-width:100%;max-height:150px;border-radius:4px;"></div>`;
                    }
                    
                    // 添加描述
                    content += `<div style="font-size:14px;margin-bottom:10px;">${description}</div>`;
                    
                    // 添加时间戳
                    const now = new Date();
                    content += `<div style="font-size:12px;color:#666;">${now.toLocaleDateString()} ${now.toLocaleTimeString()}</div>`;
                    
                    content += '</div>';
                    
                    // 创建并打开信息窗口
                    const infoWindow = new google.maps.InfoWindow({
                        content: content,
                        maxWidth: 300
                    });
                    
                    infoWindow.open(window.map, marker);
                    
                    // 保存当前打开的信息窗口
                    window.openedInfoWindow = infoWindow;
                });
                
                // 尝试保存标记到localStorage
                try {
                    const markerData = window.markers.map(function(m) {
                        return {
                            lat: m.getPosition().lat(),
                            lng: m.getPosition().lng(),
                            description: m.getTitle() || '',
                            image: m === marker ? imageData : null
                        };
                    });
                    
                    localStorage.setItem('savedMarkers', JSON.stringify(markerData));
                    console.log('标记已保存到localStorage');
                } catch (error) {
                    console.error('保存标记到localStorage失败:', error);
                }
            } else {
                console.error('地图未初始化，无法添加标记');
            }
            
            // 显示成功弹窗
            const reportCounterPopup = document.getElementById('reportCounterPopup');
            if (reportCounterPopup) {
                reportCounterPopup.style.zIndex = '15000';
                reportCounterPopup.style.display = 'block';
                
                // 3秒后自动关闭
                setTimeout(function() {
                    reportCounterPopup.style.display = 'none';
                }, 3000);
            }
            
            console.log('紧急提交成功');
        } catch (error) {
            console.error('紧急提交失败:', error);
            alert('提交失败，请重试');
        }
    }
    </script>

    <!-- 添加标记自动清理脚本 -->
    <script src="js/marker-cleanup-service.js"></script>
    
    <!-- 添加标记清理修复脚本 -->
    <script src="js/marker-cleanup-fix.js"></script>
</body>

<!-- 辅助脚本 -->
    <script>
  // 处理地图初始化错误的函数
  function handleMapInitError() {
    // 如果已经有离线模式处理，不再显示额外的错误
    if (window.mapsInitialized || document.getElementById('offlineMapNotice')) {
      return;
    }
    
    // 创建一个简单的地图替代元素
    const mapElement = document.getElementById('map');
    if (mapElement) {
      mapElement.style.backgroundImage = 'linear-gradient(to bottom, #cfd9df 0%, #e2ebf0 100%)';
      mapElement.style.backgroundSize = 'cover';
    }
    
    // 创建一个模拟的地图对象
    window.map = window.map || {
      getCenter: function() {
        return {
          lat: function() { return MELBOURNE_CENTER.lat; },
          lng: function() { return MELBOURNE_CENTER.lng; }
        };
      },
      setCenter: function() { return this; },
      addListener: function() { return { remove: function() {} }; }
    };
    
    // 提示用户
    const notice = document.createElement('div');
    notice.id = 'offlineMapNotice';
    notice.style.cssText = 'position:fixed;top:50px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);color:white;padding:10px 20px;border-radius:20px;z-index:1000;font-size:14px;text-align:center;';
    notice.textContent = '地图加载受限，但您仍可添加报告';
    document.body.appendChild(notice);
    
    // 5秒后移除通知
    setTimeout(function() {
      if (notice.parentNode) {
        notice.style.opacity = '0';
        notice.style.transition = 'opacity 0.5s';
        setTimeout(function() {
          if (notice.parentNode) {
            notice.parentNode.removeChild(notice);
          }
        }, 500);
      }
    }, 5000);
    
    // 标记地图已初始化（避免重复显示错误）
    window.mapsInitialized = true;
  }
    </script>

</html>


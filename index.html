<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- ç´§æ€¥ç¼“å­˜æ¸…ç†å’Œè„šæœ¬æ‹¦æˆª -->
    <script>
        // ç¦æ­¢åŠ è½½ä»»ä½•edwardidaniels449.github.ioçš„èµ„æº
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            if (typeof url === 'string' && url.includes('edwardidaniels449.github.io')) {
                console.warn('âš ï¸ å·²æ‹¦æˆªå¤–éƒ¨èµ„æºè¯·æ±‚:', url);
                return Promise.reject(new Error('Resource blocked'));
            }
            return originalFetch.apply(this, arguments);
        };
        
        // æ‹¦æˆªXMLHttpRequest
        const originalOpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(method, url, ...rest) {
            if (typeof url === 'string' && url.includes('edwardidaniels449.github.io')) {
                console.warn('âš ï¸ å·²æ‹¦æˆªXHRè¯·æ±‚:', url);
                throw new Error('XHR request blocked');
            }
            return originalOpen.call(this, method, url, ...rest);
        };
        
        // é˜»æ­¢å¤–éƒ¨è„šæœ¬åŠ è½½
        const originalCreateElement = document.createElement;
        document.createElement = function(tagName) {
            const element = originalCreateElement.call(document, tagName);
            if (tagName.toLowerCase() === 'script') {
                const originalSetAttribute = element.setAttribute;
                element.setAttribute = function(name, value) {
                    if (name === 'src' && value && value.includes('edwardidaniels449.github.io')) {
                        console.warn('âš ï¸ å·²æ‹¦æˆªè„šæœ¬åŠ è½½:', value);
                        return;
                    }
                    return originalSetAttribute.call(this, name, value);
                };
            }
            return element;
        };
        
        // å¼ºåˆ¶æ¸…é™¤æ‰€æœ‰ç¼“å­˜
        if ('caches' in window) {
            console.log('ğŸ“£ æ¸…é™¤æ‰€æœ‰ç¼“å­˜...');
            caches.keys().then(cacheNames => {
                cacheNames.forEach(cacheName => {
                    console.log('ğŸ—‘ï¸ åˆ é™¤ç¼“å­˜:', cacheName);
                    caches.delete(cacheName);
                });
            });
        }
        
        // å¦‚æœæœ‰Service Workerï¼Œå°è¯•å¸è½½å®ƒ
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                for (let registration of registrations) {
                    console.log('ğŸ—‘ï¸ å¸è½½Service Worker:', registration.scope);
                    registration.unregister();
                }
            });
        }
        
        // æ£€æµ‹å¹¶æŠ¥å‘Šå·²åŠ è½½çš„é—®é¢˜è„šæœ¬
        window.addEventListener('DOMContentLoaded', function() {
            const problemScripts = [
                'mobile-error-final-fix.js',
                'undefined-error-fix.js',
                'error-fix-patch.js',
                'offline-handler.js',
                'mobile-fix.js',
                'functionality-recovery.js'
            ];
            
            let found = false;
            document.querySelectorAll('script').forEach(script => {
                if (script.src) {
                    problemScripts.forEach(badScript => {
                        if (script.src.includes(badScript)) {
                            console.error('âš ï¸ æ£€æµ‹åˆ°é—®é¢˜è„šæœ¬ä»åœ¨åŠ è½½:', script.src);
                            found = true;
                        }
                    });
                }
            });
            
            if (!found) {
                console.log('âœ… æ²¡æœ‰æ£€æµ‹åˆ°é—®é¢˜è„šæœ¬');
            }
        });
    </script>
    
    <!-- æå‰åŠ è½½å…³é”®èµ„æº -->
    <link rel="dns-prefetch" href="https://maps.googleapis.com">
    <link rel="preconnect" href="https://maps.googleapis.com">
    <link rel="preload" href="images/icon-192x192.png" as="image">
    
    <!-- PWAé…ç½® -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PtvAlert">
    <link rel="apple-touch-icon" href="images/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="images/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="images/icon-180x180.png">
    <link rel="apple-touch-icon" sizes="167x167" href="images/icon-167x167.png">
    
    <!-- å…¨å±€å˜é‡åˆå§‹åŒ– - å¿…é¡»æœ€å…ˆåŠ è½½ -->
    <script>
      // å¢¨å°”æœ¬ä¸­å¿ƒåæ ‡ - å…¨å±€å˜é‡
      window.MELBOURNE_CENTER = {lat: -37.8136, lng: 144.9631};
      
      // åˆå§‹åŒ–å…¨å±€å˜é‡
      window.currentLang = localStorage.getItem('preferredLanguage') || 'zh'; // Default language
      // Define isMobile globally here if it originates from index.html
      window.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      console.log('[index.html] Global isMobile:', window.isMobile);
    </script>
    
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="description" content="å¢¨å°”æœ¬äº¤é€šä¿¡æ¯å…±äº«å¹³å°">
    <meta name="apple-mobile-web-app-title" content="PtvAlert">
    
    <script src="./js/cache-functions.js"></script>
    <script src="config.js"></script>
    <script src="vapid-keys.js"></script>
    <script src="push-client.js"></script>
    
    <!-- ä¿®å¤ç‰ˆService Workeræ³¨å†Œè„šæœ¬ -->
    <script>
        // ç¡®ä¿Service Workeræ­£ç¡®æ³¨å†Œ - å¯¹ç§»åŠ¨è®¾å¤‡å‹å¥½çš„ç‰ˆæœ¬
        if ('serviceWorker' in navigator) {
            // å»¶è¿Ÿæ³¨å†ŒService Workerï¼Œç¡®ä¿é¡µé¢æ ¸å¿ƒå†…å®¹å·²åŠ è½½
            window.addEventListener('load', function() {
                try {
                    console.log('[Service Worker] å¼€å§‹æ³¨å†ŒService Worker...');
                    
                    // è®¡ç®—æ­£ç¡®çš„Service Workerè·¯å¾„
                    var swPath = './service-worker.js';
                    
                    // å¤„ç†GitHub Pagesçš„æƒ…å†µ
                    if (window.location.hostname.includes('github.io')) {
                        var pathSegments = window.location.pathname.split('/');
                        if (pathSegments.length >= 2 && pathSegments[1]) {
                            swPath = '/' + pathSegments[1] + '/service-worker.js';
                            console.log('[Service Worker] GitHub Pagesç¯å¢ƒï¼Œä½¿ç”¨è·¯å¾„:', swPath);
                        }
                    }
                    
                    // å¯¹äºç§»åŠ¨è®¾å¤‡ï¼Œä½¿ç”¨æ›´ç®€å•çš„æ³¨å†Œæµç¨‹
                    if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                        console.log('[Service Worker] ä½¿ç”¨ç§»åŠ¨è®¾å¤‡å‹å¥½çš„æ³¨å†Œæµç¨‹');
                        
                        navigator.serviceWorker.register(swPath)
                            .then(function(registration) {
                                console.log('[Service Worker] ç§»åŠ¨è®¾å¤‡æ³¨å†ŒæˆåŠŸ:', registration.scope);
                            })
                            .catch(function(error) {
                                console.error('[Service Worker] ç§»åŠ¨è®¾å¤‡æ³¨å†Œå¤±è´¥:', error);
                                // ä¸è¦å°è¯•å¤‡é€‰æ–¹æ¡ˆï¼Œç›´æ¥å…è®¸ç½‘ç«™æ­£å¸¸åŠ è½½
                            });
                    } else {
                        // æ¡Œé¢è®¾å¤‡ä½¿ç”¨å¸¸è§„æ³¨å†Œæµç¨‹
                        navigator.serviceWorker.register(swPath)
                            .then(function(registration) {
                                console.log('[Service Worker] æ³¨å†ŒæˆåŠŸ:', registration.scope);
                            })
                            .catch(function(error) {
                                console.error('[Service Worker] æ³¨å†Œå¤±è´¥:', error);
                                // å…è®¸ç½‘ç«™ç»§ç»­åŠ è½½
                            });
                    }
                } catch (error) {
                    console.error('[Service Worker] æ³¨å†Œè¿‡ç¨‹å‡ºé”™:', error);
                    // é”™è¯¯ä¸ä¼šé˜»æ­¢ç½‘ç«™åŠ è½½
                }
            });
        }
    </script>
    
    <title>PtvAlert - åœ°å›¾æ ‡è®°ç³»ç»Ÿ</title>
    
    <!-- Manifestå’Œå›¾æ ‡ -->
    <link rel="manifest" href="./manifest.json">
    <!-- å†…è”åŸºæœ¬faviconé¿å…404é”™è¯¯ -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    
    <script>
        // å¤„ç†GitHub Pagesç¯å¢ƒä¸‹å›¾æ ‡è·¯å¾„é—®é¢˜
        if (window.location.hostname.includes('github.io')) {
            const pathSegments = window.location.pathname.split('/');
            if (pathSegments.length >= 2 && pathSegments[1]) {
                const repoName = pathSegments[1];
                const basePath = '/' + repoName;
                
                // æ›´æ–°å›¾æ ‡é“¾æ¥
                document.querySelectorAll('link[rel="icon"], link[rel="apple-touch-icon"], link[rel="manifest"]').forEach(link => {
                    const href = link.getAttribute('href');
                    if (href && href.startsWith('./')) {
                        link.setAttribute('href', basePath + href.substring(1));
                        console.log('[è·¯å¾„ä¿®å¤] æ›´æ–°èµ„æºè·¯å¾„:', href, '->', basePath + href.substring(1));
                    }
                });
            }
        }
    </script>
    
    <!-- æ ·å¼è¡¨ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    
    <!-- æ·»åŠ Firebase SDK è„šæœ¬ -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <!-- URLä¿®å¤å·¥å…· - å¤„ç†æ¨é€é€šçŸ¥URLé—®é¢˜ -->
    <script src="./js/url-fix.js?v=1.0.0"></script>
    
    <!-- æ¨é€é€šçŸ¥å¤„ç†è„šæœ¬ -->
    <script src="./js/notification-handler.js?v=2.0.1_20231121" id="notification-handler-script"></script>
    
    <!-- URLä¿®å¤è„šæœ¬ - ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„åŸŸå -->
    <script>
        (function() {
            // ç­‰å¾…notification-handleråŠ è½½å®Œæˆ
            window.setTimeout(function() {
                try {
                    // æ£€æŸ¥å…¨å±€å˜é‡API_BASE_URLæ˜¯å¦å­˜åœ¨
                    if (typeof API_BASE_URL !== 'undefined') {
                        // å¦‚æœä½¿ç”¨äº†é”™è¯¯çš„åŸŸåï¼Œåˆ™ä¿®å¤å®ƒ
                        if (API_BASE_URL.includes('your-subdomain.workers.dev')) {
                            console.warn('å‘ç°é”™è¯¯çš„API_BASE_URL:', API_BASE_URL);
                            API_BASE_URL = 'https://ptvalert.pages.dev';
                            console.warn('å·²ä¿®å¤ä¸º:', API_BASE_URL);
                        }
                    }
                } catch (e) {
                    console.error('æ£€æŸ¥æˆ–ä¿®å¤API_BASE_URLå¤±è´¥:', e);
                }
            }, 100);
        })();
    </script>

    <!-- Google Maps API è„šæœ¬ -->
    <script>
        // åˆå§‹åŒ–åœ°å›¾å‡½æ•°
        function initMap() {
            console.log("åˆå§‹åŒ–åœ°å›¾...");
            
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                console.error("Google Maps APIå°šæœªåŠ è½½");
                return;
            }
            
            // åˆ›å»ºåœ°å›¾
            window.map = new google.maps.Map(document.getElementById('map'), {
                center: window.MELBOURNE_CENTER,
                zoom: 13,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                fullscreenControl: false,
                streetViewControl: false,
                zoomControl: true,
                mapTypeControl: false
            });
            
            console.log("åœ°å›¾å·²åˆå§‹åŒ–");
            
            // åœ°å›¾åˆå§‹åŒ–åçš„äº‹ä»¶å¤„ç†
            if (window.map) {
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                window.map.addListener = window.map.addListener || function(event, callback) {
                    console.log("æ·»åŠ åœ°å›¾äº‹ä»¶ç›‘å¬å™¨:", event);
                    // ä½¿ç”¨åŸç”Ÿgoogle.maps.event.addListener
                    if (google && google.maps && google.maps.event && google.maps.event.addListener) {
                        return google.maps.event.addListener(window.map, event, callback);
                    } else {
                        console.warn("æ— æ³•æ·»åŠ åœ°å›¾äº‹ä»¶ç›‘å¬å™¨");
                        return {
                            remove: function() {}
                        };
                    }
                };
            }
        }
        
        // Google Maps API åŠ è½½å›è°ƒ
        function googleMapsLoadedCallback() {
            console.log("Google Maps APIå·²åŠ è½½");
            
            // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMå·²ç»å®Œå…¨åŠ è½½
            setTimeout(function() {
                try {
                    initMap();
                } catch (e) {
                    console.error("åˆå§‹åŒ–åœ°å›¾æ—¶å‡ºé”™:", e);
                }
            }, 100);
        }
        
        // å¤‡ç”¨è®¡æ—¶å™¨ï¼Œä»¥é˜²å›è°ƒæœªè§¦å‘
        setTimeout(function() {
            if (!window.map) {
                console.warn("Google Mapså›è°ƒæœªè§¦å‘ï¼Œå°è¯•æ‰‹åŠ¨åˆå§‹åŒ–");
                if (typeof initMap === 'function' && typeof google !== 'undefined') {
                    initMap();
                }
            }
        }, 5000);
    </script>
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCE-oMIlcnOeqplgMmL9y1qcU6A9-HBu9U&callback=googleMapsLoadedCallback&libraries=places&v=weekly"></script>

    <!-- åœ¨Google Maps APIåŠ è½½ååŠ è½½è¿™äº›è„šæœ¬ -->
    <script src="js/ui-controller.js"></script>
    <script src="js/data-connector.js"></script>
    <script src="js/app-connector.js"></script>
    <script src="js/marker-handler.js"></script>
    
    <!-- æ·»åŠ Firebaseåˆå§‹åŒ–è„šæœ¬ -->
    <script src="js/firebase-initializer.js"></script>
    
    <!-- åŸºæœ¬æ ·å¼ -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        .map-control {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .popup-base {
            position: fixed;
            background-color: #1c1c1e;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 2000;
            color: white;
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- å³ä¸Šè§’è¯­è¨€åˆ‡æ¢æŒ‰é’® -->
    <button id="langSwitchBtn" style="position:fixed;top:18px;right:18px;z-index:1001;background:rgba(255,255,255,0.8);color:#333;border-radius:20px;padding:6px 12px;font-size:14px;font-weight:bold;box-shadow:0 2px 12px rgba(0,0,0,0.18);border:2px solid #0071e3;cursor:pointer;display:flex;align-items:center;gap:6px;transition:background 0.2s,border 0.2s;">
      <span style="font-size:16px;">ğŸŒ</span>
      <span id="langSwitchText">EN</span>
    </button>
    
    <!-- æ·»åŠ å¼¹å¹•å®¹å™¨ -->
    <div class="danmaku-container" id="danmakuContainer"></div>
    
    <!-- åœ°å›¾å®¹å™¨ -->
    <div id="map"></div>
    
    <!-- åœ°å›¾æ§åˆ¶ -->
    <div class="map-control">
        <div style="display:flex;gap:10px;margin-bottom:10px;">
            <button class="add-report-btn" id="addReportBtn" style="flex:1;background-color:white;color:#333;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;border:none;box-shadow:0 2px 10px rgba(0,0,0,0.3);cursor:pointer;">+ æ·»åŠ æŠ¥å‘Š</button>
            <button class="add-report-btn" id="quickAddBtn" style="flex:1;background-color:#34c759;color:white;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;border:none;box-shadow:0 2px 10px rgba(0,0,0,0.3);cursor:pointer;">+ ç›´æ¥æ·»åŠ æè¿°</button>
        </div>
        <div id="addReportTip" style="display:none;text-align:center;background-color:rgba(0,0,0,0.7);color:white;padding:10px;border-radius:8px;margin-top:10px;font-weight:bold;">è¯·åœ¨åœ°å›¾ä¸Šç‚¹é€‰ä½ç½®</div>
    </div>
    
    <!-- æ¨é€é€šçŸ¥æŒ‰é’® -->
    <div style="position:fixed;bottom:100px;right:20px;z-index:2000;">
        <button id="requestPushPermission" style="background-color:#0071e3;color:white;border:none;padding:10px 15px;border-radius:8px;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.3);display:flex;align-items:center;gap:6px;">
            <span style="font-size:20px;">ğŸ””</span>
            <span id="pushBtnText">å¯ç”¨æ¨é€é€šçŸ¥</span>
        </button>
    </div>
    
    <!-- æŠ¥å‘Šè®¡æ•°å™¨å¼¹çª— - é»˜è®¤éšè—ï¼Œä½¿ç”¨ä¸­å¤®å¼¹çª—è€Œéå³ä¾§è“è‰²å¼¹çª— -->
    <div class="popup-base" id="reportCounterPopup" style="display:none;">
        <h3 id="reportSuccessTitle" style="margin:0 0 15px 0;font-size:20px;font-weight:bold;">æŠ¥å‘Šæäº¤æˆåŠŸ!</h3>
        <div style="margin:15px 0;">
            <div style="font-size:18px;margin-bottom:10px;">
                <span id="reportCountText">ä»Šæ—¥å·²æ”¶åˆ°</span> 
                <span id="reportCount" style="font-weight:bold;font-size:24px;color:#4CAF50;">0</span> 
                <span id="reportCountSuffix">æ¡æŠ¥å‘Š</span>
            </div>
            <div style="font-size:14px;color:#aaa;" id="reportCounterThankYou">
                æ„Ÿè°¢æ‚¨çš„è´¡çŒ®!
            </div>
        </div>
        <button onclick="document.getElementById('reportCounterPopup').style.display='none';document.body.style.pointerEvents='auto';" class="popup-btn" style="background:#0071e3;color:white;border:none;padding:12px 20px;border-radius:8px;font-weight:bold;margin-top:15px;width:100%;">
            <span id="reportCounterCloseBtn">å…³é—­</span>
        </button>
    </div>
    
    <!-- æŠ¥å‘Šè¡¨å• -->
    <div class="report-form" id="reportForm" style="position:fixed; bottom:0; left:0; right:0; background-color:#1c1c1e; padding:20px; border-radius:20px 20px 0 0; box-shadow:0 -2px 10px rgba(0,0,0,0.5); z-index:2000; transform:translateY(100%); transition:transform 0.3s ease-in-out;">
        <div class="form-header">
            <h2 class="form-title" id="formTitle">æ–°æŠ¥å‘Š</h2>
            <button class="form-close" id="formClose" style="background:none;border:none;color:#fff;font-size:24px;cursor:pointer;">&times;</button>
        </div>
        
        <div class="form-group">
            <label class="form-label" id="photoLabel">ç…§ç‰‡</label>
            <div class="image-preview" style="width:100%;height:200px;border-radius:8px;background-color:#2c2c2e;display:flex;align-items:center;justify-content:center;margin-bottom:15px;overflow:hidden;position:relative;cursor:pointer;">
                <img src="" class="preview-img" id="previewImg" style="max-width:100%;max-height:100%;display:none;">
                <span class="image-placeholder" id="imagePlaceholder">ç‚¹å‡»æ·»åŠ ç…§ç‰‡</span>
                <input type="file" id="imageInput" accept="image/*" style="position:absolute;left:0;top:0;width:100%;height:100%;opacity:0;cursor:pointer;z-index:2;">
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label" id="descLabel">æè¿°</label>
            <textarea class="form-textarea" id="descriptionInput" placeholder="è¯·æè¿°æ‚¨çœ‹åˆ°çš„æƒ…å†µ..." style="width:100%;padding:12px;border-radius:8px;border:1px solid #444;background-color:#2c2c2e;color:#fff;font-size:16px;min-height:100px;resize:vertical;"></textarea>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
                <button id="geocodeLocationBtn" style="padding:6px 12px;background-color:#0077cc;color:white;border:none;border-radius:6px;font-size:14px;cursor:pointer;">æ ¹æ®æè¿°å®šä½</button>
                <button id="currentLocationBtn" style="padding:6px 12px;margin-left:8px;background-color:#34c759;color:white;border:none;border-radius:6px;font-size:14px;cursor:pointer;">ä½¿ç”¨å½“å‰ä½ç½®</button>
                <span style="font-size:12px;color:#999;margin-left:8px;flex:1;text-align:right;">æç¤º: è¾“å…¥åœ°ç‚¹æè¿°åç‚¹å‡»ï¼Œæˆ–ä½¿ç”¨Ctrl+Enterå¿«æ·é”®</span>
            </div>
            <div id="geocodeStatus" style="margin-top:5px;font-size:14px;color:#ffcc00;display:none;"></div>
        </div>
        
        <div style="display:flex;gap:10px;margin-top:15px;">
            <button class="submit-btn" id="submitReport" onclick="handleEmergencySubmit(event)" style="flex:1;background-color:#0071e3;color:white;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;position:relative;z-index:10000;">ç¡®å®š</button>
            <button class="reset-location-btn" id="resetLocationBtn" style="flex:1;background-color:#ffc107;color:#000;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;">é‡æ–°é€‰ç‚¹</button>
            <button class="cancel-btn" id="cancelReport" style="flex:1;background-color:#3a3a3c;color:white;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- å¿«é€Ÿæè¿°å¼¹çª— -->
    <div class="popup-base" id="quickAddForm" style="display:none; top:50%; left:50%; transform:translate(-50%, -50%); width:90%; max-width:400px; padding:20px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h2 id="quickFormTitle" style="font-size:20px;color:#fff;margin:0;">å¿«é€Ÿæ·»åŠ æè¿°</h2>
            <button id="quickAddClose" class="popup-btn" style="background:none;border:none;color:#fff;font-size:24px;margin:0;padding:0;">&times;</button>
        </div>
        
        <div>
            <label id="quickDescLabel" style="display:block;margin-bottom:8px;color:#fff;">æè¿°</label>
            <textarea id="quickDescInput" placeholder="è¯·ç®€å•æè¿°æ‚¨çœ‹åˆ°çš„æƒ…å†µ..." style="width:100%;padding:12px;border-radius:8px;border:1px solid #444;background-color:#2c2c2e;color:#fff;font-size:16px;min-height:100px;resize:vertical;"></textarea>
            <p style="font-size:12px;color:#999;margin-top:5px;">æç¤º: å°†ä½¿ç”¨åœ°å›¾ä¸­å¿ƒä½œä¸ºä½ç½®</p>
        </div>
        
        <div style="display:flex;gap:10px;margin-top:15px;">
            <button id="submitQuickAdd" class="popup-btn" style="flex:1;background-color:#0071e3;color:white;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;">ç¡®å®š</button>
            <button id="cancelQuickAdd" class="popup-btn" style="flex:1;background-color:#3a3a3c;color:white;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- æ·»åŠ ç´§æ€¥æäº¤å¤„ç†è„šæœ¬ -->
    <script>
    function handleEmergencySubmit(event) {
        event.preventDefault();
        console.log('ç´§æ€¥æäº¤æŒ‰é’®è¢«ç‚¹å‡»');
        
        try {
            const description = document.getElementById('descriptionInput').value;
            
            if (!description) {
                alert('è¯·è¾“å…¥æè¿°');
                return;
            }
            
            if (!window.selectedLocation) {
                alert('è¯·é€‰æ‹©ä½ç½®');
                return;
            }
            
            // å…³é—­è¡¨å•
            const reportForm = document.getElementById('reportForm');
            if (reportForm) {
                reportForm.style.transform = 'translateY(100%)';
                setTimeout(function() {
                    reportForm.style.display = 'none';
                }, 300);
            }
            
            // è·å–å›¾ç‰‡æ•°æ®
            const previewImg = document.getElementById('previewImg');
            const imageData = previewImg && previewImg.style.display !== 'none' ? previewImg.src : null;
            
            // åˆ›å»ºæŠ¥å‘Šæ•°æ®
            const reportData = {
                description: description,
                location: window.selectedLocation,
                image: imageData,
                timestamp: new Date().toISOString(),
                user: 'anonymous-user'
            };
            
            // ç›´æ¥æ·»åŠ æ ‡è®°åˆ°åœ°å›¾
            if (window.map && typeof google === 'object' && google.maps) {
                // ç¡®ä¿markersæ•°ç»„å·²åˆå§‹åŒ–
                if (!window.markers) {
                    window.markers = [];
                }
                
                // åˆ›å»ºæ ‡è®°
                const marker = new google.maps.Marker({
                    position: window.selectedLocation,
                    map: window.map,
                    animation: google.maps.Animation.DROP,
                    title: description,
                    label: {
                        text: 'ğŸ¶',
                        fontSize: '24px'
                    },
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 0
                    },
                    optimized: false
                });
                
                // ä¿å­˜æ ‡è®°
                window.markers.push(marker);
                
                // ä¸ºæ ‡è®°æ·»åŠ ç‚¹å‡»äº‹ä»¶
                marker.addListener('click', function() {
                    // å…³é—­ä»»ä½•å·²æ‰“å¼€çš„ä¿¡æ¯çª—å£
                    if (window.openedInfoWindow) {
                        window.openedInfoWindow.close();
                    }
                    
                    // åˆ›å»ºä¿¡æ¯çª—å£å†…å®¹ï¼ŒåŒ…æ‹¬æè¿°å’Œå¯èƒ½çš„å›¾ç‰‡
                    let content = '<div style="padding:10px;max-width:300px;">';
                    
                    // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ·»åŠ å›¾ç‰‡
                    if (imageData) {
                        content += `<div style="margin-bottom:10px;"><img src="${imageData}" style="max-width:100%;max-height:150px;border-radius:4px;"></div>`;
                    }
                    
                    // æ·»åŠ æè¿°
                    content += `<div style="font-size:14px;margin-bottom:10px;">${description}</div>`;
                    
                    // æ·»åŠ æ—¶é—´æˆ³
                    const now = new Date();
                    content += `<div style="font-size:12px;color:#666;">${now.toLocaleDateString()} ${now.toLocaleTimeString()}</div>`;
                    
                    content += '</div>';
                    
                    // åˆ›å»ºå¹¶æ‰“å¼€ä¿¡æ¯çª—å£
                    const infoWindow = new google.maps.InfoWindow({
                        content: content,
                        maxWidth: 300
                    });
                    
                    infoWindow.open(window.map, marker);
                    
                    // ä¿å­˜å½“å‰æ‰“å¼€çš„ä¿¡æ¯çª—å£
                    window.openedInfoWindow = infoWindow;
                });
                
                // å°è¯•ä¿å­˜æ ‡è®°åˆ°localStorage
                try {
                    const markerData = window.markers.map(function(m) {
                        return {
                            lat: m.getPosition().lat(),
                            lng: m.getPosition().lng(),
                            description: m.getTitle() || '',
                            image: m === marker ? imageData : null
                        };
                    });
                    
                    localStorage.setItem('savedMarkers', JSON.stringify(markerData));
                    console.log('æ ‡è®°å·²ä¿å­˜åˆ°localStorage');
                } catch (error) {
                    console.error('ä¿å­˜æ ‡è®°åˆ°localStorageå¤±è´¥:', error);
                }
            } else {
                console.error('åœ°å›¾æœªåˆå§‹åŒ–ï¼Œæ— æ³•æ·»åŠ æ ‡è®°');
            }
            
            // æ˜¾ç¤ºæˆåŠŸå¼¹çª—
            const reportCounterPopup = document.getElementById('reportCounterPopup');
            if (reportCounterPopup) {
                reportCounterPopup.style.zIndex = '15000';
                reportCounterPopup.style.display = 'block';
                
                // 3ç§’åè‡ªåŠ¨å…³é—­
                setTimeout(function() {
                    reportCounterPopup.style.display = 'none';
                }, 3000);
            }
            
            console.log('ç´§æ€¥æäº¤æˆåŠŸ');
        } catch (error) {
            console.error('ç´§æ€¥æäº¤å¤±è´¥:', error);
            alert('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }
    </script>
</body>
</html>


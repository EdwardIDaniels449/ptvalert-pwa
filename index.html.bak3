<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="description" content="å¢¨å°”æœ¬äº¤é€šä¿¡æ¯å…±äº«å¹³å°">
    <meta name="apple-mobile-web-app-title" content="PtvAlert">
    
    <!-- å…¨å±€å˜é‡ä¿®å¤è„šæœ¬ - å¿…é¡»æœ€å…ˆåŠ è½½ -->
    <script src="./js/globals-fix.js"></script>
    <script src="./js/cache-functions.js"></script>
    <script src="config.js"></script>
    <script src="vapid-keys.js"></script>
    
    <!-- Firebaseä¸CloudflareåŒæ­¥è„šæœ¬ -->
    <script src="./js/firebase-to-cloudflare-sync.js"></script>
    
    <!-- URLè¯Šæ–­å’Œä¿®å¤è„šæœ¬ - æœ€å…ˆæ‰§è¡Œ -->
    <script>
        (function() {
            console.log('[URLè¯Šæ–­] å¼€å§‹æ£€æŸ¥URLå’Œç½‘ç»œé—®é¢˜');
            
            // å®šä¹‰å…¨å±€è°ƒè¯•å¯¹è±¡
            window._ptvalert_debug = {
                errors: [],
                warnings: [],
                fixes: []
            };
            
            function logDebug(type, message) {
                console.log(`[URLè¯Šæ–­] ${type}: ${message}`);
                if (type === 'ERROR') window._ptvalert_debug.errors.push(message);
                if (type === 'WARN') window._ptvalert_debug.warnings.push(message);
                if (type === 'FIX') window._ptvalert_debug.fixes.push(message);
            }
            
            // æ£€æŸ¥å½“å‰ç¯å¢ƒ
            const hostname = window.location.hostname;
            logDebug('INFO', `å½“å‰ä¸»æœºå: ${hostname}`);
            
            const isGithubPages = hostname.includes('github.io');
            if (isGithubPages) {
                logDebug('INFO', 'æ£€æµ‹åˆ°GitHub Pagesç¯å¢ƒ');
                
                // ä»URLä¸­è·å–ä»“åº“å
                const pathSegments = window.location.pathname.split('/');
                let repoName = '';
                
                if (pathSegments.length >= 2 && pathSegments[1]) {
                    repoName = pathSegments[1];
                    logDebug('INFO', `æ£€æµ‹åˆ°ä»“åº“å: ${repoName}`);
                    
                    // è®¾ç½®å…¨å±€å˜é‡ä¾›å…¶ä»–è„šæœ¬ä½¿ç”¨
                    window.GITHUB_PAGES_BASE_PATH = '/' + repoName + '/';
                    window.IS_GITHUB_PAGES = true;
                }
                
                // é¢„å…ˆå®šä¹‰API_BASE_URLä½¿ç”¨å½“å‰åŸŸå
                window.API_BASE_URL = 'https://' + hostname;
                logDebug('FIX', `å·²æå‰è®¾ç½®API_BASE_URL = ${window.API_BASE_URL}`);
            }
            
            // ä¸ºæ§åˆ¶å°æ·»åŠ è¯Šæ–­å‘½ä»¤
            window.showPtvAlertDiagnostics = function() {
                console.log('===== PtvAlert è¯Šæ–­ä¿¡æ¯ =====');
                console.log('å½“å‰URL:', window.location.href);
                console.log('ä¸»æœºå:', hostname);
                console.log('GitHub Pages:', isGithubPages ? 'æ˜¯' : 'å¦');
                
                if (window._ptvalert_debug.errors.length > 0) {
                    console.log('\né”™è¯¯:');
                    window._ptvalert_debug.errors.forEach(err => console.log('- ' + err));
                }
                
                if (window._ptvalert_debug.warnings.length > 0) {
                    console.log('\nè­¦å‘Š:');
                    window._ptvalert_debug.warnings.forEach(warn => console.log('- ' + warn));
                }
                
                if (window._ptvalert_debug.fixes.length > 0) {
                    console.log('\nå·²åº”ç”¨ä¿®å¤:');
                    window._ptvalert_debug.fixes.forEach(fix => console.log('- ' + fix));
                }
                
                console.log('\nAPIé…ç½®:');
                console.log('API_BASE_URL =', window.API_BASE_URL || 'æœªå®šä¹‰');
                
                if (window.PUSH_CONFIG) {
                    console.log('PUSH_CONFIG.SERVER_URL =', window.PUSH_CONFIG.SERVER_URL);
                }
                
                console.log('\nGitHub Pagesé…ç½®:');
                console.log('IS_GITHUB_PAGES =', window.IS_GITHUB_PAGES || false);
                console.log('GITHUB_PAGES_BASE_PATH =', window.GITHUB_PAGES_BASE_PATH || 'æœªå®šä¹‰');
                
                console.log('\næœåŠ¡å·¥ä½œçº¿ç¨‹:');
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(regs => {
                        if (regs.length === 0) {
                            console.log('æœªæ³¨å†ŒService Worker');
                        } else {
                            regs.forEach(reg => {
                                console.log(`Service Workerå·²æ³¨å†Œ: ${reg.scope}`);
                                console.log(`çŠ¶æ€: ${reg.active ? 'æ´»åŠ¨' : reg.installing ? 'å®‰è£…ä¸­' : reg.waiting ? 'ç­‰å¾…' : 'æœªçŸ¥'}`);
                            });
                        }
                    });
                } else {
                    console.log('æ­¤æµè§ˆå™¨ä¸æ”¯æŒService Worker');
                }
                
                console.log('===== è¯Šæ–­ç»“æŸ =====');
                console.log('å¦‚éœ€å¸®åŠ©è¯·åœ¨æ§åˆ¶å°è¿è¡Œ: showPtvAlertDiagnostics()');
            };
            
            // è¾“å‡ºè¯Šæ–­æç¤º
            console.log('[URLè¯Šæ–­] è¯Šæ–­å®Œæˆã€‚å¦‚éœ€æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼Œè¯·åœ¨æ§åˆ¶å°è¿è¡Œ: showPtvAlertDiagnostics()');
        })();
    </script>
    
    <!-- ç´§æ€¥å†…è”ä¿®å¤GitHub Pagesçš„è·¯å¾„é—®é¢˜ -->
    <script>
        (function() {
            // æ£€æµ‹æ˜¯å¦ä¸ºGitHub Pagesç¯å¢ƒ
            if (window.location.hostname.includes('github.io')) {
                console.log('[å†…è”ä¿®å¤] æ£€æµ‹åˆ°GitHub Pagesç¯å¢ƒï¼Œåº”ç”¨ç´§æ€¥ä¿®å¤');
                
                // è·å–ä»“åº“åç§°
                const getRepoName = function() {
                    const pathSegments = window.location.pathname.split('/');
                    if (pathSegments.length >= 2 && pathSegments[1]) {
                        return pathSegments[1];
                    }
                    // å¯èƒ½çš„ç¡¬ç¼–ç å›é€€å€¼
                    return 'ptvalert-pwa';
                };
                
                const repoName = getRepoName();
                const basePath = '/' + repoName + '/';
                
                console.log('[å†…è”ä¿®å¤] æ£€æµ‹åˆ°GitHub Pagesä»“åº“:', repoName);
                
                // å­˜å‚¨åŸºç¡€è·¯å¾„ä¾›åç»­è„šæœ¬ä½¿ç”¨
                window.GITHUB_PAGES_BASE_PATH = basePath;
                window.IS_GITHUB_PAGES = true;
                
                // ä¿®å¤APIè·¯å¾„
                window.API_BASE_URL = 'https://ptvalert.pages.dev';
                
                // ä¿®å¤Service Workerè·¯å¾„é—®é¢˜
                if ('serviceWorker' in navigator) {
                    // ä¿å­˜åŸå§‹æ³¨å†Œæ–¹æ³•
                    const originalRegister = navigator.serviceWorker.register;
                    
                    // æ›¿æ¢æ³¨å†Œæ–¹æ³•
                    navigator.serviceWorker.register = function(scriptURL, options) {
                        console.log('[å†…è”ä¿®å¤] æ‹¦æˆªService Workeræ³¨å†Œ:', scriptURL);
                        
                        // æ·»åŠ ä»“åº“åç§°åˆ°è·¯å¾„
                        let newScriptURL = scriptURL;
                        if (scriptURL.startsWith('./')) {
                            newScriptURL = basePath + scriptURL.substring(2);
                        } else if (scriptURL.startsWith('/')) {
                            newScriptURL = basePath + scriptURL.substring(1);
                        } else if (!scriptURL.includes('://')) {
                            newScriptURL = basePath + scriptURL;
                        }
                        
                        // ä¿®å¤ä½œç”¨åŸŸ
                        let newOptions = options || {};
                        if (!newOptions.scope || newOptions.scope === '/' || newOptions.scope === './') {
                            newOptions.scope = basePath;
                        }
                        
                        console.log('[å†…è”ä¿®å¤] é‡å†™ä¸º:', newScriptURL, newOptions);
                        
                        // ä½¿ç”¨ä¿®å¤åçš„å‚æ•°è°ƒç”¨åŸå§‹æ–¹æ³•
                        return originalRegister.call(this, newScriptURL, newOptions);
                    };
                    
                    console.log('[å†…è”ä¿®å¤] Service Workeræ³¨å†Œæ–¹æ³•å·²ä¿®å¤');
                }
            }
        })();
    </script>
    
    <!-- GitHub Pagesç¯å¢ƒä¿®å¤è„šæœ¬ - å¿…é¡»æœ€å…ˆåŠ è½½ -->
    <script src="./js/github-pages-fix.js"></script>
    
    <!-- å…¨å±€å˜é‡å£°æ˜ -->
    <script>
      // åˆå§‹åŒ–å…¨å±€å˜é‡
      window.currentLang = 'zh'; // é»˜è®¤è¯­è¨€
    </script>
    
    <script>
        // åœ¨é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å¹¶å¸è½½æ‰€æœ‰æœåŠ¡å·¥ä½œçº¿ç¨‹
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async function() {
                try {
                    console.log('å¼€å§‹å¤„ç†Service Workeræ³¨å†Œ...');
                    
                    // å¸è½½æ‰€æœ‰æœåŠ¡å·¥ä½œçº¿ç¨‹ä»¥ç¡®ä¿ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        console.log('å¸è½½æ—§çš„æœåŠ¡å·¥ä½œçº¿ç¨‹', registration.scope);
                        await registration.unregister();
                    }
                    console.log('æ‰€æœ‰æœåŠ¡å·¥ä½œçº¿ç¨‹å·²å¸è½½ï¼Œå°†é‡æ–°æ³¨å†Œæœ€æ–°ç‰ˆæœ¬');
                    
                    // ä½¿ç”¨ç®€å•çš„ç›¸å¯¹è·¯å¾„æ³¨å†ŒService Worker
                    try {
                        console.log('å°è¯•ä½¿ç”¨ç›¸å¯¹è·¯å¾„æ³¨å†ŒService Worker...');
                        const registration = await navigator.serviceWorker.register('./service-worker.js', {
                            scope: './'
                        });
                        console.log('Service Workeræ³¨å†ŒæˆåŠŸ:', registration.scope);
                    } catch (mainError) {
                        console.error('ä½¿ç”¨ä¸»Service Workeræ³¨å†Œå¤±è´¥:', mainError);
                        
                        // å°è¯•ä½¿ç”¨å¤‡ç”¨Service Worker
                        try {
                            console.log('å°è¯•æ³¨å†Œå¤‡ç”¨Service Worker...');
                            const fallbackReg = await navigator.serviceWorker.register('./fallback-service-worker.js', {
                                scope: './'
                            });
                            console.log('å¤‡ç”¨Service Workeræ³¨å†ŒæˆåŠŸ:', fallbackReg.scope);
                        } catch (fallbackError) {
                            console.error('å¤‡ç”¨Service Workeræ³¨å†Œä¹Ÿå¤±è´¥:', fallbackError);
                            
                            // æœ€åçš„å›é€€ - å†…è”æœ€å°Service Worker
                            if (window.location.hostname.includes('github.io')) {
                                console.log('å°è¯•ä½¿ç”¨å†…è”Service Workerä½œä¸ºæœ€åçš„å›é€€...');
                                
                                const minimalSWBlob = new Blob([`
                                    // æœ€å°åŒ–å†…è”Service Worker
                                    self.addEventListener('install', () => self.skipWaiting());
                                    self.addEventListener('activate', event => event.waitUntil(clients.claim()));
                                    self.addEventListener('fetch', event => event.respondWith(fetch(event.request)));
                                    console.log('å†…è”æœ€å°Service Workerå·²æ¿€æ´»');
                                `], {type: 'application/javascript'});
                                
                                const minimalSWUrl = URL.createObjectURL(minimalSWBlob);
                                
                                try {
                                    const inlineReg = await navigator.serviceWorker.register(minimalSWUrl, {
                                        scope: './'
                                    });
                                    console.log('å†…è”Service Workeræ³¨å†ŒæˆåŠŸ:', inlineReg.scope);
                                } catch (inlineError) {
                                    console.error('æ‰€æœ‰Service Workeræ³¨å†Œæ–¹æ³•éƒ½å¤±è´¥:', inlineError);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('å¤„ç†æœåŠ¡å·¥ä½œçº¿ç¨‹æ—¶å‡ºé”™:', error);
                }
            });
        }
    </script>
    
    <title>PtvAlert - åœ°å›¾æ ‡è®°ç³»ç»Ÿ</title>
    
    <!-- Manifestå’Œå›¾æ ‡ -->
    <link rel="manifest" href="./manifest.json">
    <!-- å†…è”åŸºæœ¬faviconé¿å…404é”™è¯¯ -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    
    <script>
        // å¤„ç†GitHub Pagesç¯å¢ƒä¸‹å›¾æ ‡è·¯å¾„é—®é¢˜
        if (window.location.hostname.includes('github.io')) {
            const pathSegments = window.location.pathname.split('/');
            if (pathSegments.length >= 2 && pathSegments[1]) {
                const repoName = pathSegments[1];
                const basePath = '/' + repoName;
                
                // æ›´æ–°å›¾æ ‡é“¾æ¥
                document.querySelectorAll('link[rel="icon"], link[rel="apple-touch-icon"], link[rel="manifest"]').forEach(link => {
                    const href = link.getAttribute('href');
                    if (href && href.startsWith('./')) {
                        link.setAttribute('href', basePath + href.substring(1));
                        console.log('[è·¯å¾„ä¿®å¤] æ›´æ–°èµ„æºè·¯å¾„:', href, '->', basePath + href.substring(1));
                    }
                });
            }
        }
    </script>
    
    <!-- æ ·å¼è¡¨ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    
    <!-- æ·»åŠ Firebase SDK è„šæœ¬ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- URLä¿®å¤å·¥å…· - å¤„ç†æ¨é€é€šçŸ¥URLé—®é¢˜ -->
    <script src="./js/url-fix.js?v=1.0.0"></script>
    
    <!-- æ¨é€é€šçŸ¥å¤„ç†è„šæœ¬ -->
    <script src="./js/notification-handler.js?v=2.0.1_20231121" id="notification-handler-script"></script>
    
    <!-- URLä¿®å¤è„šæœ¬ - ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„åŸŸå -->
    <script>
        (function() {
            // ç­‰å¾…notification-handleråŠ è½½å®Œæˆ
            window.setTimeout(function() {
                try {
                    // æ£€æŸ¥å…¨å±€å˜é‡API_BASE_URLæ˜¯å¦å­˜åœ¨
                    if (typeof API_BASE_URL !== 'undefined') {
                        // å¦‚æœä½¿ç”¨äº†é”™è¯¯çš„åŸŸåï¼Œåˆ™ä¿®å¤å®ƒ
                        if (API_BASE_URL.includes('your-subdomain.workers.dev')) {
                            console.warn('å‘ç°é”™è¯¯çš„API_BASE_URL:', API_BASE_URL);
                            API_BASE_URL = 'https://ptvalert.pages.dev';
                            console.warn('å·²ä¿®å¤ä¸º:', API_BASE_URL);
                        }
                    }
                } catch (e) {
                    console.error('æ£€æŸ¥æˆ–ä¿®å¤API_BASE_URLå¤±è´¥:', e);
                }
            }, 100);
        })();
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤ç§»åŠ¨ç«¯ç‚¹å‡»æ—¶çš„é«˜äº® */
        }
        
        body {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            background-color: #1c1c1e;
            color: #fff;
        }
        
        #map {
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        
        /* æŠ¥å‘Šè®¡æ•°å™¨å¼¹çª—æ ·å¼ */
        .report-counter-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(50, 50, 54, 0.95);
            border-radius: 16px;
            padding: 20px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            z-index: 3000;
            text-align: center;
            animation: popup-fade-in 0.3s ease-out;
            display: none;
        }
        
        @keyframes popup-fade-in {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }
        
        .report-counter-popup h3 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #fff;
        }
        
        .report-counter-popup p {
            font-size: 16px;
            margin-bottom: 20px;
            color: #ccc;
        }
        
        .counter-value {
            font-size: 24px;
            font-weight: bold;
            color: #0071e3;
            margin: 0 5px;
        }
        
        .close-counter-popup {
            background-color: #0071e3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .close-counter-popup:hover {
            background-color: #0077ed;
        }
        
        /* åœ°å›¾æ§åˆ¶æ ·å¼ */
        .map-control {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            margin: 0 auto;
            width: 80%;
            max-width: 600px;
            z-index: 1000;
        }
        
        .add-report-btn {
            display: block;
            width: 100%;
            background-color: white;
            color: #333;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            text-decoration: none;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .add-report-btn:hover {
            background-color: #f8f8f8;
        }
        
        /* æŠ¥å‘Šè¡¨å•æ ·å¼ */
        .report-form {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #1c1c1e;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
            z-index: 1001;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .report-form.active {
            transform: translateY(0);
        }
        
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .form-title {
            font-size: 20px;
            font-weight: bold;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-textarea {
            width: 100%;
            min-height: 100px;
            resize: vertical;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #444;
            background-color: #2c2c2e;
            color: #fff;
            font-size: 16px;
        }
        
        .submit-btn {
            width: 100%;
            background-color: #0071e3;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .submit-btn:hover {
            background-color: #0077ed;
        }
        
        /* ç”¨æˆ·èœå•æ ·å¼ */
        .user-menu {
            position: fixed;
            top: 60px;
            right: 18px;
            z-index: 1001;
            background: #fff;
            color: #333;
            border-radius: 20px;
            padding: 10px 18px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 2px 12px rgba(0,0,0,0.18);
            border: 2px solid #0071e3;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            display: none; /* é»˜è®¤éšè—ï¼Œç›´åˆ°ç”¨æˆ·éªŒè¯æˆåŠŸ */
        }
        
        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            width: 150px;
            display: none;
            z-index: 1002;
            overflow: hidden;
        }
        
        .user-menu-item {
            padding: 12px 15px;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .user-menu-item:hover {
            background-color: #f5f5f5;
        }
        
        .user-menu-item.logout {
            color: #e74c3c;
            border-top: 1px solid #eee;
        }
        
        /* ç§»åŠ¨è®¾å¤‡é€‚é… */
        @media (max-width: 768px) {
            .map-control {
                width: 90%;
                bottom: 20px;
            }
            
            .add-report-btn {
                padding: 14px;
                font-size: 18px;
            }
            
            .report-counter-popup {
                width: 95%;
                padding: 15px;
            }
        }

        /* å¼¹å¹•æ ·å¼ */
        .danmaku-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 70%;
            pointer-events: none;
            z-index: 900;
            overflow: hidden;
        }
        
        .danmaku {
            position: absolute;
            white-space: nowrap;
            color: white;
            font-weight: bold;
            font-size: 20px;
            padding: 5px 12px;
            border-radius: 18px;
            background-color: rgba(0, 0, 0, 0.65);
            animation-name: danmaku-move;
            animation-timing-function: linear;
            animation-iteration-count: 1;
            user-select: none;
            z-index: 900;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.9);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            letter-spacing: 0.5px;
        }
        
        @keyframes danmaku-move {
            from { transform: translateX(100vw); }
            to { transform: translateX(-100%); }
        }
        
        /* ç¿»è¯‘æŒ‰é’®æ ·å¼ */
        .translate-btn {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 5px;
            background-color: rgba(255, 255, 255, 0.2);
            color: #fff;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .translate-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .translated-text {
            margin-top: 5px;
            padding: 5px;
            background-color: rgba(0, 113, 227, 0.1);
            border-radius: 4px;
            font-style: italic;
            color: #8cc5ff;
        }
        
        #userDisplayName {
            cursor: pointer;
        }

        /* æ·»åŠ ç®¡ç†å‘˜æ ·å¼ */
        .admin-badge {
            background-color: #ff3b30;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            font-weight: bold;
            display: inline-block;
            vertical-align: middle;
        }

        .admin-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .admin-title {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
        }

        .admin-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
        }

        .admin-section {
            margin-bottom: 30px;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .admin-section-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #fff;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 5px;
        }

        .admin-button {
            background-color: #0071e3;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            margin-right: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        .admin-button.danger {
            background-color: #ff3b30;
        }

        .admin-button.warning {
            background-color: #ff9500;
        }

        .admin-button.success {
            background-color: #34c759;
        }

        .admin-input {
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            width: 100%;
            margin-bottom: 15px;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .admin-table th, .admin-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .admin-table th {
            background-color: rgba(255, 255, 255, 0.1);
            font-weight: bold;
        }

        .admin-table tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .admin-announcement {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            margin: 0 auto;
            width: 90%;
            max-width: 800px;
            background-color: rgba(255, 149, 0, 0.9);
            color: white;
            border-radius: 10px;
            padding: 12px 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 5003;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slide-down 0.5s ease-out;
        }

        .admin-announcement.error {
            background-color: rgba(255, 59, 48, 0.9);
        }

        .admin-announcement.info {
            background-color: rgba(0, 122, 255, 0.9);
        }

        @keyframes slide-down {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .admin-announcement-content {
            font-weight: bold;
            flex: 1;
        }

        .admin-announcement-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            margin-left: 15px;
        }

        .banned-user-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 59, 48, 0.95);
            z-index: 5000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            text-align: center;
        }

        .banned-user-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 20px;
            color: white;
        }

        .banned-user-message {
            font-size: 18px;
            margin-bottom: 30px;
            color: white;
            max-width: 500px;
        }

        .banned-user-info {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            color: white;
        }

        .global-announcement-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #ff3b30;
            color: white;
            text-align: center;
            padding: 10px;
            font-weight: bold;
            z-index: 1999;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        /* å¿«é€Ÿæè¿°å¼¹çª—æ ·å¼ */
        .quick-desc-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(50, 50, 54, 0.95);
            border-radius: 16px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            z-index: 2000;
            animation: popup-fade-in 0.3s ease-out;
        }
    </style>
</head>
<body>
    <!-- å³ä¸Šè§’è¯­è¨€åˆ‡æ¢æŒ‰é’® -->
    <button id="langSwitchBtn" style="position:fixed;top:18px;right:18px;z-index:1001;background:rgba(255,255,255,0.8);color:#333;border-radius:20px;padding:6px 12px;font-size:14px;font-weight:bold;box-shadow:0 2px 12px rgba(0,0,0,0.18);border:2px solid #0071e3;cursor:pointer;display:flex;align-items:center;gap:6px;transition:background 0.2s,border 0.2s;">
      <span style="font-size:16px;">ğŸŒ</span>
      <span id="langSwitchText">EN</span>
    </button>
    
    <!-- ç”¨æˆ·èœå• -->
    <div id="userMenu" class="user-menu">
      <span style="font-size:16px;">ğŸ‘¤</span>
      <span id="userDisplayName" style="max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">ç”¨æˆ·</span>
      <div class="user-menu-dropdown" id="userMenuDropdown">
        <div class="user-menu-item" id="profileMenuItem">ä¸ªäººèµ„æ–™</div>
        <div class="user-menu-item logout" id="logoutMenuItem">é€€å‡ºç™»å½•</div>
      </div>
    </div>
    
    <!-- æ·»åŠ å¼¹å¹•å®¹å™¨ -->
    <div class="danmaku-container" id="danmakuContainer"></div>
    
    <!-- åœ°å›¾å®¹å™¨ -->
    <div id="map"></div>
    
    <!-- åœ°å›¾æ§åˆ¶ -->
    <div class="map-control">
        <div style="display:flex;gap:10px;margin-bottom:10px;">
            <a href="#" class="add-report-btn" id="addReportBtn">+ æ·»åŠ æŠ¥å‘Š</a>
            <a href="#" class="add-report-btn" id="quickAddBtn" style="background-color:#34c759;">+ ç›´æ¥æ·»åŠ æè¿°</a>
        </div>
        <span id="addReportTip" style="display:none;color:#ffb300;font-size:14px;margin-left:10px;">è¯·åœ¨åœ°å›¾ä¸Šç‚¹é€‰ä½ç½®</span>
    </div>
    
    <!-- æ¨é€é€šçŸ¥æŒ‰é’® -->
    <div style="position:fixed;bottom:100px;right:20px;z-index:2000;">
        <button id="requestPushPermission" style="background-color:#0071e3;color:white;border:none;padding:10px 15px;border-radius:8px;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.3);display:flex;align-items:center;gap:6px;">
            <span style="font-size:20px;">ğŸ””</span>
            <span id="pushBtnText">å¯ç”¨æ¨é€é€šçŸ¥</span>
        </button>
    </div>
    
    <!-- æŠ¥å‘Šè®¡æ•°å™¨å¼¹çª— -->
    <div class="report-counter-popup" id="reportCounterPopup">
        <h3 id="reportSuccessTitle">æŠ¥å‘Šæäº¤æˆåŠŸ!</h3>
        <p id="reportCounterText">æ‚¨å·²ç´¯è®¡æäº¤ <span class="counter-value" id="reportCountValue">1</span> æ¬¡æŠ¥å‘Š</p>
        <button class="close-counter-popup" id="closeCounterPopup">ç¡®å®š</button>
    </div>
    
    <!-- æŠ¥å‘Šè¡¨å• -->
    <div class="report-form" id="reportForm" style="position:fixed;bottom:0;left:0;right:0;background-color:#1c1c1e;padding:20px;border-radius:20px 20px 0 0;box-shadow:0 -2px 10px rgba(0,0,0,0.5);z-index:1001;transform:translateY(100%);transition:transform 0.3s ease-in-out;">
        <div class="form-header">
            <h2 class="form-title" id="formTitle">æ–°æŠ¥å‘Š</h2>
            <button class="form-close" id="formClose" style="background:none;border:none;color:#fff;font-size:24px;cursor:pointer;">&times;</button>
        </div>
        
        <div class="form-group">
            <label class="form-label" id="photoLabel">ç…§ç‰‡</label>
            <div class="image-preview" style="width:100%;height:200px;border-radius:8px;background-color:#2c2c2e;display:flex;align-items:center;justify-content:center;margin-bottom:15px;overflow:hidden;position:relative;cursor:pointer;">
                <img src="" class="preview-img" id="previewImg" style="max-width:100%;max-height:100%;display:none;">
                <span class="image-placeholder" id="imagePlaceholder">ç‚¹å‡»æ·»åŠ ç…§ç‰‡</span>
                <input type="file" id="imageInput" accept="image/*" style="position:absolute;left:0;top:0;width:100%;height:100%;opacity:0;cursor:pointer;z-index:2;">
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label" id="descLabel">æè¿°</label>
            <textarea class="form-textarea" id="descriptionInput" placeholder="è¯·æè¿°æ‚¨çœ‹åˆ°çš„æƒ…å†µ..." style="width:100%;padding:12px;border-radius:8px;border:1px solid #444;background-color:#2c2c2e;color:#fff;font-size:16px;min-height:100px;resize:vertical;"></textarea>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;">
                <button id="geocodeLocationBtn" style="padding:6px 12px;background-color:#0077cc;color:white;border:none;border-radius:6px;font-size:14px;cursor:pointer;">æ ¹æ®æè¿°å®šä½</button>
                <button id="currentLocationBtn" style="padding:6px 12px;margin-left:8px;background-color:#34c759;color:white;border:none;border-radius:6px;font-size:14px;cursor:pointer;">ä½¿ç”¨å½“å‰ä½ç½®</button>
                <span style="font-size:12px;color:#999;margin-left:8px;flex:1;text-align:right;">æç¤º: è¾“å…¥åœ°ç‚¹æè¿°åç‚¹å‡»ï¼Œæˆ–ä½¿ç”¨Ctrl+Enterå¿«æ·é”®</span>
            </div>
            <div id="geocodeStatus" style="margin-top:5px;font-size:14px;color:#ffcc00;display:none;"></div>
        </div>
        
        <div style="display:flex;gap:10px;margin-top:15px;">
            <button class="submit-btn" id="submitReport" style="flex:1;background-color:#0071e3;color:white;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;">ç¡®å®š</button>
            <button class="reset-location-btn" id="resetLocationBtn" style="flex:1;background-color:#ffc107;color:#000;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;">é‡æ–°é€‰ç‚¹</button>
            <button class="cancel-btn" id="cancelReport" style="flex:1;background-color:#3a3a3c;color:white;border:none;padding:14px;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;">å–æ¶ˆ</button>
        </div>
    </div>
    
    <!-- Firebaseåˆå§‹åŒ– -->
    <script>
        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyD5qFJl2MNiYKCjrQo8iBST5U4LkhkXYi8",
            authDomain: "ptvalert-19ea4.firebaseapp.com",
            databaseURL: "https://ptvalert-19ea4-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ptvalert-19ea4",
            storageBucket: "ptvalert-19ea4.appspot.com",
            messagingSenderId: "590126951854",
            appId: "1:590126951854:web:4cbc14144b0a395dc42c3f"
        };
        
        // å¢åŠ åŒæ­¥é€‰é¡¹ï¼Œè®¾ç½®ä¸ºtrueä»¥ç¡®ä¿æ•°æ®åŒæ­¥
        const syncToCloudflare = true; // å³ä½¿ä½¿ç”¨Firebaseä¹ŸåŒæ­¥åˆ°Cloudflare
        
        // ç¡®å®šå½“å‰ä½¿ç”¨çš„å­˜å‚¨ç³»ç»Ÿ
        const useCloudflare = true; // è®¾ç½®ä¸ºtrueä½¿ç”¨Cloudflare, falseä½¿ç”¨Firebase
        
        // å®šä¹‰Cloudflare APIé…ç½®
        const cloudflareConfig = {
            apiUrl: 'https://ptvalert.pages.dev', // ä½ çš„å®é™…Cloudflare Worker URL
            dataEndpoint: '/api/reports',
            syncEndpoint: '/api/sync-from-firebase',
            notificationEndpoint: '/api/send-notification',
            apiKey: '51DZw4un3KKP91kKGEhSMRlv4rT9563sjSHiLuHZc2fi1TxkfwFXH52ZVVhOTzwv5jcJPfFabquIS49Et0ucJXixEr7RJV9dQ65nQNe1mt79wOyxHR8DoHFjFS0CRZoO4q2fw3x1A1FdwPtwbfmkuhYa0okUTSxVk4aMTu4hVjnNYv5y1W4e9fwwsjPLgli3MOzNQ1VkgB8lRleb5dOYpAGGW2TcnTGa9ruR5dzIzjw6JsjA2UPd2rvy1rLAqqHm', // æ·»åŠ APIå¯†é’¥ç”¨äºè®¤è¯
            useRealApi: true // è®¾ç½®ä¸ºtrueä½¿ç”¨çœŸå®APIï¼Œfalseä½¿ç”¨æ¨¡æ‹Ÿå“åº”
        };
        
        /*
         * è¦ä½¿ç”¨çœŸå®çš„Cloudflareé€šä¿¡å’Œæ¨é€é€šçŸ¥ï¼Œä½ éœ€è¦:
         * 1. åœ¨Cloudflare Workersä¸Šéƒ¨ç½²é€‚å½“çš„APIç«¯ç‚¹
         * 2. è®¾ç½®cloudflareConfig.apiUrlä¸ºä½ çš„Worker URL
         * 3. ç”Ÿæˆå¹¶é…ç½®å®‰å…¨çš„APIå¯†é’¥
         * 4. ç¡®ä¿cloudflareConfig.useRealApiè®¾ç½®ä¸ºtrue
         * 5. ç”Ÿæˆå¹¶é…ç½®VAPIDå¯†é’¥ç”¨äºWeb Push API
         * 6. åœ¨notification-handler.jsä¸­æ›´æ–°vapidPublicKey
         */
        
        // åˆå§‹åŒ–Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const database = firebase.database();
        
        // è·å–æ•°æ®åº“å¼•ç”¨
        const reportsRef = database.ref('reports');
        const userReportsCountRef = database.ref('userReportsCount');
        
        // ç®¡ç†å‘˜ç›¸å…³æ•°æ®åº“å¼•ç”¨
        const adminUsersRef = database.ref('adminUsers');
        const bannedUsersRef = database.ref('bannedUsers');
        const announcementsRef = database.ref('announcements');
        
        // å½“å‰ç”¨æˆ·ç®¡ç†å‘˜çŠ¶æ€
        let isCurrentUserAdmin = false;
        
        // å¼¹å¹•åŠŸèƒ½
        const danmakuContainer = document.getElementById('danmakuContainer');
        const danmakuQueue = [];
        const activeDanmakus = [];
        let danmakuRunning = false;
        
        // è¯­è¨€è®¾ç½®
        let currentLang = 'zh';
        const i18n = {
            zh: {
                reportSuccess: 'æŠ¥å‘Šæäº¤æˆåŠŸ!',
                reportCounterText: 'æ‚¨å·²ç´¯è®¡æäº¤ {count} æ¬¡æŠ¥å‘Š',
                closeButton: 'ç¡®å®š',
                addReport: '+ æ·»åŠ æŠ¥å‘Š',
                newReport: 'æ–°æŠ¥å‘Š',
                photo: 'ç…§ç‰‡',
                imagePlaceholder: 'ç‚¹å‡»æ·»åŠ ç…§ç‰‡',
                description: 'æè¿°',
                descriptionPlaceholder: 'è¯·æè¿°æ‚¨çœ‹åˆ°çš„æƒ…å†µ...',
                submit: 'ç¡®å®š',
                resetLocation: 'é‡æ–°é€‰ç‚¹',
                cancel: 'å–æ¶ˆ',
                selectLocation: 'è¯·åœ¨åœ°å›¾ä¸Šç‚¹é€‰ä½ç½®',
                reportDetails: 'æŠ¥å‘Šè¯¦æƒ…',
                noDescription: 'æ— æè¿°',
                selecting: 'æ­£åœ¨é€‰ç‚¹...',
                translate: 'ğŸŒ',
                translating: 'ç¿»è¯‘ä¸­...',
                translation: 'ç¿»è¯‘: ',
                refreshTramInfo: 'åˆ·æ–°ç”µè½¦ä¿¡æ¯',
                addComment: 'æ·»åŠ è¯„è®º',
                deleteReport: 'åˆ é™¤æŠ¥å‘Š',
                commentPlaceholder: 'å†™ä¸‹æ‚¨çš„è¯„è®º...',
                submitComment: 'å‘é€',
                cancelComment: 'å–æ¶ˆ',
                confirmDelete: 'ç¡®å®šè¦åˆ é™¤è¿™æ¡æŠ¥å‘Šå—ï¼Ÿ',
                yes: 'æ˜¯',
                no: 'å¦',
                profile: 'ä¸ªäººèµ„æ–™',
                logout: 'é€€å‡ºç™»å½•',
                comments: 'è¯„è®º',
                noComments: 'æš‚æ— è¯„è®º',
                geocodeLocation: 'æ ¹æ®æè¿°å®šä½',
                geocoding: 'æ­£åœ¨å®šä½...',
                geocodeSuccess: 'å®šä½æˆåŠŸ!',
                geocodeError: 'å®šä½å¤±è´¥ï¼Œè¯·å°è¯•æ›´è¯¦ç»†çš„æè¿°æˆ–æ‰‹åŠ¨é€‰ç‚¹',
                useCurrentLocation: 'ä½¿ç”¨å½“å‰ä½ç½®',
                gettingLocation: 'è·å–ä½ç½®ä¸­...',
                locationSuccess: 'å·²è·å–å½“å‰ä½ç½®',
                locationError: 'æ— æ³•è·å–ä½ç½®ï¼Œè¯·æ£€æŸ¥ä½ç½®æƒé™',
                // å¿«é€Ÿæ·»åŠ æè¿°åŠŸèƒ½
                quickAddDesc: '+ ç›´æ¥æ·»åŠ æè¿°',
                quickAddTitle: 'å¿«é€Ÿæ·»åŠ æè¿°',
                quickDescPlaceholder: 'è¯·è¾“å…¥äº‹ä»¶æè¿°...',
                addToMap: 'æ·»åŠ åˆ°åœ°å›¾',
                addedMarkerFromDesc: 'å·²æ ¹æ®"{desc}"æ·»åŠ æ ‡è®°',
                usePresetLocation: 'å·²ä»é¢„è®¾ä½ç½®ä¸­æ‰¾åˆ°åŒ¹é…',
                // ç®¡ç†å‘˜ç›¸å…³ç¿»è¯‘
                adminPanel: 'ç®¡ç†å‘˜æ§åˆ¶é¢æ¿',
                adminBadge: 'ç®¡ç†å‘˜',
                announcements: 'å‘å¸ƒå…¨å±€å…¬å‘Š',
                announcementContent: 'å…¬å‘Šå†…å®¹',
                announcementType: 'å…¬å‘Šç±»å‹',
                publishTempAnnouncement: 'å‘å¸ƒä¸´æ—¶å…¬å‘Š',
                publishGlobalAnnouncement: 'å‘å¸ƒå…¨å±€é¡¶éƒ¨å…¬å‘Š',
                clearGlobalAnnouncement: 'æ¸…é™¤å…¨å±€å…¬å‘Š',
                reportsManagement: 'æŠ¥å‘Šç®¡ç†',
                filterCondition: 'è¿‡æ»¤æ¡ä»¶',
                id: 'ID',
                time: 'æ—¶é—´',
                user: 'ç”¨æˆ·',
                actions: 'æ“ä½œ',
                refresh: 'åˆ·æ–°åˆ—è¡¨',
                userManagement: 'ç”¨æˆ·ç®¡ç†',
                userIdOrEmail: 'ç”¨æˆ·IDæˆ–é‚®ç®±',
                banUser: 'å°ç¦ç”¨æˆ·',
                unbanUser: 'è§£é™¤å°ç¦',
                promoteAdmin: 'æå‡ä¸ºç®¡ç†å‘˜',
                removeAdmin: 'ç§»é™¤ç®¡ç†å‘˜æƒé™',
                userName: 'ç”¨æˆ·å',
                status: 'çŠ¶æ€',
                role: 'è§’è‰²',
                banned: 'å·²å°ç¦',
                active: 'æ­£å¸¸',
                admin: 'ç®¡ç†å‘˜',
                normalUser: 'æ™®é€šç”¨æˆ·',
                warning: 'è­¦å‘Š (é»„è‰²)',
                error: 'ç´§æ€¥ (çº¢è‰²)',
                info: 'ä¿¡æ¯ (è“è‰²)',
                userBanned: 'è´¦å·å·²è¢«å°ç¦',
                banReason: 'å°ç¦åŸå› ',
                contactAdmin: 'å¦‚æœ‰ç–‘é—®è¯·è”ç³»ç®¡ç†å‘˜',
                deleteConfirm: 'ç¡®è®¤åˆ é™¤',
                banConfirm: 'ç¡®è®¤å°ç¦',
                adminControls: 'ç®¡ç†é€‰é¡¹'
            },
            en: {
                reportSuccess: 'Report submitted successfully!',
                reportCounterText: 'You have submitted {count} reports in total',
                closeButton: 'OK',
                addReport: '+ Add Report',
                newReport: 'New Report',
                photo: 'Photo',
                imagePlaceholder: 'Click to add photo',
                description: 'Description',
                descriptionPlaceholder: 'Describe what you see...',
                submit: 'Submit',
                resetLocation: 'Reset Location',
                cancel: 'Cancel',
                selectLocation: 'Please select a location on the map',
                reportDetails: 'Report Details',
                noDescription: 'No description',
                selecting: 'Selecting...',
                translate: 'ğŸŒ',
                translating: 'Translating...',
                translation: 'Translation: ',
                refreshTramInfo: 'Refresh Tram Info',
                addComment: 'Add Comment',
                deleteReport: 'Delete Report',
                commentPlaceholder: 'Write your comment...',
                submitComment: 'Send',
                cancelComment: 'Cancel',
                confirmDelete: 'Are you sure you want to delete this report?',
                yes: 'Yes',
                no: 'No',
                profile: 'Profile',
                logout: 'Logout',
                comments: 'Comments',
                noComments: 'No comments yet',
                geocodeLocation: 'Find Location from Description',
                geocoding: 'Finding location...',
                geocodeSuccess: 'Location found!',
                geocodeError: 'Location not found, please try a more specific description or select manually',
                useCurrentLocation: 'Use Current Location',
                gettingLocation: 'Getting location...',
                locationSuccess: 'Current location obtained',
                locationError: 'Could not get location, please check location permissions',
                // Quick add description feature
                quickAddDesc: '+ Direct Description',
                quickAddTitle: 'Add Description Directly',
                quickDescPlaceholder: 'Please enter event description...',
                addToMap: 'Add to Map',
                addedMarkerFromDesc: 'Added marker based on "{desc}"',
                usePresetLocation: 'Match found in preset locations',
                // Admin related translations
                adminPanel: 'Admin Control Panel',
                adminBadge: 'ADMIN',
                announcements: 'Publish Global Announcement',
                announcementContent: 'Announcement Content',
                announcementType: 'Announcement Type',
                publishTempAnnouncement: 'Publish Temporary Announcement',
                publishGlobalAnnouncement: 'Publish Global Banner Announcement',
                clearGlobalAnnouncement: 'Clear Global Announcement',
                reportsManagement: 'Reports Management',
                filterCondition: 'Filter',
                id: 'ID',
                time: 'Time',
                user: 'User',
                actions: 'Actions',
                refresh: 'Refresh List',
                userManagement: 'User Management',
                userIdOrEmail: 'User ID or Email',
                banUser: 'Ban User',
                unbanUser: 'Unban User',
                promoteAdmin: 'Promote to Admin',
                removeAdmin: 'Remove Admin',
                userName: 'Username',
                status: 'Status',
                role: 'Role',
                banned: 'Banned',
                active: 'Active',
                admin: 'Admin',
                normalUser: 'Normal User',
                warning: 'Warning (Yellow)',
                error: 'Emergency (Red)',
                info: 'Information (Blue)',
                userBanned: 'Account Banned',
                banReason: 'Ban Reason',
                contactAdmin: 'Please contact administrators if you have questions',
                deleteConfirm: 'Confirm Delete',
                banConfirm: 'Confirm Ban',
                adminControls: 'Admin Options'
            }
        };
        
        // å½“å‰ç”¨æˆ·ID
        // let currentUserId = ''; // Temporarily commented out for debugging
        // ç”¨æˆ·æŠ¥å‘Šè®¡æ•°
        let userReportCount = 0;
        // ç”¨äºå­˜å‚¨é€‰ä¸­çš„ä½ç½®
        let selectedLocation = null;
        // é€‰æ‹©ä½ç½®æ¨¡å¼
        let isSelectingLocation = false;
        // åœ°å›¾æ ‡è®°ç›¸å…³
        let selectionMarker = null;
        let selectionCircle = null;
        
        // å¢¨å°”æœ¬ç”µè½¦å…¬å‘Šæ•°æ®
        const tramAnnouncements = [
            "Route 1: Minor delays due to track maintenance between Stop 13 and Federation Square.",
            "Route 5: Service running smoothly with normal frequency.",
            "Route 11: Additional services added during peak hours due to increased demand.",
            "Route 16: Temporary stop closure at Melbourne University until further notice.",
            "Route 19: Normal service has resumed after earlier disruption.",
            "Route 48: Delays expected near Bridge Road due to road works.",
            "Route 57: Service changes this weekend for scheduled maintenance.",
            "Route 58: Increased frequency during AFL matches at MCG.",
            "Route 64: Minor delays expected due to traffic congestion in CBD area.",
            "Route 70: Service diverted between stops 10-15 due to street festival.",
            "Route 75: Service operating normally with good frequency.",
            "Route 86: Temporary stop relocation at Bourke Street due to construction.",
            "Route 96: Express service available during peak hours.",
            "All routes: Free tram zone remains in effect in CBD area.",
            "Safety reminder: Please hold handrails when tram is in motion."
        ];
        
        // å¢¨å°”æœ¬ç”µè½¦å…¬å‘Šä¸­æ–‡ç‰ˆ
        const tramAnnouncementsCN = [
            "1å·çº¿ï¼š13ç«™å’Œè”é‚¦å¹¿åœºä¹‹é—´çš„è½¨é“ç»´ä¿®å¯¼è‡´è½»å¾®å»¶è¯¯ã€‚",
            "5å·çº¿ï¼šæœåŠ¡å¹³ç¨³è¿è¡Œï¼Œé¢‘ç‡æ­£å¸¸ã€‚",
            "11å·çº¿ï¼šå› éœ€æ±‚å¢åŠ ï¼Œé«˜å³°æ—¶æ®µå¢åŠ äº†æœåŠ¡ã€‚",
            "16å·çº¿ï¼šå¢¨å°”æœ¬å¤§å­¦ç«™ä¸´æ—¶å…³é—­ï¼Œæ¢å¤æ—¶é—´å¾…å®šã€‚",
            "19å·çº¿ï¼šæ—©å…ˆçš„ä¸­æ–­åï¼Œæ­£å¸¸æœåŠ¡å·²æ¢å¤ã€‚",
            "48å·çº¿ï¼šç”±äºé“è·¯å·¥ç¨‹ï¼ŒBridge Roadé™„è¿‘é¢„è®¡ä¼šæœ‰å»¶è¯¯ã€‚",
            "57å·çº¿ï¼šæœ¬å‘¨æœ«è®¡åˆ’ç»´æŠ¤ï¼ŒæœåŠ¡æœ‰å˜æ›´ã€‚",
            "58å·çº¿ï¼šMCGä¸¾è¡ŒAFLæ¯”èµ›æœŸé—´ï¼Œå¢åŠ é¢‘ç‡ã€‚",
            "64å·çº¿ï¼šç”±äºå¸‚ä¸­å¿ƒåŒºåŸŸäº¤é€šæ‹¥å µï¼Œé¢„è®¡ä¼šæœ‰è½»å¾®å»¶è¯¯ã€‚",
            "70å·çº¿ï¼šå› è¡—å¤´èŠ‚æ—¥æ´»åŠ¨ï¼Œ10-15ç«™ä¹‹é—´æœåŠ¡æ”¹é“ã€‚",
            "75å·çº¿ï¼šæœåŠ¡æ­£å¸¸è¿è¡Œï¼Œé¢‘ç‡è‰¯å¥½ã€‚",
            "86å·çº¿ï¼šç”±äºå»ºç­‘å·¥ç¨‹ï¼ŒBourke Streetç«™ä¸´æ—¶è¿ç§»ã€‚",
            "96å·çº¿ï¼šé«˜å³°æ—¶æ®µæä¾›å¿«é€ŸæœåŠ¡ã€‚",
            "æ‰€æœ‰çº¿è·¯ï¼šå¸‚ä¸­å¿ƒåŒºåŸŸå…è´¹ç”µè½¦åŒºä»ç„¶æœ‰æ•ˆã€‚",
            "å®‰å…¨æé†’ï¼šç”µè½¦è¡Œé©¶æ—¶è¯·æ‰¶å¥½æ‰¶æ‰‹ã€‚"
        ];
        
        // éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€
        function checkAuthState() {
            // é¦–å…ˆæ£€æŸ¥localStorage
            const isGuestUserLS = localStorage.getItem('isGuestUser') === 'true';
            const userLoggedInLS = localStorage.getItem('userLoggedIn') === 'true';
            const guestIdLS = localStorage.getItem('guestId');
            
            // å¦‚æœlocalStorageæ˜¾ç¤ºç”¨æˆ·æœªç™»å½•ï¼Œä¸å†è¿›è¡Œåç»­æ£€æŸ¥
            if (!userLoggedInLS) {
                console.log('localStorageæ˜¾ç¤ºç”¨æˆ·æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ...');
                window.location.href = 'login.html';
                return;
            }
            
            // ç¡®å®šæ˜¯å¦ä¸ºæ¸¸å®¢æ¨¡å¼
            const isGuestUser = isGuestUserLS;
            const userLoggedIn = userLoggedInLS;
            const guestId = guestIdLS || 'guest_user';
            
            if (isGuestUser && userLoggedIn) {
                console.log('ä½¿ç”¨æ¸¸å®¢æ¨¡å¼...');
                console.log('æ¸¸å®¢ID:', guestId);
                
                // è®¾ç½®å½“å‰ç”¨æˆ·IDä¸ºæ¸¸å®¢ID
                currentUserId = guestId;
                
                // æ˜¾ç¤ºæ¸¸å®¢æ¨¡å¼èœå•
                const userMenu = document.getElementById('userMenu');
                const userDisplayName = document.getElementById('userDisplayName');
                // æ ¹æ®å½“å‰è¯­è¨€è®¾ç½®æ˜¾ç¤ºæ–‡æœ¬
                userDisplayName.textContent = currentLang === 'zh' ? 'æ¸¸å®¢' : 'Guest';
                userMenu.style.display = 'flex';
                
                // åŠ è½½ç”¨æˆ·æŠ¥å‘Šè®¡æ•°
                loadUserReportCount(currentUserId);
                
                // æ¸¸å®¢ä¸èƒ½æ˜¯ç®¡ç†å‘˜
                isCurrentUserAdmin = false;
                
                return; // æ¸¸å®¢æ¨¡å¼ç™»å½•æˆåŠŸï¼Œä¸éœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥
            }
            
            // å¦‚æœä¸æ˜¯æ¸¸å®¢æ¨¡å¼ï¼Œæ£€æŸ¥Firebaseè®¤è¯
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    // ç”¨æˆ·å·²é€šè¿‡Firebaseç™»å½•
                    console.log('ç”¨æˆ·å·²ç™»å½•Firebase:', user.uid, user.isAnonymous ? '(åŒ¿åç”¨æˆ·)' : '');
                    // æ›´æ–°å½“å‰ç”¨æˆ·ID
                    currentUserId = user.uid;
                    
                    // åŠ è½½ç”¨æˆ·æŠ¥å‘Šè®¡æ•°
                    loadUserReportCount(currentUserId);
                    
                    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ç®¡ç†å‘˜
                    checkAdminStatus(currentUserId);
                    
                    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«å°ç¦
                    checkUserBanStatus(currentUserId);
                    
                    // æ›´æ–°ç”¨æˆ·èœå•
                    updateUserMenu(user);
                } else if (userLoggedIn) {
                    // ç”¨æˆ·é€šè¿‡localStorageç™»å½•ä½†Firebaseä¸è¯†åˆ«
                    console.log('ç”¨æˆ·å·²é€šè¿‡localStorageç™»å½•');
                    const userEmail = localStorage.getItem('userEmail') || (currentLang === 'zh' ? 'ç”¨æˆ·' : 'User');
                    
                    // ä½¿ç”¨emailä½œä¸ºç”¨æˆ·ID
                    currentUserId = userEmail.replace(/[^a-zA-Z0-9]/g, '_');
                    
                    // åŠ è½½ç”¨æˆ·æŠ¥å‘Šè®¡æ•°
                    loadUserReportCount(currentUserId);
                    
                    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ç®¡ç†å‘˜
                    checkAdminStatus(currentUserId);
                    
                    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«å°ç¦
                    checkUserBanStatus(currentUserId);
                    
                    // æ›´æ–°ç”¨æˆ·èœå•
                    const userMenu = document.getElementById('userMenu');
                    const userDisplayName = document.getElementById('userDisplayName');
                    userDisplayName.textContent = userEmail.split('@')[0];
                    userMenu.style.display = 'flex';
                } else {
                    // æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
                    console.log('ç”¨æˆ·æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ...');
                    window.location.href = 'login.html';
                }
            });
        }
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ç®¡ç†å‘˜
        function checkAdminStatus(userId) {
            adminUsersRef.child(userId).once('value')
                .then((snapshot) => {
                    isCurrentUserAdmin = snapshot.exists() && snapshot.val() === true;
                    console.log('ç”¨æˆ·ç®¡ç†å‘˜çŠ¶æ€:', isCurrentUserAdmin);
                    
                    // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œæ›´æ–°ç”¨æˆ·èœå•
                    if (isCurrentUserAdmin) {
                        const userDisplayName = document.getElementById('userDisplayName');
                        // æ·»åŠ ç®¡ç†å‘˜æ ‡ç­¾
                        if (!document.getElementById('adminBadge')) {
                            const adminBadge = document.createElement('span');
                            adminBadge.id = 'adminBadge';
                            adminBadge.className = 'admin-badge';
                            adminBadge.textContent = i18n[currentLang].adminBadge;
                            userDisplayName.parentNode.insertBefore(adminBadge, userDisplayName.nextSibling);
                        }
                        
                        // æ›´æ–°ç”¨æˆ·èœå•æ·»åŠ ç®¡ç†å‘˜é¢æ¿é€‰é¡¹
                        updateAdminMenuOptions();
                    }
                })
                .catch((error) => {
                    console.error('æ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€å‡ºé”™:', error);
                    isCurrentUserAdmin = false;
                });
        }
        
        // æ›´æ–°ç®¡ç†å‘˜èœå•é€‰é¡¹
        function updateAdminMenuOptions() {
            const userMenuDropdown = document.getElementById('userMenuDropdown');
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç®¡ç†å‘˜é€‰é¡¹
            if (!document.getElementById('adminPanelMenuItem')) {
                // åˆ›å»ºç®¡ç†å‘˜é¢æ¿èœå•é¡¹
                const adminMenuItem = document.createElement('div');
                adminMenuItem.id = 'adminPanelMenuItem';
                adminMenuItem.className = 'user-menu-item';
                adminMenuItem.textContent = i18n[currentLang].adminPanel;
                adminMenuItem.style.fontWeight = 'bold';
                adminMenuItem.style.color = '#ff3b30';
                
                // æ’å…¥åˆ°ç¬¬ä¸€ä¸ªä½ç½®
                if (userMenuDropdown.firstChild) {
                    userMenuDropdown.insertBefore(adminMenuItem, userMenuDropdown.firstChild);
                } else {
                    userMenuDropdown.appendChild(adminMenuItem);
                }
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                adminMenuItem.addEventListener('click', function() {
                    openAdminPanel();
                    userMenuDropdown.style.display = 'none';
                });
            }
        }
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¢«å°ç¦
        function checkUserBanStatus(userId) {
            bannedUsersRef.child(userId).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const banInfo = snapshot.val();
                        console.log('ç”¨æˆ·å·²è¢«å°ç¦:', banInfo);
                        
                        // æ˜¾ç¤ºå°ç¦ç•Œé¢
                        showBannedUserScreen(banInfo);
                    }
                })
                .catch((error) => {
                    console.error('æ£€æŸ¥ç”¨æˆ·å°ç¦çŠ¶æ€å‡ºé”™:', error);
                });
        }
        
        // æ˜¾ç¤ºç”¨æˆ·è¢«å°ç¦ç•Œé¢
        function showBannedUserScreen(banInfo) {
            // åˆ›å»ºå°ç¦ç•Œé¢
            const bannedOverlay = document.createElement('div');
            bannedOverlay.className = 'banned-user-overlay';
            
            const banTitle = document.createElement('h2');
            banTitle.className = 'banned-user-title';
            banTitle.textContent = i18n[currentLang].userBanned;
            bannedOverlay.appendChild(banTitle);
            
            const banMessage = document.createElement('p');
            banMessage.className = 'banned-user-message';
            banMessage.textContent = banInfo.reason || i18n[currentLang].banReason;
            bannedOverlay.appendChild(banMessage);
            
            const banInfoElement = document.createElement('div');
            banInfoElement.className = 'banned-user-info';
            banInfoElement.innerHTML = `<p>${i18n[currentLang].contactAdmin}</p>`;
            if (banInfo.bannedBy) {
                banInfoElement.innerHTML += `<p>ç®¡ç†å‘˜: ${banInfo.bannedBy}</p>`;
            }
            if (banInfo.banTime) {
                banInfoElement.innerHTML += `<p>å°ç¦æ—¶é—´: ${new Date(banInfo.banTime).toLocaleString()}</p>`;
            }
            bannedOverlay.appendChild(banInfoElement);
            
            // æ·»åŠ ç™»å‡ºæŒ‰é’®
            const logoutBtn = document.createElement('button');
            logoutBtn.className = 'admin-button danger';
            logoutBtn.textContent = i18n[currentLang].logout;
            logoutBtn.addEventListener('click', function() {
                // æ¸…é™¤ç™»å½•çŠ¶æ€
                localStorage.removeItem('userLoggedIn');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('isGuestUser');
                localStorage.removeItem('guestId');
                
                // Firebaseç™»å‡º
                if (auth) {
                    auth.signOut().then(() => {
                        console.log('ç”¨æˆ·å·²ç™»å‡ºFirebase');
                    }).catch((error) => {
                        console.error('Firebaseç™»å‡ºé”™è¯¯:', error);
                    });
                }
                
                // é‡å®šå‘åˆ°ç™»å½•é¡µé¢
                window.location.href = 'login.html?logout=1';
            });
            bannedOverlay.appendChild(logoutBtn);
            
            // æ·»åŠ åˆ°body
            document.body.appendChild(bannedOverlay);
        }
        
        // åŠ è½½ç”¨æˆ·æŠ¥å‘Šè®¡æ•°
        function loadUserReportCount(userId) {
            if (!userId) return;
            
            userReportsCountRef.child(userId).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        userReportCount = snapshot.val();
                        console.log(`ç”¨æˆ·${userId}çš„æŠ¥å‘Šè®¡æ•°ä¸º:`, userReportCount);
                    } else {
                        userReportCount = 0;
                        console.log(`ç”¨æˆ·${userId}æ²¡æœ‰æŠ¥å‘Šè®°å½•ï¼Œåˆå§‹åŒ–è®¡æ•°ä¸º0`);
                    }
                })
                .catch((error) => {
                    console.error('åŠ è½½ç”¨æˆ·æŠ¥å‘Šè®¡æ•°å‡ºé”™:', error);
                    userReportCount = 0;
                });
        }
        
        // æ›´æ–°ç”¨æˆ·æŠ¥å‘Šè®¡æ•°
        function incrementUserReportCount() {
            if (!currentUserId) return;
            
            userReportCount++;
            
            userReportsCountRef.child(currentUserId).set(userReportCount)
                .then(() => {
                    console.log(`æ›´æ–°ç”¨æˆ·${currentUserId}çš„æŠ¥å‘Šè®¡æ•°ä¸º:`, userReportCount);
                    // æ˜¾ç¤ºæŠ¥å‘Šè®¡æ•°å™¨å¼¹çª—
                    showReportCounterPopup();
                })
                .catch((error) => {
                    console.error('æ›´æ–°ç”¨æˆ·æŠ¥å‘Šè®¡æ•°å‡ºé”™:', error);
                });
        }
        
        // æ˜¾ç¤ºæŠ¥å‘Šè®¡æ•°å™¨å¼¹çª—
        function showReportCounterPopup() {
            const popup = document.getElementById('reportCounterPopup');
            const countValueEl = document.getElementById('reportCountValue');
            
            // ç¡®ä¿å…ˆè·å–æœ€æ–°çš„ç”¨æˆ·æŠ¥å‘Šè®¡æ•°
            userReportsCountRef.child(currentUserId).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        userReportCount = snapshot.val();
                    }
                    
                    // æ›´æ–°å¼¹çª—æ–‡æœ¬
                    document.getElementById('reportSuccessTitle').textContent = i18n[currentLang].reportSuccess;
                    document.getElementById('reportCounterText').innerHTML = i18n[currentLang].reportCounterText.replace('{count}', '<span class="counter-value" id="reportCountValue">' + userReportCount + '</span>');
                    document.getElementById('closeCounterPopup').textContent = i18n[currentLang].closeButton;
                    
                    // è®¾ç½®è®¡æ•°å€¼
                    countValueEl.textContent = userReportCount;
                    
                    // æ˜¾ç¤ºå¼¹çª—
                    popup.style.display = 'block';
                })
                .catch((error) => {
                    console.error('è·å–ç”¨æˆ·æŠ¥å‘Šè®¡æ•°å‡ºé”™:', error);
                    popup.style.display = 'block';
                });
        }
        
        // å…³é—­æŠ¥å‘Šè®¡æ•°å™¨å¼¹çª—
        function closeReportCounterPopup() {
            const popup = document.getElementById('reportCounterPopup');
            popup.style.display = 'none';
        }
        
        // æ·»åŠ æ–°æŠ¥å‘Š
        function addNewReport(description, image, lat, lng) {
            if (!currentUserId) {
                console.error("æœªæ‰¾åˆ°ç”¨æˆ·IDï¼Œæ— æ³•æäº¤æŠ¥å‘Š");
                return;
            }
            
            const newReport = {
                id: Date.now(), // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºID
                lat: lat,
                lng: lng,
                description: description,
                time: new Date().toISOString(),
                image: image,
                emoji: "ğŸ¶", // é»˜è®¤emoji
                comments: [],
                userId: currentUserId,
                userName: document.getElementById('userDisplayName').textContent || (currentLang === 'zh' ? 'ç”¨æˆ·' : 'User'),
                originalDescription: description // ä¿å­˜åŸå§‹æè¿°
            };
            
            // æ ¹æ®æè¿°é€‰æ‹©è¡¨æƒ…
            if (description && (description.toLowerCase().includes('dog') || description.toLowerCase().includes('ç‹—'))) {
                newReport.emoji = "ğŸ¶";
            } else if (description && (description.toLowerCase().includes('traffic') || description.toLowerCase().includes('äº¤é€š'))) {
                newReport.emoji = "ğŸš—";
            } else if (description && (description.toLowerCase().includes('food') || description.toLowerCase().includes('é¤'))) {
                newReport.emoji = "ğŸ”";
            } else if (description && (description.toLowerCase().includes('event') || description.toLowerCase().includes('æ´»åŠ¨'))) {
                newReport.emoji = "ğŸª";
            }
            
            // ä¿å­˜åˆ°Firebase
            reportsRef.child(newReport.id.toString()).set(newReport)
                .then(() => {
                    console.log("Report successfully saved to Firebase", newReport);
                    // å…³é—­æŠ¥å‘Šè¡¨å•
                    closeReportForm();
                    // é‡ç½®è¡¨å•
                    resetReportForm();
                    
                    // ç§»é™¤ä¸´æ—¶é€‰ç‚¹æ ‡è®°ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (selectionMarker) {
                        selectionMarker.setMap(null);
                        selectionMarker = null;
                    }
                    
                    // å¢åŠ ç”¨æˆ·æŠ¥å‘Šè®¡æ•°
                    incrementUserReportCount();
                })
                .catch((error) => {
                    console.error("Error saving report to Firebase:", error);
                    alert("æäº¤æŠ¥å‘Šå¤±è´¥: " + error.message);
                });
        }
        
        // æ‰“å¼€æŠ¥å‘Šè¡¨å•
        function openReportForm() {
            const reportForm = document.getElementById('reportForm');
            reportForm.classList.add('active');
            reportForm.style.transform = 'translateY(0)';
        }
        
        // å…³é—­æŠ¥å‘Šè¡¨å•
        function closeReportForm() {
            document.getElementById('reportForm').style.transform = 'translateY(100%)';
            document.getElementById('descriptionInput').value = '';
            document.getElementById('imageInput').value = '';
            document.getElementById('previewImg').style.display = 'none';
            document.getElementById('imagePlaceholder').style.display = 'block';
            
            // ç¡®ä¿çŠ¶æ€æç¤ºä¹Ÿè¢«éšè—
            document.getElementById('geocodeStatus').style.display = 'none';
            
            // å¦‚æœå­˜åœ¨é€‰ç‚¹æ ‡è®°ï¼Œåœ¨è¡¨å•å…³é—­æ—¶ä¸è¦æ¸…é™¤ï¼Œç­‰åˆ°æŠ¥å‘Šæäº¤æˆ–å–æ¶ˆé€‰ç‚¹æ—¶å†æ¸…é™¤
        }
        
        // é‡ç½®æŠ¥å‘Šè¡¨å•
        function resetReportForm() {
            document.getElementById('descriptionInput').value = '';
            document.getElementById('previewImg').style.display = 'none';
            document.getElementById('imagePlaceholder').style.display = 'block';
            document.getElementById('imageInput').value = '';
        }
        
        // æ›´æ–°ç”¨æˆ·èœå•æ˜¾ç¤º
        function updateUserMenu(user) {
            const userMenu = document.getElementById('userMenu');
            const userDisplayName = document.getElementById('userDisplayName');
            const profileMenuItem = document.getElementById('profileMenuItem');
            const logoutMenuItem = document.getElementById('logoutMenuItem');
            
            if (user) {
                // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·åï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é‚®ç®±
                const displayName = user.displayName || user.email || (currentLang === 'zh' ? 'ç”¨æˆ·' : 'User');
                userDisplayName.textContent = displayName.split('@')[0]; // åªæ˜¾ç¤º@å‰é¢çš„éƒ¨åˆ†
                userMenu.style.display = 'flex';
                
                // æ›´æ–°èœå•é¡¹æ–‡æœ¬
                profileMenuItem.textContent = i18n[currentLang].profile;
                logoutMenuItem.textContent = i18n[currentLang].logout;
            } else {
                userMenu.style.display = 'none';
            }
        }
        
        // å¤„ç†åœ°å›¾ç‚¹å‡»äº‹ä»¶ - é€‰æ‹©æŠ¥å‘Šä½ç½®
        function handleMapClick(latLng) {
            if (!isSelectingLocation) return;
            
            selectedLocation = {
                lat: latLng.lat,
                lng: latLng.lng
            };
            
            // æ·»åŠ é€‰ç‚¹æ ‡è®°ï¼ˆä¼ å…¥falseè¡¨ç¤ºè¿™æ˜¯æ‰‹åŠ¨é€‰ç‚¹ï¼‰
            addSelectionMarker(selectedLocation, false);
            
            // é‡ç½®é€‰æ‹©æ¨¡å¼
            isSelectingLocation = false;
            document.getElementById('addReportTip').style.display = 'none';
            document.getElementById('addReportBtn').textContent = i18n[currentLang].addReport;
            document.body.style.cursor = '';
            
            // æ‰“å¼€æŠ¥å‘Šè¡¨å•
            openReportForm();
        }
        
        // åœ°å›¾å˜é‡
        var map;
        var markers = [];
        
        // å¢¨å°”æœ¬ä¸­å¿ƒåæ ‡
        const MELBOURNE_CENTER = { lat: -37.8136, lng: 144.9631 };
        
        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            console.log("initMapè¢«è°ƒç”¨ï¼Œåˆå§‹åŒ–åœ°å›¾...");
            
            // åˆ›å»ºåœ°å›¾
            try {
                map = new google.maps.Map(document.getElementById("map"), {
                    center: MELBOURNE_CENTER,
                    zoom: 13,
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                });
                
                // æ·»åŠ åœ°å›¾ç‚¹å‡»äº‹ä»¶
                map.addListener("click", (event) => {
                    if (isSelectingLocation) {
                        // æ·»åŠ ä¸´æ—¶é€‰ç‚¹æ ‡è®°åŠ¨ç”»æ•ˆæœ
                        addSelectionMarker({
                            lat: event.latLng.lat(),
                            lng: event.latLng.lng()
                        });
                        
                        handleMapClick({
                            lat: event.latLng.lat(),
                            lng: event.latLng.lng()
                        });
                    }
                });
                
                // ç¡®ä¿å…³é”®å˜é‡å·²æ­£ç¡®è®¾ç½®
                console.log("å­˜å‚¨ç³»ç»Ÿé…ç½®æ£€æŸ¥:");
                console.log("- useCloudflare =", useCloudflare);
                console.log("- syncToCloudflare =", syncToCloudflare);
                console.log("- cloudflareConfig =", cloudflareConfig);
                
                // åŠ è½½æŠ¥å‘Š
                console.log("å°è¯•åŠ è½½æŠ¥å‘Šæ•°æ®...");
                try {
                    if (useCloudflare) {
                        console.log("ä»CloudflareåŠ è½½æ ‡è®°æ•°æ®");
                        // é¦–å…ˆå°è¯•ä»CloudflareåŠ è½½
                        loadReportsFromCloudflare();
                        
                        // å¦‚æœ10ç§’åæ ‡è®°æ•°é‡ä¸º0ï¼Œå°è¯•ä»FirebaseåŠ è½½
                        setTimeout(() => {
                            if (markers.length === 0) {
                                console.log("CloudflareåŠ è½½è¶…æ—¶æˆ–æ— ç»“æœï¼Œå°è¯•ä»FirebaseåŠ è½½æ•°æ®...");
                                loadReportsDirectlyFromFirebase();
                            }
                        }, 10000);
                    } else {
                        console.log("ä»FirebaseåŠ è½½æ ‡è®°æ•°æ®");
                        loadReportsFromFirebase();
                    }
                } catch (dataError) {
                    console.error("åŠ è½½æŠ¥å‘Šæ•°æ®æ—¶å‡ºé”™:", dataError);
                    
                    // é”™è¯¯å¤„ç† - å°è¯•å›é€€æ–¹å¼åŠ è½½
                    setTimeout(() => {
                        try {
                            console.log("ä½¿ç”¨å›é€€æ–¹å¼åŠ è½½æŠ¥å‘Šæ•°æ®...");
                            loadReportsDirectlyFromFirebase();
                        } catch (fallbackError) {
                            console.error("å›é€€åŠ è½½ä¹Ÿå¤±è´¥:", fallbackError);
                            sendDanmaku(currentLang === 'zh' ? 
                                'æ— æ³•åŠ è½½æŠ¥å‘Šæ•°æ®ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•' : 
                                'Failed to load report data, please refresh'
                            );
                        }
                    }, 2000);
                }
                
                console.log("åœ°å›¾åˆå§‹åŒ–å®Œæˆ!");
            } catch (error) {
                console.error("åœ°å›¾åˆå§‹åŒ–å¤±è´¥:", error);
                // æ˜¾ç¤ºé”™è¯¯ç»™ç”¨æˆ·
                sendDanmaku(currentLang === 'zh' ? 
                    'åœ°å›¾åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢' : 
                    'Map initialization failed, please refresh'
                );
            }
        }
        
        // æ·»åŠ formatTimeAgoå‡½æ•°çš„å®šä¹‰ï¼Œæ”¾åœ¨è„šæœ¬çš„æ—©æœŸä½ç½®
        // (åœ¨ä»»ä½•åœ°å›¾ç›¸å…³å‡½æ•°ä¹‹å‰)
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            
            if (diffMin < 1) {
                return 'åˆšåˆš';
            } else if (diffMin < 60) {
                return `${diffMin}åˆ†é’Ÿå‰`;
            } else if (diffHour < 24) {
                return `${diffHour}å°æ—¶å‰`;
            } else {
                return date.toLocaleString('zh-CN', {
                    month: 'numeric',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }
        
        // æ›´æ–°æ ‡è®°åˆ›å»ºä»£ç ï¼Œä½¿ç”¨ä¼ ç»ŸMarker
        function addSelectionMarker(location, isFromGeocoding = false) {
            try {
                // ç§»é™¤æ—§æ ‡è®°ï¼ˆå¦‚æœæœ‰ï¼‰
                if (selectionMarker) {
                    selectionMarker.setMap(null);
                }
                
                // åˆ›å»ºæ ‡è®°å›¾æ ‡
                const markerIcon = {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                        `<svg xmlns="http://www.w3.org/2000/svg" width="42" height="42" viewBox="0 0 42 42">
                            <circle cx="21" cy="21" r="20" fill="white" opacity="0.95"/>
                            <text x="21" y="29" font-size="24" text-anchor="middle" fill="${isFromGeocoding ? '#0077cc' : '#ff3b30'}">${isFromGeocoding ? 'ğŸ”' : 'ğŸ“'}</text>
                        </svg>`
                    ),
                    scaledSize: new google.maps.Size(42, 42),
                    anchor: new google.maps.Point(21, 21)
                };
                
                // åˆ›å»ºä¼ ç»ŸMarker
                selectionMarker = new google.maps.Marker({
                    position: location,
                    map: map,
                    icon: markerIcon,
                    zIndex: 1000
                });
                
                // åœ¨æ ‡è®°å‘¨å›´æ·»åŠ ä¸€ä¸ªåœ†åœˆæ¥å¢å¼ºå¯è§æ€§
                if (!selectionCircle) {
                    selectionCircle = new google.maps.Circle({
                        map: map,
                        center: location,
                        radius: 50, // 50ç±³åŠå¾„
                        strokeColor: isFromGeocoding ? "#0077cc" : "#ff3b30",
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: isFromGeocoding ? "#0077cc" : "#ff3b30",
                        fillOpacity: 0.1,
                        zIndex: 999
                    });
                } else {
                    selectionCircle.setCenter(location);
                    selectionCircle.setMap(map);
                    selectionCircle.setOptions({
                        strokeColor: isFromGeocoding ? "#0077cc" : "#ff3b30",
                        fillColor: isFromGeocoding ? "#0077cc" : "#ff3b30"
                    });
                }
                
                // ç§»åŠ¨åœ°å›¾åˆ°æ ‡è®°ä½ç½®
                map.panTo(location);
            } catch (error) {
                console.error("æ·»åŠ é€‰æ‹©æ ‡è®°æ—¶å‡ºé”™:", error);
                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ç»™ç”¨æˆ·
                sendDanmaku(currentLang === 'zh' ? 
                    'æ·»åŠ æ ‡è®°å¤±è´¥ï¼Œè¯·é‡è¯•' : 
                    'Failed to add marker, please try again'
                );
            }
        }
        
        // ä»FirebaseåŠ è½½æŠ¥å‘Šæ•°æ®
        function loadReportsFromFirebase() {
            console.log("å¼€å§‹ä»Firebaseç›´æ¥åŠ è½½æ•°æ®...");
            
            // å¦‚æœä½¿ç”¨Cloudflare Workersï¼Œä»é‚£é‡Œè·å–æ•°æ®
            if (useCloudflare) {
                console.log("é…ç½®ä¸ºä½¿ç”¨Cloudflareï¼Œè½¬å‘loadReportsFromCloudflare()");
                loadReportsFromCloudflare();
                return;
            }
            
            // æ¸…é™¤ç°æœ‰æ ‡è®°
            markers.forEach(marker => {
                marker.setMap(null);
            });
            markers = [];
            
            console.log("å°è¯•è¿æ¥Firebaseæ•°æ®åº“...");
            
            // æ·»åŠ é‡è¯•å’Œé”™è¯¯æ¢å¤é€»è¾‘
            let retryCount = 0;
            const maxRetries = 3;
            const retryDelay = 2000; // 2ç§’å»¶è¿Ÿ
            
            function attemptLoadReports() {
                // æ·»åŠ è¶…æ—¶å¤„ç†
                let timeoutId = setTimeout(() => {
                    console.error(`Firebaseæ•°æ®åŠ è½½è¶…æ—¶(15ç§’)ï¼Œå½“å‰å°è¯•æ¬¡æ•°: ${retryCount+1}/${maxRetries}`);
                    if (retryCount < maxRetries - 1) {
                        retryCount++;
                        sendDanmaku(`FirebaseåŠ è½½è¶…æ—¶ï¼Œç¬¬${retryCount}æ¬¡é‡è¯•ä¸­...`);
                        setTimeout(attemptLoadReports, retryDelay);
                    } else {
                        sendDanmaku('Firebaseè¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åˆ·æ–°é¡µé¢');
                        // å°è¯•ä»localStorageæ¢å¤ç¼“å­˜çš„æ•°æ®
                        tryLoadCachedReports();
                    }
                }, 15000);
                
                try {
                    // ä½¿ç”¨onceè€Œä¸æ˜¯onï¼Œé¿å…æŒç»­ç›‘å¬
                    // æ·»åŠ æŸ¥è¯¢é™åˆ¶ï¼Œåªè·å–æœ€è¿‘3å°æ—¶çš„æ•°æ®
                    const now = new Date();
                    const threeHoursAgo = new Date(now.getTime() - (3 * 60 * 60 * 1000));
                    const cutoffTime = threeHoursAgo.toISOString();
                    
                    // ä¼˜åŒ–æŸ¥è¯¢ä»¥å‡å°‘æ•°æ®ä¼ è¾“é‡
                    reportsRef.orderByChild('time').startAt(cutoffTime)
                        .once('value')
                        .then(snapshot => {
                            clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶
                            
                            console.log("Firebaseæ•°æ®åº“å“åº”:", snapshot.exists() ? "æœ‰æ•°æ®" : "æ— æ•°æ®");
                            
                            if (snapshot.exists()) {
                                const reports = [];
                                let markersAdded = 0;
                                
                                snapshot.forEach(childSnapshot => {
                                    const report = childSnapshot.val();
                                    if (report && report.id) {
                                        reports.push(report);
                                        const markerAdded = addReportMarker(report);
                                        if (markerAdded) markersAdded++;
                                        
                                        // ç¼“å­˜æŠ¥å‘Šä»¥ä¾¿ç¦»çº¿ä½¿ç”¨
                                        cacheReportLocally(report);
                                    }
                                });
                                
                                console.log(`æˆåŠŸä»FirebaseåŠ è½½äº†${reports.length}ä¸ªæŠ¥å‘Šï¼Œæ˜¾ç¤ºäº†${markersAdded}ä¸ªæ ‡è®°`);
                                sendDanmaku(`å·²ä»FirebaseåŠ è½½${markersAdded}ä¸ªæŠ¥å‘Š`);
                                
                                // å¦‚æœæ²¡æœ‰åŠ è½½åˆ°æŠ¥å‘Šï¼Œæ˜¾ç¤ºæç¤º
                                if (markersAdded === 0) {
                                    console.log("æ²¡æœ‰æ˜¾ç¤ºç¬¦åˆæ¡ä»¶çš„æŠ¥å‘Š");
                                    sendDanmaku('æ²¡æœ‰æœ€è¿‘çš„æŠ¥å‘Šæ•°æ®');
                                }
                            } else {
                                console.log("Firebaseæ•°æ®åº“ä¸­æ²¡æœ‰æŠ¥å‘Šæ•°æ®");
                                sendDanmaku('Firebaseä¸­æ²¡æœ‰æ•°æ®');
                            }
                        })
                        .catch(error => {
                            clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶
                            console.error("ä»FirebaseåŠ è½½æ•°æ®å‡ºé”™:", error);
                            
                            if (retryCount < maxRetries - 1) {
                                retryCount++;
                                console.log(`å°è¯•ç¬¬${retryCount}æ¬¡é‡æ–°åŠ è½½...`);
                                sendDanmaku(`åŠ è½½å¤±è´¥ï¼Œç¬¬${retryCount}æ¬¡é‡è¯•ä¸­...`);
                                setTimeout(attemptLoadReports, retryDelay);
                            } else {
                                sendDanmaku('å¤šæ¬¡åŠ è½½å°è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åˆ·æ–°é¡µé¢');
                                // å°è¯•ä»ç¼“å­˜æ¢å¤
                                tryLoadCachedReports();
                            }
                        });
                } catch (error) {
                    clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶
                    console.error("FirebaseåŠ è½½è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸:", error);
                    
                    if (retryCount < maxRetries - 1) {
                        retryCount++;
                        console.log(`å°è¯•ç¬¬${retryCount}æ¬¡é‡æ–°åŠ è½½...`);
                        sendDanmaku(`åŠ è½½å¼‚å¸¸ï¼Œç¬¬${retryCount}æ¬¡é‡è¯•ä¸­...`);
                        setTimeout(attemptLoadReports, retryDelay);
                    } else {
                        sendDanmaku('Firebaseè¿æ¥å¼‚å¸¸ï¼Œå°è¯•ä½¿ç”¨æœ¬åœ°ç¼“å­˜');
                        // å°è¯•ä»ç¼“å­˜æ¢å¤
                        tryLoadCachedReports();
                    }
                }
            }
            
            // ä»æœ¬åœ°ç¼“å­˜åŠ è½½æŠ¥å‘Š
            function tryLoadCachedReports() {
                console.log("å°è¯•ä»æœ¬åœ°ç¼“å­˜åŠ è½½æŠ¥å‘Šæ•°æ®...");
                
                try {
                    const cachedReports = localStorage.getItem('cached_reports');
                    if (cachedReports) {
                        const reports = JSON.parse(cachedReports);
                        if (Array.isArray(reports) && reports.length > 0) {
                            let markersAdded = 0;
                            reports.forEach(report => {
                                if (report && report.id) {
                                    const markerAdded = addReportMarker(report);
                                    if (markerAdded) markersAdded++;
                                }
                            });
                            
                            console.log(`ä»ç¼“å­˜åŠ è½½äº†${markersAdded}ä¸ªæŠ¥å‘Š`);
                            sendDanmaku(`ä»æœ¬åœ°ç¼“å­˜åŠ è½½äº†${markersAdded}ä¸ªæŠ¥å‘Š`);
                            return;
                        }
                    }
                    
                    console.log("æœ¬åœ°ç¼“å­˜ä¸­æ²¡æœ‰å¯ç”¨çš„æŠ¥å‘Šæ•°æ®");
                    sendDanmaku('æ— æ³•åŠ è½½æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•');
                } catch (error) {
                    console.error("ä»ç¼“å­˜åŠ è½½æŠ¥å‘Šå¤±è´¥:", error);
                    sendDanmaku('æœ¬åœ°ç¼“å­˜è¯»å–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
                }
            }
            
            // ç¼“å­˜æŠ¥å‘Šåˆ°æœ¬åœ°å­˜å‚¨
            function cacheReportLocally(report) {
                try {
                    // è·å–ç°æœ‰ç¼“å­˜
                    let cachedReports = [];
                    const cachedData = localStorage.getItem('cached_reports');
                    if (cachedData) {
                        cachedReports = JSON.parse(cachedData);
                    }
                    
                    // æ£€æŸ¥æŠ¥å‘Šæ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™æ›´æ–°
                    const existingIndex = cachedReports.findIndex(r => r.id === report.id);
                    if (existingIndex !== -1) {
                        cachedReports[existingIndex] = report;
                    } else {
                        cachedReports.push(report);
                    }
                    
                    // åªä¿ç•™æœ€è¿‘çš„50ä¸ªæŠ¥å‘Šï¼Œé¿å…å­˜å‚¨ç©ºé—´è¿‡å¤§
                    if (cachedReports.length > 50) {
                        cachedReports.sort((a, b) => new Date(b.time) - new Date(a.time));
                        cachedReports = cachedReports.slice(0, 50);
                    }
                    
                    // ä¿å­˜å›æœ¬åœ°å­˜å‚¨
                    localStorage.setItem('cached_reports', JSON.stringify(cachedReports));
                } catch (error) {
                    console.error("ç¼“å­˜æŠ¥å‘Šåˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:", error);
                }
            }
            
            // å¼€å§‹å°è¯•åŠ è½½
            attemptLoadReports();
        }
        
        // ä»Cloudflare WorkersåŠ è½½æŠ¥å‘Šæ•°æ®
        function loadReportsFromCloudflare() {
            console.log("å°è¯•ä»CloudflareåŠ è½½æŠ¥å‘Šæ•°æ®...");
            fetch(`${cloudflareConfig.apiUrl}${cloudflareConfig.dataEndpoint}`)
                .then(response => {
                    console.log("Cloudflare APIå“åº”çŠ¶æ€:", response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("ä»Cloudflareè·å–çš„æ•°æ®:", data);
                    
                    // æ¸…é™¤ç°æœ‰æ ‡è®°
                    markers.forEach(marker => {
                        marker.setMap(null);
                    });
                    markers = [];
                    
                    // è¿™é‡Œæ ¹æ®å®é™…APIå“åº”ç»“æ„è¿›è¡Œè°ƒæ•´
                    // æœ‰äº›APIè¿”å›{markers:[...]}ï¼Œæœ‰äº›ç›´æ¥è¿”å›[...]
                    const reportsList = data.markers || data.reports || data;
                    
                    if (reportsList && Array.isArray(reportsList) && reportsList.length > 0) {
                        reportsList.forEach(report => {
                            if (report && report.id) {
                                addReportMarker(report);
                            }
                        });
                        console.log("Reports loaded from Cloudflare:", markers.length);
                        
                        // æ˜¾ç¤ºåŠ è½½æˆåŠŸæ¶ˆæ¯
                        sendDanmaku(currentLang === 'zh' ? 
                            `å·²ä»CloudflareåŠ è½½${markers.length}ä¸ªæ ‡è®°` : 
                            `Loaded ${markers.length} markers from Cloudflare`
                        );
                    } else {
                        // å¦‚æœCloudflareæ²¡æœ‰æ•°æ®æˆ–æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œå›é€€åˆ°Firebase
                        console.log("Cloudflareæ²¡æœ‰è¿”å›æœ‰æ•ˆæ•°æ®ï¼Œå›é€€åˆ°Firebase");
                        sendDanmaku(currentLang === 'zh' ? 
                            'ä»CloudflareåŠ è½½å¤±è´¥ï¼Œå°è¯•Firebase' : 
                            'Failed to load from Cloudflare, trying Firebase'
                        );
                        loadReportsDirectlyFromFirebase();
                    }
                })
                .catch(error => {
                    console.error("ä»CloudflareåŠ è½½æŠ¥å‘Šæ—¶å‡ºé”™:", error);
                    sendDanmaku(currentLang === 'zh' ? 
                        'Cloudflareè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨Firebase' : 
                        'Cloudflare connection failed, using Firebase'
                    );
                    // é”™è¯¯æ—¶å›é€€åˆ°Firebase
                    loadReportsDirectlyFromFirebase();
                });
        }
        
        // ç›´æ¥ä»FirebaseåŠ è½½æŠ¥å‘Šæ•°æ®ï¼ˆä½œä¸ºå›é€€ï¼‰
        function loadReportsDirectlyFromFirebase() {
            console.log("ç›´æ¥ä»FirebaseåŠ è½½æŠ¥å‘Šæ•°æ®ï¼ˆå›é€€æ¨¡å¼ï¼‰");
            
            reportsRef.once('value')
                .then((snapshot) => {
                    // æ¸…é™¤ç°æœ‰æ ‡è®°
                    markers.forEach(marker => {
                        marker.setMap(null);
                    });
                    markers = [];
                    
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const report = childSnapshot.val();
                            if (report && report.id) {
                                addReportMarker(report);
                            }
                        });
                    }
                    
                    console.log("Reports loaded from Firebase fallback:", markers.length);
                    
                    // æ˜¾ç¤ºåŠ è½½æˆåŠŸæ¶ˆæ¯
                    sendDanmaku(currentLang === 'zh' ? 
                        `å·²ä»FirebaseåŠ è½½${markers.length}ä¸ªæ ‡è®°` : 
                        `Loaded ${markers.length} markers from Firebase`
                    );
                })
                .catch(error => {
                    console.error("ä»FirebaseåŠ è½½æŠ¥å‘Šæ—¶å‡ºé”™:", error);
                    sendDanmaku(currentLang === 'zh' ? 
                        'æ— æ³•åŠ è½½æŠ¥å‘Šæ•°æ®' : 
                        'Unable to load report data'
                    );
                });
        }
        
        // æ·»åŠ æŠ¥å‘Šæ ‡è®°åˆ°åœ°å›¾
        function addReportMarker(report) {
            if (!map) return;
            
            const now = new Date();
            const reportTime = new Date(report.time);
            const reportAgeHours = (now - reportTime) / (1000 * 60 * 60);
            
            // è·³è¿‡è¶…è¿‡3å°æ—¶çš„æŠ¥å‘Š
            if (reportAgeHours > 3) {
                console.log(`Report ID ${report.id} is older than 3 hours, not displaying`);
                return;
            }
            
            return addReportMarkerToMap(report);
        }
        
        // å¿«é€ŸæŠ¥å‘Šå‡½æ•°ä¿®æ”¹
        function addQuickReport(location, description, emoji) {
            const now = new Date();
            const reportId = Date.now().toString();
            
            // åˆ›å»ºæŠ¥å‘Šæ•°æ®å¯¹è±¡
            const reportData = {
                id: reportId,
                lat: location.lat,
                lng: location.lng,
                description: description,
                originalDescription: description,
                emoji: emoji,
                time: now.toISOString(),
                userId: currentUserId || 'anonymous'
            };
            
            // åˆ›å»ºæ ‡è®°
            const marker = addReportMarkerToMap(reportData);
            
            // ä¿å­˜æ•°æ®åˆ°æœåŠ¡åŠ¡å™¨
            if (useCloudflare) {
                saveReportToCloudflare(reportData);
            } else {
                saveReportToFirebase(reportData);
            }
            
            return marker;
        }
        
        // ä¿å­˜æŠ¥å‘Šåˆ°Firebase
        function saveReportToFirebase(reportData) {
            if (!reportData || !reportData.id) {
                console.error("æ— æ•ˆçš„æŠ¥å‘Šæ•°æ®ï¼Œæ— æ³•ä¿å­˜åˆ°Firebase");
                sendDanmaku("æŠ¥å‘Šæ•°æ®æ— æ•ˆï¼Œæ— æ³•ä¿å­˜");
                return Promise.reject(new Error("æ— æ•ˆçš„æŠ¥å‘Šæ•°æ®"));
            }
            
            console.log("å°è¯•ä¿å­˜æŠ¥å‘Šåˆ°Firebase:", reportData.id);
            
            // å®ç°Promiseä»¥å…è®¸é”™è¯¯å¤„ç†å’Œé‡è¯•
            return new Promise((resolve, reject) => {
                // æ·»åŠ é‡è¯•é€»è¾‘
                let retryCount = 0;
                const maxRetries = 3;
                const retryDelay = 1500; // 1.5ç§’å»¶è¿Ÿ
                
                // è¶…æ—¶å¤„ç†
                const timeoutMs = 10000; // 10ç§’è¶…æ—¶
                
                function attemptSave() {
                    const timeoutId = setTimeout(() => {
                        console.error(`ä¿å­˜åˆ°Firebaseè¶…æ—¶(${timeoutMs}ms)`);
                        if (retryCount < maxRetries) {
                            retryCount++;
                            console.log(`é‡è¯•ä¿å­˜(${retryCount}/${maxRetries})...`);
                            sendDanmaku(`ä¿å­˜è¶…æ—¶ï¼Œæ­£åœ¨é‡è¯•(${retryCount}/${maxRetries})...`);
                            setTimeout(attemptSave, retryDelay);
                        } else {
                            // è¶…å‡ºé‡è¯•æ¬¡æ•°ï¼Œä¿å­˜å¤±è´¥
                            reject(new Error("ä¿å­˜è¶…æ—¶ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"));
                            // å°è¯•ä¿å­˜åˆ°æœ¬åœ°æš‚å­˜
                            saveToLocalStorage(reportData);
                        }
                    }, timeoutMs);
                    
                    try {
                        // æ£€æŸ¥Firebaseè¿æ¥
                        const connectedRef = firebase.database().ref(".info/connected");
                        connectedRef.once("value", (snap) => {
                            if (snap.val() === true) {
                                console.log("Firebaseè¿æ¥æ­£å¸¸ï¼Œå¼€å§‹ä¿å­˜æ•°æ®");
                                
                                // æ·»åŠ æ—¶é—´æˆ³å’Œå…ƒæ•°æ®
                                const enhancedReport = {
                                    ...reportData,
                                    savedAt: firebase.database.ServerValue.TIMESTAMP,
                                    clientInfo: {
                                        platform: navigator.platform,
                                        userAgent: navigator.userAgent,
                                        saveTimeLocal: new Date().toISOString()
                                    },
                                    // è®°å½•é‡è¯•æ¬¡æ•°ï¼Œç”¨äºåˆ†æ
                                    retryAttempt: retryCount
                                };
                                
                                // ä¿å­˜æ•°æ®
                                reportsRef.child(reportData.id.toString()).set(enhancedReport)
                                    .then(() => {
                                        clearTimeout(timeoutId);
                                        console.log("æŠ¥å‘ŠæˆåŠŸä¿å­˜åˆ°Firebase:", reportData.id);
                                        sendDanmaku("æŠ¥å‘Šå·²ä¿å­˜");
                                        
                                        // å¢åŠ ç”¨æˆ·æŠ¥å‘Šè®¡æ•°
                                        incrementUserReportCount();
                                        
                                        // å¦‚æœè®¾ç½®äº†åŒæ­¥é€‰é¡¹ï¼Œå°†æ•°æ®åŒæ­¥åˆ°Cloudflare
                                        if (syncToCloudflare && !useCloudflare) {
                                            syncReportToCloudflare(enhancedReport)
                                                .then(syncResult => {
                                                    console.log("åŒæ­¥åˆ°CloudflareæˆåŠŸ:", syncResult);
                                                })
                                                .catch(syncError => {
                                                    console.error("åŒæ­¥åˆ°Cloudflareå¤±è´¥:", syncError);
                                                });
                                        }
                                        
                                        // ç¼“å­˜åˆ°localStorage
                                        cacheReportLocally(enhancedReport);
                                        
                                        resolve(enhancedReport);
                                    })
                                    .catch((error) => {
                                        clearTimeout(timeoutId);
                                        console.error("ä¿å­˜æŠ¥å‘Šåˆ°Firebaseå¤±è´¥:", error);
                                        
                                        if (retryCount < maxRetries) {
                                            retryCount++;
                                            console.log(`é‡è¯•ä¿å­˜(${retryCount}/${maxRetries})...`);
                                            sendDanmaku(`ä¿å­˜å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•(${retryCount}/${maxRetries})...`);
                                            setTimeout(attemptSave, retryDelay);
                                        } else {
                                            sendDanmaku("ä¿å­˜æŠ¥å‘Šå¤±è´¥ï¼Œæ­£åœ¨å°è¯•å¤‡ç”¨æ–¹æ³•");
                                            // æœ€åå°è¯•ä¿å­˜åˆ°localStorage
                                            saveToLocalStorage(reportData);
                                            reject(error);
                                        }
                                    });
                            } else {
                                // Firebaseè¿æ¥å¤±è´¥
                                clearTimeout(timeoutId);
                                console.error("Firebaseè¿æ¥æ–­å¼€ï¼Œæ— æ³•ä¿å­˜æ•°æ®");
                                
                                if (retryCount < maxRetries) {
                                    retryCount++;
                                    console.log(`ç­‰å¾…è¿æ¥æ¢å¤åé‡è¯•(${retryCount}/${maxRetries})...`);
                                    sendDanmaku(`è¿æ¥æ–­å¼€ï¼Œç­‰å¾…æ¢å¤åé‡è¯•(${retryCount}/${maxRetries})...`);
                                    setTimeout(attemptSave, retryDelay * 2); // è¿æ¥é—®é¢˜éœ€è¦æ›´é•¿æ—¶é—´ç­‰å¾…
                                } else {
                                    sendDanmaku("æ— æ³•è¿æ¥Firebaseï¼Œä¿å­˜åˆ°æœ¬åœ°");
                                    // ä¿å­˜åˆ°localStorage
                                    saveToLocalStorage(reportData);
                                    reject(new Error("Firebaseè¿æ¥æ–­å¼€ï¼Œæ— æ³•ä¿å­˜æ•°æ®"));
                                }
                            }
                        });
                    } catch (error) {
                        clearTimeout(timeoutId);
                        console.error("ä¿å­˜æŠ¥å‘Šåˆ°Firebaseæ—¶å‡ºç°å¼‚å¸¸:", error);
                        
                        if (retryCount < maxRetries) {
                            retryCount++;
                            console.log(`å‡ºç°å¼‚å¸¸ï¼Œé‡è¯•(${retryCount}/${maxRetries})...`);
                            sendDanmaku(`ä¿å­˜æ—¶å‡ºé”™ï¼Œæ­£åœ¨é‡è¯•(${retryCount}/${maxRetries})...`);
                            setTimeout(attemptSave, retryDelay);
                        } else {
                            sendDanmaku("ä¿å­˜æ—¶å‡ºé”™ï¼Œå·²ä¿å­˜åˆ°æœ¬åœ°");
                            // å°è¯•ä¿å­˜åˆ°localStorage
                            saveToLocalStorage(reportData);
                            reject(error);
                        }
                    }
                }
                
                // é¦–æ¬¡å°è¯•ä¿å­˜
                attemptSave();
            });
            
            // ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½
            function saveToLocalStorage(report) {
                try {
                    // è·å–ç°æœ‰çš„å¾…å‘é€æŠ¥å‘Š
                    let pendingReports = [];
                    const pendingData = localStorage.getItem('pending_reports');
                    if (pendingData) {
                        pendingReports = JSON.parse(pendingData);
                    }
                    
                    // æ·»åŠ å½“å‰æŠ¥å‘Šåˆ°å¾…å‘é€åˆ—è¡¨
                    pendingReports.push({
                        ...report,
                        pendingSince: new Date().toISOString()
                    });
                    
                    // é™åˆ¶æœ€å¤§å¾…å‘é€æ•°é‡
                    if (pendingReports.length > 20) {
                        pendingReports = pendingReports.slice(-20); // åªä¿ç•™æœ€æ–°çš„20æ¡
                    }
                    
                    // ä¿å­˜å›localStorage
                    localStorage.setItem('pending_reports', JSON.stringify(pendingReports));
                    console.log(`æŠ¥å‘Šå·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œç­‰å¾…ç¨ååŒæ­¥ï¼Œå½“å‰å¾…å‘é€: ${pendingReports.length}æ¡`);
                    sendDanmaku("æŠ¥å‘Šå·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œå°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥");
                    
                    // å®šæœŸå°è¯•å‘é€å¾…å‘é€çš„æŠ¥å‘Š
                    if (!window._pendingSyncInterval) {
                        window._pendingSyncInterval = setInterval(syncPendingReports, 60000); // æ¯åˆ†é’Ÿå°è¯•åŒæ­¥ä¸€æ¬¡
                    }
                } catch (error) {
                    console.error("ä¿å­˜æŠ¥å‘Šåˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥:", error);
                    sendDanmaku("ä¿å­˜åˆ°æœ¬åœ°ä¹Ÿå¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å­˜å‚¨ç©ºé—´");
                }
            }
        }
        
        // åŒæ­¥å¾…å‘é€çš„æŠ¥å‘Š
        function syncPendingReports() {
            try {
                const pendingData = localStorage.getItem('pending_reports');
                if (!pendingData) return;
                
                const pendingReports = JSON.parse(pendingData);
                if (!pendingReports || pendingReports.length === 0) return;
                
                console.log(`å°è¯•åŒæ­¥${pendingReports.length}æ¡å¾…å‘é€æŠ¥å‘Š...`);
                
                // æ£€æŸ¥Firebaseè¿æ¥
                firebase.database().ref(".info/connected").once("value", (snap) => {
                    if (snap.val() === true) {
                        console.log("Firebaseè¿æ¥å·²æ¢å¤ï¼Œå¼€å§‹åŒæ­¥å¾…å‘é€æŠ¥å‘Š");
                        
                        // åˆ›å»ºåŒæ­¥ä»»åŠ¡
                        const syncPromises = pendingReports.map(report => {
                            return reportsRef.child(report.id.toString()).set(report)
                                .then(() => {
                                    console.log(`å¾…å‘é€æŠ¥å‘Š ${report.id} åŒæ­¥æˆåŠŸ`);
                                    return { id: report.id, success: true };
                                })
                                .catch(error => {
                                    console.error(`å¾…å‘é€æŠ¥å‘Š ${report.id} åŒæ­¥å¤±è´¥:`, error);
                                    return { id: report.id, success: false, error: error.message };
                                });
                        });
                        
                        // æ‰§è¡Œæ‰€æœ‰åŒæ­¥ä»»åŠ¡
                        Promise.allSettled(syncPromises)
                            .then(results => {
                                // è®¡ç®—æˆåŠŸå’Œå¤±è´¥çš„æ•°é‡
                                const succeeded = results.filter(r => r.status === 'fulfilled' && r.value.success).length;
                                const failed = results.length - succeeded;
                                
                                console.log(`å¾…å‘é€æŠ¥å‘ŠåŒæ­¥ç»“æœ: ${succeeded}æˆåŠŸ, ${failed}å¤±è´¥`);
                                
                                if (succeeded > 0) {
                                    sendDanmaku(`${succeeded}æ¡å¾…å‘é€æŠ¥å‘Šå·²åŒæ­¥æˆåŠŸ`);
                                    
                                    // åªä¿ç•™å¤±è´¥çš„æŠ¥å‘Šç»§ç»­å°è¯•
                                    let remainingReports = [];
                                    if (failed > 0) {
                                        remainingReports = pendingReports.filter(report => {
                                            const result = results.find(r => r.value && r.value.id === report.id);
                                            return !result || !result.value || !result.value.success;
                                        });
                                    }
                                    
                                    // æ›´æ–°localStorage
                                    localStorage.setItem('pending_reports', JSON.stringify(remainingReports));
                                    
                                    // å¦‚æœæ²¡æœ‰å¾…å‘é€æŠ¥å‘Šäº†ï¼Œæ¸…é™¤å®šæ—¶å™¨
                                    if (remainingReports.length === 0 && window._pendingSyncInterval) {
                                        clearInterval(window._pendingSyncInterval);
                                        window._pendingSyncInterval = null;
                                    }
                                }
                            });
                    }
                });
            } catch (error) {
                console.error("åŒæ­¥å¾…å‘é€æŠ¥å‘Šæ—¶å‡ºé”™:", error);
            }
        }
        
        // åŒæ­¥æŠ¥å‘Šåˆ°Cloudflare
        function syncReportToCloudflare(reportData) {
            console.log("æ­£åœ¨åŒæ­¥æŠ¥å‘Šåˆ°Cloudflare...", reportData.id);
            
            // ç¡®ä¿cloudflareConfigå·²æ­£ç¡®å®šä¹‰
            if (!cloudflareConfig || !cloudflareConfig.apiUrl) {
                console.error("åŒæ­¥å¤±è´¥: cloudflareConfigæœªå®šä¹‰æˆ–ä¸å®Œæ•´");
                sendDanmaku(currentLang === 'zh' ? 
                    'Cloudflareé…ç½®é”™è¯¯ï¼ŒåŒæ­¥å¤±è´¥' : 
                    'Cloudflare config error, sync failed'
                );
                return Promise.reject(new Error("Cloudflareé…ç½®é”™è¯¯"));
            }
            
            return new Promise((resolve, reject) => {
                // 1. é¦–å…ˆå°è¯•ä½¿ç”¨firebase-to-cloudflare-sync.jsä¸­çš„åŒæ­¥å‡½æ•°
                if (window.firebaseCloudflareSync && typeof window.firebaseCloudflareSync.syncSingleReport === 'function') {
                    console.log("ä½¿ç”¨åŒæ­¥å·¥å…·syncSingleReportå‡½æ•°...");
                    window.firebaseCloudflareSync.syncSingleReport(reportData)
                        .then(result => {
                            console.log("æŠ¥å‘Šå·²åŒæ­¥åˆ°Cloudflare(ä½¿ç”¨åŒæ­¥å·¥å…·):", result);
                            // åœ¨æˆåŠŸæ—¶ä¸æ·»åŠ ä»»ä½•é¢å¤–çš„æ“ä½œï¼Œå› ä¸ºsyncSingleReportå†…éƒ¨å·²æœ‰é€šçŸ¥å¤„ç†
                            resolve(result);
                        })
                        .catch(error => {
                            console.error("åŒæ­¥å·¥å…·åŒæ­¥å¤±è´¥ï¼Œå°è¯•ç›´æ¥åŒæ­¥:", error);
                            // å¤±è´¥æ—¶å°è¯•ç›´æ¥åŒæ­¥
                            directSyncToCloudflare(reportData)
                                .then(resolve)
                                .catch(reject);
                        });
                } else {
                    // 2. å¦‚æœåŒæ­¥å·¥å…·ä¸å¯ç”¨ï¼Œä½¿ç”¨ç›´æ¥åŒæ­¥
                    console.log("åŒæ­¥å·¥å…·ä¸å¯ç”¨ï¼Œä½¿ç”¨ç›´æ¥åŒæ­¥æ–¹å¼");
                    directSyncToCloudflare(reportData)
                        .then(resolve)
                        .catch(reject);
                }
            });
        }
        
        // ç›´æ¥åŒæ­¥åˆ°Cloudflare(ä¸ç»è¿‡åŒæ­¥å·¥å…·)
        function directSyncToCloudflare(reportData) {
            console.log("æ­£åœ¨ç›´æ¥åŒæ­¥åˆ°Cloudflare API...", reportData.id);
            
            // å‡†å¤‡è¯·æ±‚å¤´
            const headers = {
                'Content-Type': 'application/json'
            };
            
            // å¦‚æœå­˜åœ¨APIå¯†é’¥ï¼Œæ·»åŠ åˆ°è®¤è¯å¤´
            if (cloudflareConfig.apiKey) {
                headers['Authorization'] = `Bearer ${cloudflareConfig.apiKey}`;
            }
            
            return fetch(`${cloudflareConfig.apiUrl}${cloudflareConfig.dataEndpoint}/${reportData.id}`, {
                method: 'PUT',
                headers: headers,
                body: JSON.stringify(reportData)
            })
            .then(response => {
                console.log("Cloudflare APIå“åº”çŠ¶æ€:", response.status);
                if (!response.ok) {
                    throw new Error(`åŒæ­¥å¤±è´¥ï¼ŒHTTPé”™è¯¯: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("æŠ¥å‘Šå·²ç›´æ¥åŒæ­¥åˆ°Cloudflare:", data);
                
                // å‘é€é€šçŸ¥
                sendNotificationForReport(reportData);
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                sendDanmaku(currentLang === 'zh' ? 
                    'æŠ¥å‘Šå·²åŒæ­¥åˆ°Cloudflare' : 
                    'Report synced to Cloudflare'
                );
                
                return data;
            })
            .catch((error) => {
                console.error("ç›´æ¥åŒæ­¥æŠ¥å‘Šåˆ°Cloudflareå¤±è´¥:", error);
                sendDanmaku(currentLang === 'zh' ? 
                    'åŒæ­¥åˆ°Cloudflareå¤±è´¥' : 
                    'Failed to sync to Cloudflare'
                );
                
                throw error; // é‡æ–°æŠ›å‡ºé”™è¯¯ä»¥ä¾¿ä¸Šå±‚å¤„ç†
            });
        }
        
        // å‘é€æŠ¥å‘Šé€šçŸ¥
        function sendNotificationForReport(reportData) {
            console.log("ä¸ºæŠ¥å‘Šå‘é€é€šçŸ¥...", reportData);
            
            // å‡†å¤‡è¯·æ±‚å¤´
            const headers = {
                'Content-Type': 'application/json',
            };
            
            // å¦‚æœå­˜åœ¨APIå¯†é’¥ï¼Œæ·»åŠ åˆ°è®¤è¯å¤´
            if (cloudflareConfig.apiKey) {
                headers['Authorization'] = `Bearer ${cloudflareConfig.apiKey}`;
            }
            
            // åªæœ‰åœ¨è®¾ç½®äº†useRealApiæ‰å‘é€çœŸå®é€šçŸ¥ï¼Œå¦åˆ™æ¨¡æ‹Ÿ
            if (!cloudflareConfig.useRealApi && window.location.hostname.includes('github.io')) {
                console.log("GitHub Pagesç¯å¢ƒæ¨¡æ‹Ÿé€šçŸ¥å‘é€");
                sendDanmaku(currentLang === 'zh' ? 
                    'æ¨¡æ‹Ÿé€šçŸ¥å·²å‘é€' : 
                    'Simulated notification sent'
                );
                return Promise.resolve({ success: true, message: 'æ¨¡æ‹Ÿé€šçŸ¥å‘é€æˆåŠŸ' });
            }
            
            return fetch(`${cloudflareConfig.apiUrl}/api/send-notification`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({
                    markerId: reportData.id,
                    markerData: reportData,
                    notification: {
                        title: 'æ–°æŠ¥å‘Šæ·»åŠ ',
                        body: reportData.description || (currentLang === 'zh' ? 'æ–°çš„åœ°å›¾æ ‡è®°' : 'New map marker'),
                        icon: './images/icon-192x192.png',
                        badge: './images/badge-72x72.png',
                        data: {
                            markerId: reportData.id,
                            time: Date.now()
                        },
                        requireInteraction: true,
                        vibrate: [200, 100, 200],
                        actions: [
                            { action: 'view', title: currentLang === 'zh' ? 'æŸ¥çœ‹' : 'View' }
                        ]
                    }
                })
            })
            .then(response => {
                console.log("é€šçŸ¥å‘é€ç»“æœ:", response.status);
                if (response.ok) {
                    sendDanmaku(currentLang === 'zh' ? 
                        'æŠ¥å‘Šå·²ä¿å­˜å¹¶å‘é€é€šçŸ¥' : 
                        'Report saved and notification sent'
                    );
                    return { success: true, message: 'é€šçŸ¥å‘é€æˆåŠŸ' };
                } else {
                    sendDanmaku(currentLang === 'zh' ? 
                        'ä¿å­˜æŠ¥å‘Šå¹¶å‘é€é€šçŸ¥å¤±è´¥' : 
                        'Failed to save report and send notification'
                    );
                    return { success: false, message: 'é€šçŸ¥å‘é€å¤±è´¥' };
                }
            })
            .catch(error => {
                console.error("å‘é€é€šçŸ¥å¤±è´¥:", error);
                sendDanmaku(currentLang === 'zh' ? 
                    'å‘é€é€šçŸ¥æ—¶å‡ºé”™' : 
                    'Error sending notification'
                );
                return { success: false, message: 'é€šçŸ¥å‘é€å¤±è´¥' };
            });
        }
        
        // ä¿å­˜æŠ¥å‘Šåˆ°Cloudflare Workers
        function saveReportToCloudflare(reportData) {
            console.log("Saving report to Cloudflare Workers...", reportData);
            
            // å‡†å¤‡è¯·æ±‚å¤´
            const headers = {
                'Content-Type': 'application/json',
            };
            
            // å¦‚æœå­˜åœ¨APIå¯†é’¥ï¼Œæ·»åŠ åˆ°è®¤è¯å¤´
            if (cloudflareConfig.apiKey) {
                headers['Authorization'] = `Bearer ${cloudflareConfig.apiKey}`;
            }
            
            // åªæœ‰åœ¨è®¾ç½®äº†useRealApiä¸”ä¸åœ¨GitHub Pagesç¯å¢ƒæ—¶æ‰ä½¿ç”¨çœŸå®API
            if (!cloudflareConfig.useRealApi && window.location.hostname.includes('github.io')) {
                console.log("GitHub Pagesç¯å¢ƒæ¨¡æ‹Ÿæ•°æ®ä¿å­˜");
                
                // ä¸ºäº†å…¼å®¹æ€§ï¼Œä¿å­˜åˆ°Firebase
                saveReportToFirebase(reportData);
                
                // å‘é€é€šçŸ¥
                sendNotificationForReport(reportData);
                
                return Promise.resolve({ success: true, message: 'æ¨¡æ‹Ÿä¿å­˜æˆåŠŸ' });
            }
            
            return fetch(`${cloudflareConfig.apiUrl}${cloudflareConfig.dataEndpoint}`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(reportData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯ ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("æŠ¥å‘Šå·²ä¿å­˜åˆ°Cloudflare Workers", data);
                
                // ä¸ºäº†å…¼å®¹æ€§ï¼ŒåŒæ—¶ä¿å­˜åˆ°Firebase
                saveReportToFirebase(reportData);
                
                // å‘é€é€šçŸ¥
                sendNotificationForReport(reportData);
                
                return data;
            })
            .catch((error) => {
                console.error("ä¿å­˜æŠ¥å‘Šåˆ°Cloudflareå¤±è´¥:", error);
                
                // é”™è¯¯æ—¶å›é€€åˆ°Firebase
                saveReportToFirebase(reportData);
                
                sendDanmaku(currentLang === 'zh' ? 
                    'ä¿å­˜åˆ°Cloudflareå¤±è´¥ï¼Œå·²å›é€€åˆ°Firebase' : 
                    'Failed to save to Cloudflare, fallback to Firebase'
                );
                
                throw error;
            });
        }
        
        // æ›´æ–°å°†æŠ¥å‘Šæ ‡è®°æ·»åŠ åˆ°åœ°å›¾
        function addReportMarkerToMap(reportData) {
            try {
                // åˆ›å»ºæ ‡è®°å›¾æ ‡
                const markerIcon = {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                        `<svg xmlns="http://www.w3.org/2000/svg" width="42" height="42" viewBox="0 0 42 42">
                            <circle cx="21" cy="21" r="20" fill="white" opacity="0.95"/>
                            <text x="21" y="29" font-size="24" text-anchor="middle" fill="black">${reportData.emoji || 'ğŸ“'}</text>
                        </svg>`
                    ),
                    scaledSize: new google.maps.Size(42, 42),
                    anchor: new google.maps.Point(21, 21)
                };
                
                // ä½¿ç”¨ä¼ ç»ŸMarker API
                const marker = new google.maps.Marker({
                    position: { 
                        lat: parseFloat(reportData.lat), 
                        lng: parseFloat(reportData.lng) 
                    },
                    map: map,
                    icon: markerIcon,
                    title: reportData.description
                });
                
                // åˆ›å»ºä¿¡æ¯çª—å£å†…å®¹
                const infoContent = `
                    <div class="info-window">
                        <div class="emoji-display">${reportData.emoji || 'ğŸ“'}</div>
                        <div class="description">${reportData.description}</div>
                        <div class="time-display">${formatTimeAgo(new Date(reportData.time))}</div>
                    </div>
                `;
                
                const infoWindow = new google.maps.InfoWindow({
                    content: infoContent,
                    maxWidth: 200
                });
                
                // ä¸ºä¼ ç»ŸMarkeræ·»åŠ ç‚¹å‡»äº‹ä»¶
                marker.addListener("click", function() {
                    console.log('Report marker clicked:', reportData.id);
                    // å…³é—­æ‰€æœ‰æ´»åŠ¨çš„ä¿¡æ¯çª—å£
                    if (this.infoWindow) this.infoWindow.close();
                    showReportDetails(reportData);
                });
                
                // ä¿å­˜infoWindowçš„å¼•ç”¨å’ŒreportDataåˆ°markerå¯¹è±¡ä¸Š
                marker.infoWindow = infoWindow;
                marker.reportData = reportData;
                
                // æ·»åŠ åˆ°æ ‡è®°æ•°ç»„
                markers.push(marker);
                
                // å°†æ•°æ®ä¿å­˜åˆ°Firebaseæˆ–Cloudflare
                console.log("ä¿å­˜æ ‡è®°æ•°æ®ï¼Œå­˜å‚¨ç³»ç»Ÿ:", useCloudflare ? "Cloudflare" : "Firebase");
                
                if (useCloudflare) {
                    // ä¿å­˜åˆ°Cloudflare
                    saveReportToCloudflare(reportData);
                } else {
                    // ä¿å­˜åˆ°Firebase
                    reportsRef.child(reportData.id.toString()).set(reportData)
                        .then(() => {
                            console.log("Quick report saved to Firebase", reportData);
                            
                            // å¢åŠ ç”¨æˆ·æŠ¥å‘Šè®¡æ•°
                            incrementUserReportCount();
                            
                            // åŒæ­¥åˆ°Cloudflare
                            if (syncToCloudflare) {
                                syncReportToCloudflare(reportData);
                            }
                        })
                        .catch((error) => {
                            console.error("Error saving quick report to Firebase:", error);
                            sendDanmaku(currentLang === 'zh' ? 
                                'æ ‡è®°å·²æ·»åŠ åˆ°åœ°å›¾ï¼Œä½†ä¿å­˜åˆ°æœåŠ¡å™¨å¤±è´¥' : 
                                'Marker added to map, but failed to save to server'
                            );
                        });
                }
                
                return marker;
            } catch (error) {
                console.error("æ·»åŠ æ ‡è®°æ—¶å‡ºé”™:", error, reportData);
                // è¿”å›nullä»¥ä¾¿è°ƒç”¨è€…å¯ä»¥å¤„ç†é”™è¯¯
                return null;
            }
        }
        
        // æŠ¥å‘Šè¯¦æƒ…å¼¹çª—
        function showReportDetails(report) {
            // å…ˆæ£€æŸ¥æ˜¯å¦å·²æœ‰è¯¦æƒ…å¼¹çª—ï¼Œæœ‰åˆ™ç§»é™¤
            let existingDetailPopup = document.getElementById('reportDetailPopup');
            if (existingDetailPopup) {
                existingDetailPopup.remove();
            }
            
            // åˆ›å»ºè¯¦æƒ…å¼¹çª—
            const detailPopup = document.createElement('div');
            detailPopup.id = 'reportDetailPopup';
            detailPopup.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:400px;background-color:rgba(33,33,33,0.95);border-radius:16px;padding:20px;z-index:5002;box-shadow:0 4px 20px rgba(0,0,0,0.5);color:white;animation:popup-fade-in 0.3s ease-out;max-height:90vh;overflow-y:auto;';
            
            // æ·»åŠ å…³é—­æŒ‰é’®
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '&times;';
            closeBtn.style.cssText = 'position:absolute;top:10px;right:15px;background:none;border:none;color:white;font-size:24px;cursor:pointer;';
            closeBtn.onclick = function() {
                detailPopup.remove();
            };
            detailPopup.appendChild(closeBtn);
            
            // æ·»åŠ æŠ¥å‘Šæ—¶é—´å’Œç”¨æˆ·ä¿¡æ¯
            const headerDiv = document.createElement('div');
            const reportTime = new Date(report.time);
            headerDiv.style.cssText = 'display:flex;justify-content:space-between;align-items:center;';
            headerDiv.innerHTML = `
                <span style="color:#aaa;font-size:14px;">${reportTime.toLocaleString()}</span>
                <span style="color:#aaa;font-size:14px;">ğŸ‘¤ ${report.userName || (currentLang === 'zh' ? 'ç”¨æˆ·' : 'User')}</span>
            `;
            detailPopup.appendChild(headerDiv);
            
            // æ·»åŠ æ ‡é¢˜
            const titleDiv = document.createElement('div');
            titleDiv.innerHTML = `<h3 style="margin:10px 0 15px;font-size:20px;">${report.emoji} ${i18n[currentLang].reportDetails}</h3>`;
            detailPopup.appendChild(titleDiv);
            
            // æ·»åŠ å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
            if (report.image && report.image.length > 0) {
                const imageDiv = document.createElement('div');
                imageDiv.style.cssText = 'width:100%;height:200px;margin:15px 0;border-radius:8px;overflow:hidden;';
                const img = document.createElement('img');
                img.src = report.image;
                img.style.cssText = 'width:100%;height:100%;object-fit:cover;';
                imageDiv.appendChild(img);
                detailPopup.appendChild(imageDiv);
            }
            
            // æ·»åŠ æè¿°å’Œç¿»è¯‘æŒ‰é’®
            const descDiv = document.createElement('div');
            descDiv.id = 'descriptionText';
            descDiv.style.cssText = 'margin:15px 0;padding:10px;background-color:rgba(255,255,255,0.1);border-radius:8px;';
            const descText = report.description || i18n[currentLang].noDescription;
            
            // ä¼˜å…ˆä½¿ç”¨åŸå§‹æè¿°ï¼ˆå¦‚æœæœ‰ï¼‰
            const displayText = report.originalDescription || descText;
            descDiv.innerText = displayText;
            
            // å¦‚æœæœ‰æè¿°ï¼Œæ·»åŠ ç¿»è¯‘æŒ‰é’®
            if (displayText && displayText !== i18n[currentLang].noDescription) {
                const translateBtn = document.createElement('span');
                translateBtn.className = 'translate-btn';
                translateBtn.innerHTML = i18n[currentLang].translate;
                translateBtn.style.color = '#3498db'; // è“è‰²åœ°çƒemojié‡‡ç”¨è“è‰²
                translateBtn.onclick = function() {
                    this.innerText = i18n[currentLang].translating;
                    this.style.pointerEvents = 'none';
                    
                    // æ£€æµ‹åŸæ–‡è¯­è¨€å¹¶ç¿»è¯‘åˆ°å¯¹åº”è¯­è¨€
                    const isEnglish = /^[a-zA-Z0-9\s.,!?;:()"'-]+$/.test(displayText.trim());
                    const targetLang = isEnglish ? 'zh' : 'en';
                    
                    // ç¿»è¯‘æ–‡æœ¬
                    translateText(displayText, targetLang)
                        .then(translatedText => {
                            const translatedDiv = document.createElement('div');
                            translatedDiv.className = 'translated-text';
                            translatedDiv.innerText = `${i18n[currentLang].translation}${translatedText}`;
                            
                            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç¿»è¯‘ï¼Œå¦‚æœæœ‰åˆ™æ›¿æ¢
                            const existingTranslation = document.getElementById('translatedText');
                            if (existingTranslation) {
                                existingTranslation.remove();
                            }
                            
                            translatedDiv.id = 'translatedText';
                            descDiv.appendChild(translatedDiv);
                            
                            // é‡ç½®æŒ‰é’®
                            this.innerHTML = i18n[currentLang].translate;
                            this.style.pointerEvents = 'auto';
                        })
                        .catch(error => {
                            console.error('ç¿»è¯‘å¤±è´¥:', error);
                            // é‡ç½®æŒ‰é’®
                            this.innerHTML = i18n[currentLang].translate;
                            this.style.pointerEvents = 'auto';
                        });
                };
                
                // æ·»åŠ ç¿»è¯‘æŒ‰é’®åˆ°æè¿°divä¹‹å
                descDiv.appendChild(document.createElement('br'));
                descDiv.appendChild(translateBtn);
            }
            
            detailPopup.appendChild(descDiv);
            
            // æ·»åŠ æ“ä½œæŒ‰é’®ï¼ˆè¯„è®ºå’Œåˆ é™¤ï¼‰
            const actionDiv = document.createElement('div');
            actionDiv.style.cssText = 'display:flex;justify-content:space-between;margin:15px 0;';
            
            // æ·»åŠ è¯„è®ºæŒ‰é’®
            const commentBtn = document.createElement('button');
            commentBtn.innerHTML = 'ğŸ’¬'; // è¯„è®ºæ°”æ³¡emoji
            commentBtn.title = i18n[currentLang].addComment;
            commentBtn.style.cssText = 'background:rgba(255,255,255,0.2);border:none;color:white;border-radius:50%;width:40px;height:40px;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;';
            commentBtn.onclick = function() {
                showCommentForm(report, detailPopup);
            };
            actionDiv.appendChild(commentBtn);
            
            // æ·»åŠ åˆ é™¤æŒ‰é’®ï¼ˆä»…å¯¹æŠ¥å‘Šåˆ›å»ºè€…æ˜¾ç¤ºï¼‰
            if (currentUserId === report.userId || isCurrentUserAdmin) {
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = 'ğŸ—‘ï¸'; // åƒåœ¾æ¡¶emoji
                deleteBtn.title = i18n[currentLang].deleteReport;
                deleteBtn.style.cssText = 'background:rgba(255,80,80,0.2);border:none;color:white;border-radius:50%;width:40px;height:40px;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;';
                deleteBtn.onclick = function() {
                    if (isCurrentUserAdmin && currentUserId !== report.userId) {
                        // ç®¡ç†å‘˜åˆ é™¤ä»–äººçš„æŠ¥å‘Š
                        confirmDeleteReportAdmin(report.id);
                    } else {
                        // ç”¨æˆ·åˆ é™¤è‡ªå·±çš„æŠ¥å‘Š
                        confirmDeleteReport(report.id, detailPopup);
                    }
                };
                actionDiv.appendChild(deleteBtn);
            }
            
            // æ·»åŠ ç®¡ç†å‘˜ç‰¹å®šæ§åˆ¶ï¼ˆå¦‚æœå½“å‰ç”¨æˆ·æ˜¯ç®¡ç†å‘˜ï¼‰
            if (isCurrentUserAdmin) {
                // æ·»åŠ å°ç¦ç”¨æˆ·æŒ‰é’®ï¼ˆä¸èƒ½å°ç¦è‡ªå·±ï¼‰
                if (report.userId && report.userId !== currentUserId) {
                    const banUserBtn = document.createElement('button');
                    banUserBtn.innerHTML = 'ğŸš«'; // ç¦æ­¢emoji
                    banUserBtn.title = i18n[currentLang].banUser;
                    banUserBtn.style.cssText = 'background:rgba(255,80,80,0.2);border:none;color:white;border-radius:50%;width:40px;height:40px;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;';
                    banUserBtn.onclick = function() {
                        confirmBanUser(report.userId, report.userName || report.userId);
                        detailPopup.remove();
                    };
                    actionDiv.appendChild(banUserBtn);
                    
                    // ç®¡ç†å‘˜æƒé™æŒ‰é’®
                    const adminBtn = document.createElement('button');
                    if (report.isAdmin) {
                        adminBtn.textContent = 'â¬‡ï¸';
                        adminBtn.title = i18n[currentLang].removeAdmin;
                        adminBtn.addEventListener('click', () => removeAdminRole(report.userId));
                    } else {
                        adminBtn.textContent = 'â¬†ï¸';
                        adminBtn.title = i18n[currentLang].promoteAdmin;
                        adminBtn.addEventListener('click', () => grantAdminRole(report.userId));
                    }
                    adminBtn.style.cssText = 'background:none;border:none;cursor:pointer;font-size:16px;padding:5px;';
                    actionDiv.appendChild(adminBtn);
                }
                
                // æ·»åŠ ç®¡ç†æ ‡ç­¾
                const adminLabel = document.createElement('div');
                adminLabel.textContent = i18n[currentLang].adminControls;
                adminLabel.style.cssText = 'position:absolute;top:10px;left:15px;color:#ff3b30;font-size:12px;font-weight:bold;';
                detailPopup.appendChild(adminLabel);
            }
            
            detailPopup.appendChild(actionDiv);
            
            // æ˜¾ç¤ºè¯„è®ºåŒº
            const commentsSection = document.createElement('div');
            commentsSection.id = 'commentsSection';
            commentsSection.style.cssText = 'margin-top:20px;';
            
            const commentsTitle = document.createElement('h4');
            commentsTitle.textContent = i18n[currentLang].comments;
            commentsTitle.style.cssText = 'margin-bottom:10px;font-size:16px;border-bottom:1px solid rgba(255,255,255,0.2);padding-bottom:5px;';
            commentsSection.appendChild(commentsTitle);
            
            // åŠ è½½è¯„è®º
            loadComments(report.id, commentsSection);
            
            detailPopup.appendChild(commentsSection);
            
            // æ·»åŠ åˆ°æ–‡æ¡£
            document.body.appendChild(detailPopup);
            
            // å°†æè¿°å‘é€åˆ°å¼¹å¹•
            if (report.description) {
                sendDanmaku(report.description);
            }
        }
        
        // æ˜¾ç¤ºè¯„è®ºè¡¨å•
        function showCommentForm(report, parentPopup) {
            // åˆ›å»ºè¯„è®ºè¡¨å•å®¹å™¨
            const commentFormDiv = document.createElement('div');
            commentFormDiv.id = 'commentFormDiv';
            commentFormDiv.style.cssText = 'margin-top:15px;background-color:rgba(255,255,255,0.1);border-radius:8px;padding:10px;';
            
            // åˆ›å»ºè¯„è®ºè¾“å…¥æ¡†
            const commentInput = document.createElement('textarea');
            commentInput.placeholder = i18n[currentLang].commentPlaceholder;
            commentInput.style.cssText = 'width:100%;min-height:60px;resize:vertical;padding:8px;border-radius:4px;border:1px solid #444;background-color:#2c2c2e;color:#fff;font-size:14px;';
            commentFormDiv.appendChild(commentInput);
            
            // åˆ›å»ºæŒ‰é’®å®¹å™¨
            const btnContainer = document.createElement('div');
            btnContainer.style.cssText = 'display:flex;justify-content:flex-end;gap:10px;margin-top:10px;';
            
            // å–æ¶ˆæŒ‰é’®
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = i18n[currentLang].cancelComment;
            cancelBtn.style.cssText = 'padding:6px 12px;border-radius:4px;border:none;background-color:#3a3a3c;color:white;cursor:pointer;';
            cancelBtn.onclick = function() {
                commentFormDiv.remove();
            };
            btnContainer.appendChild(cancelBtn);
            
            // æäº¤æŒ‰é’®
            const submitBtn = document.createElement('button');
            submitBtn.textContent = i18n[currentLang].submitComment;
            submitBtn.style.cssText = 'padding:6px 12px;border-radius:4px;border:none;background-color:#0071e3;color:white;cursor:pointer;';
            submitBtn.onclick = function() {
                const commentText = commentInput.value.trim();
                if (commentText) {
                    addComment(report.id, commentText);
                    commentFormDiv.remove();
                    // åˆ·æ–°è¯„è®ºåŒº
                    const commentsSection = document.getElementById('commentsSection');
                    if (commentsSection) {
                        loadComments(report.id, commentsSection);
                    }
                }
            };
            btnContainer.appendChild(submitBtn);
            
            commentFormDiv.appendChild(btnContainer);
            
            // æ·»åŠ åˆ°çˆ¶å¼¹çª—
            parentPopup.appendChild(commentFormDiv);
            
            // èšç„¦è¾“å…¥æ¡†
            commentInput.focus();
        }
        
        // æ·»åŠ è¯„è®º
        function addComment(reportId, commentText) {
            if (!currentUserId) return;
            
            const newComment = {
                id: Date.now(),
                userId: currentUserId,
                userName: document.getElementById('userDisplayName').textContent || (currentLang === 'zh' ? 'ç”¨æˆ·' : 'User'),
                text: commentText,
                time: new Date().toISOString()
            };
            
            // è·å–æŠ¥å‘Šå¼•ç”¨
            const reportRef = reportsRef.child(reportId.toString());
            
            // å…ˆè·å–å½“å‰è¯„è®ºï¼Œç„¶åæ·»åŠ æ–°è¯„è®º
            reportRef.child('comments').once('value')
                .then((snapshot) => {
                    let comments = [];
                    if (snapshot.exists()) {
                        comments = snapshot.val() || [];
                    }
                    
                    // æ·»åŠ æ–°è¯„è®º
                    comments.push(newComment);
                    
                    // æ›´æ–°è¯„è®ºåˆ—è¡¨
                    return reportRef.child('comments').set(comments);
                })
                .then(() => {
                    console.log('è¯„è®ºæ·»åŠ æˆåŠŸ');
                    // å‘é€è¯„è®ºåˆ°å¼¹å¹•
                    sendDanmaku(`ğŸ’¬ ${newComment.userName}: ${commentText}`);
                })
                .catch((error) => {
                    console.error('æ·»åŠ è¯„è®ºå¤±è´¥:', error);
                });
        }
        
        // åŠ è½½è¯„è®º
        function loadComments(reportId, commentsSection) {
            // æ¸…ç©ºç°æœ‰å†…å®¹
            while (commentsSection.childNodes.length > 1) {
                commentsSection.removeChild(commentsSection.lastChild);
            }
            
            // è·å–æŠ¥å‘Šçš„è¯„è®º
            reportsRef.child(reportId.toString()).child('comments').once('value')
                .then((snapshot) => {
                    if (snapshot.exists() && snapshot.val()) {
                        const comments = snapshot.val();
                        
                        // æ˜¾ç¤ºè¯„è®º
                        comments.forEach(comment => {
                            const commentDiv = document.createElement('div');
                            commentDiv.style.cssText = 'margin-bottom:10px;padding:8px;background-color:rgba(255,255,255,0.05);border-radius:4px;';
                            
                            const commentHeader = document.createElement('div');
                            commentHeader.style.cssText = 'display:flex;justify-content:space-between;margin-bottom:5px;';
                            
                            const userName = document.createElement('span');
                            userName.textContent = `ğŸ‘¤ ${comment.userName || (currentLang === 'zh' ? 'ç”¨æˆ·' : 'User')}`;
                            userName.style.cssText = 'font-weight:bold;font-size:14px;';
                            commentHeader.appendChild(userName);
                            
                            const commentTime = document.createElement('span');
                            commentTime.textContent = new Date(comment.time).toLocaleString();
                            commentTime.style.cssText = 'color:#aaa;font-size:12px;';
                            commentHeader.appendChild(commentTime);
                            
                            commentDiv.appendChild(commentHeader);
                            
                            const commentText = document.createElement('p');
                            commentText.textContent = comment.text;
                            commentText.style.cssText = 'margin:0;font-size:14px;';
                            commentDiv.appendChild(commentText);
                            
                            commentsSection.appendChild(commentDiv);
                        });
                    } else {
                        // æ— è¯„è®ºæ—¶æ˜¾ç¤ºæç¤º
                        const noCommentsDiv = document.createElement('p');
                        noCommentsDiv.textContent = i18n[currentLang].noComments;
                        noCommentsDiv.style.cssText = 'color:#aaa;font-style:italic;text-align:center;font-size:14px;';
                        commentsSection.appendChild(noCommentsDiv);
                    }
                })
                .catch((error) => {
                    console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
                    const errorDiv = document.createElement('p');
                    errorDiv.textContent = 'Error loading comments';
                    errorDiv.style.cssText = 'color:red;text-align:center;';
                    commentsSection.appendChild(errorDiv);
                });
        }
        
        // ç¡®è®¤åˆ é™¤æŠ¥å‘Š
        function confirmDeleteReport(reportId, parentPopup) {
            // åˆ›å»ºç¡®è®¤å¼¹çª—
            const confirmDiv = document.createElement('div');
            confirmDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:rgba(40,40,40,0.95);border-radius:8px;padding:15px;width:80%;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,0.7);z-index:5002;';
            
            const confirmText = document.createElement('p');
            confirmText.textContent = i18n[currentLang].confirmDelete;
            confirmText.style.cssText = 'margin-bottom:15px;font-size:16px;';
            confirmDiv.appendChild(confirmText);
            
            const btnContainer = document.createElement('div');
            btnContainer.style.cssText = 'display:flex;justify-content:center;gap:15px;';
            
            // ç¡®è®¤æŒ‰é’®
            const yesBtn = document.createElement('button');
            yesBtn.textContent = i18n[currentLang].yes;
            yesBtn.style.cssText = 'padding:8px 16px;border-radius:4px;border:none;background-color:#e53935;color:white;cursor:pointer;';
            yesBtn.onclick = function() {
                deleteReport(reportId);
                parentPopup.remove();
            };
            btnContainer.appendChild(yesBtn);
            
            // å–æ¶ˆæŒ‰é’®
            const noBtn = document.createElement('button');
            noBtn.textContent = i18n[currentLang].no;
            noBtn.style.cssText = 'padding:8px 16px;border-radius:4px;border:none;background-color:#3a3a3c;color:white;cursor:pointer;';
            noBtn.onclick = function() {
                confirmDiv.remove();
            };
            btnContainer.appendChild(noBtn);
            
            confirmDiv.appendChild(btnContainer);
            
            // æ·»åŠ åˆ°çˆ¶å¼¹çª—
            parentPopup.appendChild(confirmDiv);
        }
        
        // åˆ é™¤æŠ¥å‘Š
        function deleteReport(reportId) {
            reportsRef.child(reportId.toString()).remove()
                .then(() => {
                    console.log('æŠ¥å‘Šåˆ é™¤æˆåŠŸ:', reportId);
                    
                    // åˆ é™¤å¯¹åº”çš„æ ‡è®°
                    const markerIndex = markers.findIndex(marker => marker.reportData && marker.reportData.id == reportId);
                    if (markerIndex !== -1) {
                        markers[markerIndex].setMap(null);
                        markers.splice(markerIndex, 1);
                    }
                    
                    // å‘é€åˆ é™¤æˆåŠŸçš„é€šçŸ¥å¼¹å¹•
                    sendDanmaku(currentLang === 'zh' ? 'æŠ¥å‘Šå·²æˆåŠŸåˆ é™¤' : 'Report successfully deleted');
                })
                .catch((error) => {
                    console.error('åˆ é™¤æŠ¥å‘Šå¤±è´¥:', error);
                    alert(currentLang === 'zh' ? 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•' : 'Delete failed, please try again');
                });
        }
        
        // ç®€å•çš„æ–‡æœ¬ç¿»è¯‘å‡½æ•°ï¼ˆä½¿ç”¨æ¨¡æ‹Ÿç¿»è¯‘ï¼Œå®é™…åº”ç”¨ä¸­åº”æ›¿æ¢ä¸ºçœŸå®APIï¼‰
        async function translateText(text, targetLang) {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨ç¿»è¯‘APIï¼Œå¦‚Google Translate API
            // è¿™é‡Œä½¿ç”¨ç®€å•æ¨¡æ‹Ÿï¼Œæ ¹æ®ç›®æ ‡è¯­è¨€è¿”å›ä¸åŒçš„æ–‡æœ¬
            
            // å»¶æ—¶1ç§’æ¨¡æ‹ŸAPIè°ƒç”¨
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            if (targetLang === 'zh') {
                // è‹±æ–‡åˆ°ä¸­æ–‡çš„ç®€å•æ˜ å°„
                const enToCnMap = {
                    'dog': 'ç‹—',
                    'cat': 'çŒ«',
                    'hello': 'ä½ å¥½',
                    'traffic': 'äº¤é€š',
                    'accident': 'äº‹æ•…',
                    'attention': 'æ³¨æ„',
                    'caution': 'å°å¿ƒ',
                    'danger': 'å±é™©',
                    'warning': 'è­¦å‘Š',
                    'help': 'å¸®åŠ©',
                    'police': 'è­¦å¯Ÿ',
                    'emergency': 'ç´§æ€¥æƒ…å†µ',
                    'crowded': 'æ‹¥æŒ¤',
                    'delayed': 'å»¶è¯¯',
                    'cancelled': 'å–æ¶ˆ',
                    'closed': 'å…³é—­',
                    'open': 'å¼€æ”¾',
                };
                
                let translated = text;
                Object.keys(enToCnMap).forEach(key => {
                    const regex = new RegExp(key, 'gi');
                    translated = translated.replace(regex, enToCnMap[key]);
                });
                
                return translated;
            } else {
                // ä¸­æ–‡åˆ°è‹±æ–‡çš„ç®€å•æ˜ å°„
                const cnToEnMap = {
                    'ç‹—': 'dog',
                    'çŒ«': 'cat',
                    'ä½ å¥½': 'hello',
                    'äº¤é€š': 'traffic',
                    'äº‹æ•…': 'accident',
                    'æ³¨æ„': 'attention',
                    'å°å¿ƒ': 'caution',
                    'å±é™©': 'danger',
                    'è­¦å‘Š': 'warning',
                    'å¸®åŠ©': 'help',
                    'è­¦å¯Ÿ': 'police',
                    'ç´§æ€¥æƒ…å†µ': 'emergency',
                    'æ‹¥æŒ¤': 'crowded',
                    'å»¶è¯¯': 'delayed',
                    'å–æ¶ˆ': 'cancelled',
                    'å…³é—­': 'closed',
                    'å¼€æ”¾': 'open',
                };
                
                let translated = text;
                Object.keys(cnToEnMap).forEach(key => {
                    translated = translated.replace(new RegExp(key, 'g'), cnToEnMap[key]);
                });
                
                return translated;
            }
        }
        
        // å¼¹å¹•ç›¸å…³å‡½æ•°
        function sendDanmaku(text) {
            // é™åˆ¶é•¿åº¦ï¼Œè¿‡é•¿çš„æ–‡æœ¬ä¼šè¢«æˆªæ–­
            const maxLength = 30;
            let danmakuText = text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
            
            // å¦‚æœæ–‡æœ¬ä¸ºç©ºï¼Œä¸æ˜¾ç¤ºå¼¹å¹•
            if (!danmakuText.trim()) return;
            
            // å°è¯•æ ¹æ®å½“å‰è¯­è¨€è¿›è¡Œç¿»è¯‘
            if (currentLang === 'en') {
                // å¦‚æœå½“å‰æ˜¯è‹±æ–‡ç•Œé¢ï¼Œä½†å†…å®¹åŒ…å«ä¸­æ–‡å­—ç¬¦ï¼Œå°è¯•è½¬ä¸ºè‹±æ–‡
                if (/[\u4e00-\u9fa5]/.test(danmakuText)) {
                    // ç®€å•çš„ä¸­è‹±æ–‡å…³é”®è¯æ˜ å°„
                    const cnToEnMap = {
                        'ç‹—': 'dog',
                        'çŒ«': 'cat',
                        'ä½ å¥½': 'hello',
                        'äº¤é€š': 'traffic',
                        'äº‹æ•…': 'accident',
                        'æ³¨æ„': 'attention',
                        'å°å¿ƒ': 'caution',
                        'å±é™©': 'danger',
                        'è­¦å‘Š': 'warning',
                        'å¸®åŠ©': 'help',
                        'è­¦å¯Ÿ': 'police',
                        'ç´§æ€¥æƒ…å†µ': 'emergency',
                        'æ‹¥æŒ¤': 'crowded',
                        'å»¶è¯¯': 'delayed',
                        'å–æ¶ˆ': 'cancelled',
                        'å…³é—­': 'closed',
                        'å¼€æ”¾': 'open',
                        'æ­£å¸¸': 'normal',
                        'æœåŠ¡': 'service',
                        'ç”µè½¦': 'tram',
                        'è½¨é“': 'track',
                        'ç»´ä¿®': 'maintenance',
                        'ç«™': 'stop',
                        'ä¸´æ—¶': 'temporary',
                        'é¢‘ç‡': 'frequency',
                        'é«˜å³°': 'peak',
                        'å¸‚ä¸­å¿ƒ': 'CBD',
                        'çº¿': 'route',
                        'å·çº¿': 'route',
                        'æ¸¸å®¢': 'Guest',
                        'æ·»åŠ ': 'Add',
                        'æŠ¥å‘Š': 'Report',
                        'è¯„è®º': 'Comment',
                        'æ¬¢è¿': 'Welcome',
                        'ä½¿ç”¨': 'using',
                        'åœ°å›¾': 'map',
                        'ç³»ç»Ÿ': 'system'
                    };
                    
                    // å°è¯•æ›¿æ¢ä¸­æ–‡å…³é”®è¯
                    for (const [cn, en] of Object.entries(cnToEnMap)) {
                        danmakuText = danmakuText.replace(new RegExp(cn, 'g'), en);
                    }
                    
                    // å¯¹äºå¸¸è§çš„çº¿è·¯å…¬å‘Šæ ¼å¼è¿›è¡Œç‰¹æ®Šå¤„ç†
                    danmakuText = danmakuText.replace(/(\d+)å·çº¿/g, 'Route $1');
                }
            } else if (currentLang === 'zh') {
                // å¦‚æœå½“å‰æ˜¯ä¸­æ–‡ç•Œé¢ï¼Œä½†å†…å®¹ä¸åŒ…å«ä¸­æ–‡å­—ç¬¦ï¼Œå¯èƒ½æ˜¯è‹±æ–‡
                if (!/[\u4e00-\u9fa5]/.test(danmakuText) && danmakuText.length > 5) {
                    // è¿™é‡Œå¯ä»¥æ·»åŠ è‹±æ–‡åˆ°ä¸­æ–‡çš„ç®€å•è½¬æ¢ï¼Œä½†é»˜è®¤ä¿ç•™è‹±æ–‡ä¹Ÿå¯ä»¥
                    // ç®€å•å¤„ç†Routeæ ¼å¼
                    danmakuText = danmakuText.replace(/Route (\d+)/g, '$1å·çº¿');
                }
            }
            
            // æ·»åŠ åˆ°é˜Ÿåˆ—
            danmakuQueue.push(danmakuText);
            
            // å¦‚æœå¼¹å¹•ç³»ç»Ÿæœªè¿è¡Œï¼Œå¯åŠ¨å®ƒ
            if (!danmakuRunning) {
                processDanmakuQueue();
            }
        }
        
        function processDanmakuQueue() {
            if (danmakuQueue.length === 0) {
                danmakuRunning = false;
                return;
            }
            
            danmakuRunning = true;
            const text = danmakuQueue.shift();
            createDanmaku(text);
            
            // æ¯éš”ä¸€æ®µæ—¶é—´å¤„ç†ä¸‹ä¸€ä¸ªå¼¹å¹•
            setTimeout(processDanmakuQueue, 2500);
        }
        
        function createDanmaku(text) {
            // å¤„ç†æ–‡æœ¬ä¸­çš„çº¿è·¯ä¿¡æ¯ï¼Œæ ¹æ®å½“å‰è¯­è¨€è¿›è¡Œè½¬æ¢
            if (currentLang === 'en') {
                // è½¬æ¢ä¸­æ–‡çš„çº¿è·¯é€šçŸ¥æ ¼å¼ä¸ºè‹±æ–‡
                text = text.replace(/(\d+)å·çº¿[:ï¼š](.+)/, 'Route $1: $2');
                
                // æ›¿æ¢å¸¸è§ä¸­æ–‡æ–‡æœ¬
                const commonPhrases = {
                    'è½»å¾®å»¶è¯¯': 'minor delays',
                    'æ­£å¸¸æœåŠ¡': 'normal service',
                    'è½¨é“ç»´ä¿®': 'track maintenance',
                    'ä¸´æ—¶å…³é—­': 'temporarily closed',
                    'é«˜å³°æ—¶æ®µ': 'peak hours',
                    'æœåŠ¡å˜æ›´': 'service changes',
                    'å¢åŠ é¢‘ç‡': 'increased frequency',
                    'æœ¬å‘¨æœ«': 'this weekend',
                    'è®¡åˆ’ç»´æŠ¤': 'scheduled maintenance',
                    'ä¹‹é—´': 'between',
                    'é™„è¿‘': 'near',
                    'é¢„è®¡': 'expected',
                    'å¯¼è‡´': 'due to',
                    'ç”±äº': 'due to',
                    'é“è·¯å·¥ç¨‹': 'road works',
                    'æœåŠ¡å·²æ¢å¤': 'service has resumed',
                    'æ—©å…ˆçš„ä¸­æ–­': 'earlier disruption'
                };
                
                for (const [cn, en] of Object.entries(commonPhrases)) {
                    text = text.replace(new RegExp(cn, 'g'), en);
                }
            } else if (currentLang === 'zh') {
                // è½¬æ¢è‹±æ–‡çš„çº¿è·¯é€šçŸ¥æ ¼å¼ä¸ºä¸­æ–‡
                text = text.replace(/Route (\d+): (.+)/, '$1å·çº¿: $2');
                
                // æ›¿æ¢å¸¸è§è‹±æ–‡æ–‡æœ¬
                const commonPhrases = {
                    'minor delays': 'è½»å¾®å»¶è¯¯',
                    'normal service': 'æ­£å¸¸æœåŠ¡',
                    'track maintenance': 'è½¨é“ç»´ä¿®',
                    'temporarily closed': 'ä¸´æ—¶å…³é—­',
                    'peak hours': 'é«˜å³°æ—¶æ®µ',
                    'service changes': 'æœåŠ¡å˜æ›´',
                    'increased frequency': 'å¢åŠ é¢‘ç‡',
                    'this weekend': 'æœ¬å‘¨æœ«',
                    'scheduled maintenance': 'è®¡åˆ’ç»´æŠ¤',
                    'between': 'ä¹‹é—´',
                    'near': 'é™„è¿‘',
                    'expected': 'é¢„è®¡',
                    'due to': 'ç”±äº',
                    'road works': 'é“è·¯å·¥ç¨‹',
                    'service has resumed': 'æœåŠ¡å·²æ¢å¤',
                    'earlier disruption': 'æ—©å…ˆçš„ä¸­æ–­'
                };
                
                for (const [en, cn] of Object.entries(commonPhrases)) {
                    text = text.replace(new RegExp(en, 'gi'), cn);
                }
            }
            
            const danmaku = document.createElement('div');
            danmaku.className = 'danmaku';
            danmaku.textContent = text;
            
            // éšæœºé¢œè‰²
            const colors = ['#ffffff', '#ff9900', '#00cc99', '#66ccff', '#ff6666', '#cc99ff'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            danmaku.style.color = color;
            
            // éšæœºè¡Œé«˜ä½ç½®ï¼Œé¿å…é‡å 
            const lane = Math.floor(Math.random() * 8);
            danmaku.style.top = (lane * 40 + 20) + 'px';
            
            // è®¡ç®—åŠ¨ç”»æŒç»­æ—¶é—´ï¼ˆæ ¹æ®æ–‡æœ¬é•¿åº¦è°ƒæ•´ï¼‰
            // å¢åŠ åŸºç¡€æ—¶é—´å’Œéšæœºæ—¶é—´ï¼Œä½¿å¼¹å¹•é€Ÿåº¦å˜æ…¢
            const duration = 10 + Math.random() * 5; // åŸæ¥æ˜¯5+3ï¼Œç°åœ¨æ”¹ä¸º10+5
            danmaku.style.animationDuration = duration + 's';
            
            // æ·»åŠ åˆ°å®¹å™¨
            danmakuContainer.appendChild(danmaku);
            
            // æ·»åŠ åˆ°æ´»åŠ¨å¼¹å¹•åˆ—è¡¨
            activeDanmakus.push(danmaku);
            
            // åŠ¨ç”»ç»“æŸååˆ é™¤
            setTimeout(() => {
                danmaku.remove();
                const index = activeDanmakus.indexOf(danmaku);
                if (index > -1) {
                    activeDanmakus.splice(index, 1);
                }
            }, duration * 1000);
        }
        
        // åˆå§‹åŒ–å¼¹å¹•ç³»ç»Ÿ
        function initDanmakuSystem() {
            // æ¸…ç©ºç°æœ‰é˜Ÿåˆ—
            danmakuQueue.length = 0;
            
            // æ·»åŠ ç”µè½¦å…¬å‘Šåˆ°é˜Ÿåˆ—
            const announcements = currentLang === 'zh' ? tramAnnouncementsCN : tramAnnouncements;
            announcements.forEach(announcement => {
                danmakuQueue.push(announcement);
            });
            
            // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
            danmakuQueue.push(currentLang === 'zh' ? "æ¬¢è¿ä½¿ç”¨PtvAlertåœ°å›¾æŠ¥å‘Šç³»ç»Ÿ" : "Welcome to PtvAlert Map Reporting System");
            
            // å¯åŠ¨å¼¹å¹•å¤„ç†
            if (!danmakuRunning) {
                processDanmakuQueue();
            }
        }
        
        // æ·»åŠ åˆ·æ–°ç”µè½¦ä¿¡æ¯æŒ‰é’®
        function addRefreshTramButton() {
            const refreshBtn = document.createElement('button');
            refreshBtn.id = 'refreshTramBtn';
            refreshBtn.style.cssText = 'position:fixed;top:60px;left:18px;z-index:1001;background:rgba(255,255,255,0.8);color:#333;border-radius:20px;padding:6px 12px;font-size:14px;font-weight:bold;box-shadow:0 2px 12px rgba(0,0,0,0.18);border:2px solid #0071e3;cursor:pointer;display:flex;align-items:center;gap:6px;';
            refreshBtn.innerHTML = `<span style="font-size:16px;">ğŸšƒ</span><span id="refreshTramText">${i18n[currentLang].refreshTramInfo}</span>`;
            
            refreshBtn.addEventListener('click', function() {
                initDanmakuSystem();
            });
            
            document.body.appendChild(refreshBtn);
        }
        
        // æ‰“å¼€ç®¡ç†å‘˜é¢æ¿
        function openAdminPanel() {
            if (!isCurrentUserAdmin) return;
            
            // æ›´æ–°é¢æ¿è¯­è¨€
            updateAdminPanelLanguage();
            
            // æ˜¾ç¤ºç®¡ç†å‘˜é¢æ¿
            const adminPanel = document.getElementById('adminPanel');
            adminPanel.style.display = 'flex';
            
            // åŠ è½½æŠ¥å‘Šåˆ—è¡¨å’Œç”¨æˆ·åˆ—è¡¨
            loadReportsForAdmin();
            loadUsersForAdmin();
            
            // åŠ è½½å½“å‰å…¨å±€å…¬å‘Š
            loadGlobalAnnouncement();
        }
        
        // å…³é—­ç®¡ç†å‘˜é¢æ¿
        function closeAdminPanel() {
            const adminPanel = document.getElementById('adminPanel');
            adminPanel.style.display = 'none';
        }
        
        // æ›´æ–°ç®¡ç†å‘˜é¢æ¿è¯­è¨€
        function updateAdminPanelLanguage() {
            // æ ‡é¢˜å’Œå…³é—­æŒ‰é’®
            document.getElementById('adminPanelTitle').textContent = i18n[currentLang].adminPanel;
            
            // å…¬å‘Šéƒ¨åˆ†
            document.getElementById('adminAnnouncementTitle').textContent = i18n[currentLang].announcements;
            document.getElementById('adminAnnouncementLabel').textContent = i18n[currentLang].announcementContent;
            document.getElementById('adminAnnouncementTypeLabel').textContent = i18n[currentLang].announcementType;
            document.getElementById('publishAnnouncement').textContent = i18n[currentLang].publishTempAnnouncement;
            document.getElementById('publishGlobalAnnouncement').textContent = i18n[currentLang].publishGlobalAnnouncement;
            document.getElementById('clearGlobalAnnouncement').textContent = i18n[currentLang].clearGlobalAnnouncement;
            
            // æŠ¥å‘Šç®¡ç†éƒ¨åˆ†
            document.getElementById('adminReportsTitle').textContent = i18n[currentLang].reportsManagement;
            document.getElementById('adminReportsFilterLabel').textContent = i18n[currentLang].filterCondition;
            document.getElementById('reportIdHeader').textContent = i18n[currentLang].id;
            document.getElementById('reportTimeHeader').textContent = i18n[currentLang].time;
            document.getElementById('reportUserHeader').textContent = i18n[currentLang].user;
            document.getElementById('reportDescHeader').textContent = i18n[currentLang].description;
            document.getElementById('reportActionsHeader').textContent = i18n[currentLang].actions;
            document.getElementById('refreshReportsBtn').textContent = i18n[currentLang].refresh;
            
            // ç”¨æˆ·ç®¡ç†éƒ¨åˆ†
            document.getElementById('adminUsersTitle').textContent = i18n[currentLang].userManagement;
            document.getElementById('adminUserManageLabel').textContent = i18n[currentLang].userIdOrEmail;
            document.getElementById('banUserBtn').textContent = i18n[currentLang].banUser;
            document.getElementById('unbanUserBtn').textContent = i18n[currentLang].unbanUser;
            document.getElementById('promoteToAdminBtn').textContent = i18n[currentLang].promoteAdmin;
            document.getElementById('removeAdminBtn').textContent = i18n[currentLang].removeAdmin;
            document.getElementById('userIdHeader').textContent = i18n[currentLang].id;
            document.getElementById('userNameHeader').textContent = i18n[currentLang].userName;
            document.getElementById('userStatusHeader').textContent = i18n[currentLang].status;
            document.getElementById('userRoleHeader').textContent = i18n[currentLang].role;
            document.getElementById('userActionsHeader').textContent = i18n[currentLang].actions;
            document.getElementById('refreshUsersBtn').textContent = i18n[currentLang].refresh;
            
            // æ›´æ–°ä¸‹æ‹‰é€‰é¡¹
            const announcementTypeSelect = document.getElementById('announcementType');
            announcementTypeSelect.innerHTML = `
                <option value="warning">${i18n[currentLang].warning}</option>
                <option value="error">${i18n[currentLang].error}</option>
                <option value="info">${i18n[currentLang].info}</option>
            `;
        }
        
        // å‘å¸ƒä¸´æ—¶å…¬å‘Š
        function publishTemporaryAnnouncement() {
            const announcementText = document.getElementById('announcementText').value.trim();
            if (!announcementText) return;
            
            const announcementType = document.getElementById('announcementType').value;
            
            // åˆ›å»ºä¸´æ—¶å…¬å‘Šå…ƒç´ 
            const announcementEl = document.createElement('div');
            announcementEl.className = `admin-announcement ${announcementType}`;
            
            const contentEl = document.createElement('div');
            contentEl.className = 'admin-announcement-content';
            contentEl.textContent = announcementText;
            announcementEl.appendChild(contentEl);
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'admin-announcement-close';
            closeBtn.innerHTML = '&times;';
            closeBtn.addEventListener('click', function() {
                announcementEl.remove();
            });
            announcementEl.appendChild(closeBtn);
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(announcementEl);
            
            // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (document.body.contains(announcementEl)) {
                    announcementEl.remove();
                }
            }, 10000);
            
            // ä¿å­˜åˆ°æ•°æ®åº“ä½œä¸ºå†å²è®°å½•
            const newAnnouncement = {
                text: announcementText,
                type: announcementType,
                time: new Date().toISOString(),
                userId: currentUserId,
                userName: document.getElementById('userDisplayName').textContent,
                temporary: true
            };
            
            announcementsRef.push(newAnnouncement)
                .then(() => {
                    console.log('ä¸´æ—¶å…¬å‘Šå·²ä¿å­˜åˆ°æ•°æ®åº“');
                })
                .catch((error) => {
                    console.error('ä¿å­˜å…¬å‘Šå‡ºé”™:', error);
                });
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('announcementText').value = '';
            
            // å°†å…¬å‘Šä½œä¸ºå¼¹å¹•å‘é€
            sendDanmaku(`ğŸ“¢ ${announcementText}`);
        }
        
        // åŠ è½½ç”¨æˆ·åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰
        function loadUsersForAdmin() {
            if (!isCurrentUserAdmin) return;
            
            // è·å–ç”¨æˆ·åˆ—è¡¨
            // å®é™…ä¸Šï¼Œç”±äºFirebase Realtime DBçš„é™åˆ¶ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥è·å–æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨
            // åœ¨çœŸå®ç¯å¢ƒä¸­ï¼Œåº”è¯¥åˆ›å»ºä¸€ä¸ªç”¨æˆ·ç®¡ç†é›†åˆæ¥å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
            
            // ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨reportsä¸­çš„ç”¨æˆ·æ•°æ®
            const usersTableBody = document.getElementById('usersTableBody');
            usersTableBody.innerHTML = '';
            
            // å…ˆåŠ è½½æ‰€æœ‰ç®¡ç†å‘˜ç”¨æˆ·
            adminUsersRef.once('value')
                .then((snapshot) => {
                    let adminUsers = {};
                    if (snapshot.exists()) {
                        adminUsers = snapshot.val();
                    }
                    
                    // å†åŠ è½½æ‰€æœ‰å°ç¦ç”¨æˆ·
                    return bannedUsersRef.once('value').then(bannedSnapshot => {
                        let bannedUsers = {};
                        if (bannedSnapshot.exists()) {
                            bannedUsers = bannedSnapshot.val();
                        }
                        
                        // ç°åœ¨åŠ è½½æŠ¥å‘Šä¸­çš„ç”¨æˆ·æ•°æ®
                        return reportsRef.once('value').then(reportsSnapshot => {
                            const users = {};
                            
                            // ä»æŠ¥å‘Šä¸­æå–ç”¨æˆ·ä¿¡æ¯
                            if (reportsSnapshot.exists()) {
                                reportsSnapshot.forEach(report => {
                                    const reportData = report.val();
                                    if (reportData.userId) {
                                        if (!users[reportData.userId]) {
                                            users[reportData.userId] = {
                                                id: reportData.userId,
                                                name: reportData.userName || (currentLang === 'zh' ? 'ç”¨æˆ·' : 'User'),
                                                isAdmin: adminUsers[reportData.userId] === true,
                                                isBanned: !!bannedUsers[reportData.userId],
                                                banInfo: bannedUsers[reportData.userId] || null
                                            };
                                        }
                                    }
                                });
                            }
                            
                            // æ·»åŠ å½“å‰ç”¨æˆ·ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                            if (currentUserId && !users[currentUserId]) {
                                users[currentUserId] = {
                                    id: currentUserId,
                                    name: document.getElementById('userDisplayName').textContent,
                                    isAdmin: adminUsers[currentUserId] === true,
                                    isBanned: !!bannedUsers[currentUserId],
                                    banInfo: bannedUsers[currentUserId] || null
                                };
                            }
                            
                            // å°†æ•°æ®è½¬æ¢ä¸ºæ•°ç»„
                            const usersArray = Object.values(users);
                            
                            // æŒ‰ç…§ç®¡ç†å‘˜çŠ¶æ€å’ŒIDæ’åº
                            usersArray.sort((a, b) => {
                                if (a.isAdmin && !b.isAdmin) return -1;
                                if (!a.isAdmin && b.isAdmin) return 1;
                                return a.id.localeCompare(b.id);
                            });
                            
                            if (usersArray.length > 0) {
                                usersArray.forEach(user => {
                                    const row = document.createElement('tr');
                                    
                                    // IDåˆ—
                                    const idCell = document.createElement('td');
                                    idCell.textContent = user.id;
                                    row.appendChild(idCell);
                                    
                                    // ç”¨æˆ·ååˆ—
                                    const nameCell = document.createElement('td');
                                    nameCell.textContent = user.name;
                                    row.appendChild(nameCell);
                                    
                                    // çŠ¶æ€åˆ—
                                    const statusCell = document.createElement('td');
                                    statusCell.textContent = user.isBanned ? 
                                        i18n[currentLang].banned : 
                                        i18n[currentLang].active;
                                    statusCell.style.color = user.isBanned ? '#ff3b30' : '#34c759';
                                    row.appendChild(statusCell);
                                    
                                    // è§’è‰²åˆ—
                                    const roleCell = document.createElement('td');
                                    roleCell.textContent = user.isAdmin ? 
                                        i18n[currentLang].admin : 
                                        i18n[currentLang].normalUser;
                                    if (user.isAdmin) {
                                        roleCell.style.fontWeight = 'bold';
                                        roleCell.style.color = '#ff9500';
                                    }
                                    row.appendChild(roleCell);
                                    
                                    // æ“ä½œåˆ—
                                    const actionCell = document.createElement('td');
                                    
                                    // ç¦æ­¢å¯¹è‡ªå·±æ‰§è¡Œæ“ä½œ
                                    if (user.id !== currentUserId) {
                                        // å°ç¦/è§£å°æŒ‰é’®
                                        const banBtn = document.createElement('button');
                                        if (user.isBanned) {
                                            banBtn.textContent = 'ğŸ”“';
                                            banBtn.title = i18n[currentLang].unbanUser;
                                            banBtn.addEventListener('click', () => unbanUser(user.id));
                                        } else {
                                            banBtn.textContent = 'ğŸ”’';
                                            banBtn.title = i18n[currentLang].banUser;
                                            banBtn.addEventListener('click', () => confirmBanUser(user.id, user.name));
                                        }
                                        banBtn.style.cssText = 'background:none;border:none;cursor:pointer;font-size:16px;padding:5px;';
                                        actionCell.appendChild(banBtn);
                                        
                                        // ç®¡ç†å‘˜æƒé™æŒ‰é’®
                                        const adminBtn = document.createElement('button');
                                        if (report.isAdmin) {
                                            adminBtn.textContent = 'â¬‡ï¸';
                                            adminBtn.title = i18n[currentLang].removeAdmin;
                                            adminBtn.addEventListener('click', () => removeAdminRole(report.userId));
                                        } else {
                                            adminBtn.textContent = 'â¬†ï¸';
                                            adminBtn.title = i18n[currentLang].promoteAdmin;
                                            adminBtn.addEventListener('click', () => grantAdminRole(report.userId));
                                        }
                                        adminBtn.style.cssText = 'background:none;border:none;cursor:pointer;font-size:16px;padding:5px;';
                                        actionCell.appendChild(adminBtn);
                                    } else {
                                        actionCell.textContent = currentLang === 'zh' ? 'ï¼ˆå½“å‰ç”¨æˆ·ï¼‰' : '(Current User)';
                                        actionCell.style.color = '#999';
                                        actionCell.style.fontStyle = 'italic';
                                    }
                                    
                                    row.appendChild(actionCell);
                                    
                                    usersTableBody.appendChild(row);
                                });
                            } else {
                                const emptyRow = document.createElement('tr');
                                const emptyCell = document.createElement('td');
                                emptyCell.colSpan = 5;
                                emptyCell.textContent = currentLang === 'zh' ? 'æ²¡æœ‰ç”¨æˆ·æ•°æ®' : 'No users found';
                                emptyCell.style.textAlign = 'center';
                                emptyCell.style.padding = '20px';
                                emptyRow.appendChild(emptyCell);
                                usersTableBody.appendChild(emptyRow);
                            }
                        });
                    });
                })
                .catch((error) => {
                    console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å‡ºé”™:', error);
                    
                    const usersTableBody = document.getElementById('usersTableBody');
                    usersTableBody.innerHTML = '';
                    
                    const errorRow = document.createElement('tr');
                    const errorCell = document.createElement('td');
                    errorCell.colSpan = 5;
                    errorCell.textContent = currentLang === 'zh' ? 'åŠ è½½ç”¨æˆ·å‡ºé”™' : 'Error loading users';
                    errorCell.style.textAlign = 'center';
                    errorCell.style.padding = '20px';
                    errorCell.style.color = '#ff3b30';
                    errorRow.appendChild(errorCell);
                    usersTableBody.appendChild(errorRow);
                });
        }
        
        // ç¡®è®¤å°ç¦ç”¨æˆ·
        function confirmBanUser(userId, userName) {
            if (!isCurrentUserAdmin || userId === currentUserId) return;
            
            // åˆ›å»ºç¡®è®¤å¼¹çª—
            const confirmDiv = document.createElement('div');
            confirmDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:rgba(40,40,40,0.95);border-radius:8px;padding:15px;width:80%;max-width:400px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,0.7);z-index:5002;';
            
            const confirmTitle = document.createElement('h3');
            confirmTitle.textContent = i18n[currentLang].banConfirm;
            confirmTitle.style.cssText = 'margin-bottom:15px;font-size:18px;';
            confirmDiv.appendChild(confirmTitle);
            
            const userInfo = document.createElement('p');
            userInfo.textContent = `${userName} (ID: ${userId})`;
            userInfo.style.cssText = 'margin-bottom:15px;font-size:14px;background-color:rgba(255,255,255,0.1);padding:8px;border-radius:4px;';
            confirmDiv.appendChild(userInfo);
            
            const reasonLabel = document.createElement('label');
            reasonLabel.textContent = currentLang === 'zh' ? 'å°ç¦åŸå› :' : 'Ban Reason:';
            reasonLabel.style.cssText = 'display:block;text-align:left;margin-bottom:5px;font-size:14px;';
            confirmDiv.appendChild(reasonLabel);
            
            const reasonInput = document.createElement('textarea');
            reasonInput.style.cssText = 'width:100%;padding:8px;border-radius:4px;background-color:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);color:white;margin-bottom:15px;font-size:14px;min-height:60px;';
            confirmDiv.appendChild(reasonInput);
            
            const btnContainer = document.createElement('div');
            btnContainer.style.cssText = 'display:flex;justify-content:center;gap:15px;';
            
            // ç¡®è®¤æŒ‰é’®
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = i18n[currentLang].banUser;
            confirmBtn.style.cssText = 'padding:8px 16px;border-radius:4px;border:none;background-color:#e53935;color:white;cursor:pointer;';
            confirmBtn.onclick = function() {
                const reason = reasonInput.value.trim();
                banUser(userId, reason);
                confirmDiv.remove();
            };
            btnContainer.appendChild(confirmBtn);
            
            // å–æ¶ˆæŒ‰é’®
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = i18n[currentLang].cancel;
            cancelBtn.style.cssText = 'padding:8px 16px;border-radius:4px;border:none;background-color:#3a3a3c;color:white;cursor:pointer;';
            cancelBtn.onclick = function() {
                confirmDiv.remove();
            };
            btnContainer.appendChild(cancelBtn);
            
            confirmDiv.appendChild(btnContainer);
            
            // æ·»åŠ åˆ°body
            document.body.appendChild(confirmDiv);
        }
        
        // å°ç¦ç”¨æˆ·
        function banUser(userId, reason) {
            if (!isCurrentUserAdmin || userId === currentUserId) return;
            
            const banInfo = {
                reason: reason || (currentLang === 'zh' ? 'è¿åç¤¾åŒºè§„åˆ™' : 'Violation of community rules'),
                time: new Date().toISOString(),
                bannedBy: document.getElementById('userDisplayName').textContent,
                bannedById: currentUserId
            };
            
            bannedUsersRef.child(userId).set(banInfo)
                .then(() => {
                    console.log('ç”¨æˆ·å·²å°ç¦:', userId);
                    
                    // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
                    loadUsersForAdmin();
                    
                    // åˆ é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰æ ‡è®°
                    deleteAllUserMarkers(userId);
                    
                    // å‘å¸ƒä¸´æ—¶å…¬å‘Š
                    const adminName = document.getElementById('userDisplayName').textContent;
                    const announcement = currentLang === 'zh' 
                        ? `ç®¡ç†å‘˜ ${adminName} å·²å°ç¦ç”¨æˆ· ID: ${userId}` 
                        : `Admin ${adminName} has banned user ID: ${userId}`;
                    
                    const announcementEl = document.createElement('div');
                    announcementEl.className = 'admin-announcement error';
                    
                    const contentEl = document.createElement('div');
                    contentEl.className = 'admin-announcement-content';
                    contentEl.textContent = announcement;
                    announcementEl.appendChild(contentEl);
                    
                    const closeBtn = document.createElement('button');
                    closeBtn.className = 'admin-announcement-close';
                    closeBtn.innerHTML = '&times;';
                    closeBtn.addEventListener('click', function() {
                        announcementEl.remove();
                    });
                    announcementEl.appendChild(closeBtn);
                    
                    // æ·»åŠ åˆ°é¡µé¢
                    document.body.appendChild(announcementEl);
                    
                    // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
                    setTimeout(() => {
                        if (document.body.contains(announcementEl)) {
                            announcementEl.remove();
                        }
                    }, 5000);
                })
                .catch((error) => {
                    console.error('å°ç¦ç”¨æˆ·å¤±è´¥:', error);
                    alert(currentLang === 'zh' ? 'å°ç¦ç”¨æˆ·å¤±è´¥' : 'Failed to ban user');
                });
        }
        
        // åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰æ ‡è®°å’ŒæŠ¥å‘Š
        function deleteAllUserMarkers(userId) {
            if (!userId) return;
            
            console.log('æ­£åœ¨åˆ é™¤ç”¨æˆ·æ‰€æœ‰æ ‡è®°:', userId);
            
            // æŸ¥è¯¢æ‰€æœ‰å±äºè¯¥ç”¨æˆ·çš„æŠ¥å‘Š
            reportsRef.orderByChild('userId').equalTo(userId).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        // åˆ›å»ºåˆ é™¤æ“ä½œçš„æ‰¹å¤„ç†
                        const promises = [];
                        
                        snapshot.forEach((childSnapshot) => {
                            const report = childSnapshot.val();
                            const reportId = childSnapshot.key;
                            
                            console.log('åˆ é™¤ç”¨æˆ·æŠ¥å‘Š:', reportId);
                            
                            // æ·»åŠ åˆ é™¤æ“ä½œåˆ°æ‰¹å¤„ç†
                            promises.push(reportsRef.child(reportId).remove());
                            
                            // åŒæ—¶ä»åœ°å›¾ä¸Šç§»é™¤æ ‡è®°
                            const markerIndex = markers.findIndex(marker => 
                                marker.reportData && marker.reportData.id.toString() === reportId.toString()
                            );
                            
                            if (markerIndex !== -1) {
                                markers[markerIndex].setMap(null);
                                markers.splice(markerIndex, 1);
                            }
                        });
                        
                        // æ‰§è¡Œæ‰€æœ‰åˆ é™¤æ“ä½œ
                        return Promise.all(promises);
                    }
                    return null;
                })
                .then(() => {
                    console.log('å·²åˆ é™¤ç”¨æˆ·æ‰€æœ‰æŠ¥å‘Šå’Œæ ‡è®°');
                    
                    // å‘é€é€šçŸ¥
                    sendDanmaku(currentLang === 'zh' 
                        ? `å·²åˆ é™¤ç”¨æˆ· ${userId} çš„æ‰€æœ‰æŠ¥å‘Š` 
                        : `All reports from user ${userId} have been deleted`
                    );
                })
                .catch((error) => {
                    console.error('åˆ é™¤ç”¨æˆ·æŠ¥å‘Šå¤±è´¥:', error);
                });
        }
        
        // è§£é™¤ç”¨æˆ·å°ç¦
        function unbanUser(userId) {
            if (!isCurrentUserAdmin) return;
            
            bannedUsersRef.child(userId).remove()
                .then(() => {
                    console.log('ç”¨æˆ·å°ç¦å·²è§£é™¤:', userId);
                    
                    // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
                    loadUsersForAdmin();
                    
                    // å‘å¸ƒä¸´æ—¶å…¬å‘Š
                    const adminName = document.getElementById('userDisplayName').textContent;
                    const announcement = currentLang === 'zh' 
                        ? `ç®¡ç†å‘˜ ${adminName} å·²è§£é™¤ç”¨æˆ· ID: ${userId} çš„å°ç¦` 
                        : `Admin ${adminName} has unbanned user ID: ${userId}`;
                    
                    const announcementEl = document.createElement('div');
                    announcementEl.className = 'admin-announcement info';
                    
                    const contentEl = document.createElement('div');
                    contentEl.className = 'admin-announcement-content';
                    contentEl.textContent = announcement;
                    announcementEl.appendChild(contentEl);
                    
                    const closeBtn = document.createElement('button');
                    closeBtn.className = 'admin-announcement-close';
                    closeBtn.innerHTML = '&times;';
                    closeBtn.addEventListener('click', function() {
                        announcementEl.remove();
                    });
                    announcementEl.appendChild(closeBtn);
                    
                    // æ·»åŠ åˆ°é¡µé¢
                    document.body.appendChild(announcementEl);
                    
                    // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
                    setTimeout(() => {
                        if (document.body.contains(announcementEl)) {
                            announcementEl.remove();
                        }
                    }, 5000);
                })
                .catch((error) => {
                    console.error('è§£é™¤ç”¨æˆ·å°ç¦å¤±è´¥:', error);
                    alert(currentLang === 'zh' ? 'è§£é™¤å°ç¦å¤±è´¥' : 'Failed to unban user');
                });
        }
        
        // æˆäºˆç®¡ç†å‘˜æƒé™
        function grantAdminRole(userId) {
            if (!isCurrentUserAdmin) return;
            
            adminUsersRef.child(userId).set(true)
                .then(() => {
                    console.log('å·²æˆäºˆç®¡ç†å‘˜æƒé™:', userId);
                    
                    // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
                    loadUsersForAdmin();
                    
                    // å‘å¸ƒä¸´æ—¶å…¬å‘Š
                    const adminName = document.getElementById('userDisplayName').textContent;
                    const announcement = currentLang === 'zh' 
                        ? `ç”¨æˆ· ID: ${userId} å·²è¢« ${adminName} æå‡ä¸ºç®¡ç†å‘˜` 
                        : `User ID: ${userId} has been promoted to admin by ${adminName}`;
                    
                    const announcementEl = document.createElement('div');
                    announcementEl.className = 'admin-announcement warning';
                    
                    const contentEl = document.createElement('div');
                    contentEl.className = 'admin-announcement-content';
                    contentEl.textContent = announcement;
                    announcementEl.appendChild(contentEl);
                    
                    const closeBtn = document.createElement('button');
                    closeBtn.className = 'admin-announcement-close';
                    closeBtn.innerHTML = '&times;';
                    closeBtn.addEventListener('click', function() {
                        announcementEl.remove();
                    });
                    announcementEl.appendChild(closeBtn);
                    
                    // æ·»åŠ åˆ°é¡µé¢
                    document.body.appendChild(announcementEl);
                    
                    // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
                    setTimeout(() => {
                        if (document.body.contains(announcementEl)) {
                            announcementEl.remove();
                        }
                    }, 5000);
                })
                .catch((error) => {
                    console.error('æˆäºˆç®¡ç†å‘˜æƒé™å¤±è´¥:', error);
                    alert(currentLang === 'zh' ? 'æˆäºˆç®¡ç†å‘˜æƒé™å¤±è´¥' : 'Failed to grant admin role');
                });
        }
        
        // ç§»é™¤ç®¡ç†å‘˜æƒé™
        function removeAdminRole(userId) {
            if (!isCurrentUserAdmin) return;
            
            adminUsersRef.child(userId).remove()
                .then(() => {
                    console.log('å·²ç§»é™¤ç®¡ç†å‘˜æƒé™:', userId);
                    
                    // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
                    loadUsersForAdmin();
                    
                    // å‘å¸ƒä¸´æ—¶å…¬å‘Š
                    const adminName = document.getElementById('userDisplayName').textContent;
                    const announcement = currentLang === 'zh' 
                        ? `ç”¨æˆ· ID: ${userId} çš„ç®¡ç†å‘˜æƒé™å·²è¢« ${adminName} ç§»é™¤` 
                        : `Admin privileges for user ID: ${userId} have been revoked by ${adminName}`;
                    
                    const announcementEl = document.createElement('div');
                    announcementEl.className = 'admin-announcement info';
                    
                    const contentEl = document.createElement('div');
                    contentEl.className = 'admin-announcement-content';
                    contentEl.textContent = announcement;
                    announcementEl.appendChild(contentEl);
                    
                    const closeBtn = document.createElement('button');
                    closeBtn.className = 'admin-announcement-close';
                    closeBtn.innerHTML = '&times;';
                    closeBtn.addEventListener('click', function() {
                        announcementEl.remove();
                    });
                    announcementEl.appendChild(closeBtn);
                    
                    // æ·»åŠ åˆ°é¡µé¢
                    document.body.appendChild(announcementEl);
                    
                    // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
                    setTimeout(() => {
                        if (document.body.contains(announcementEl)) {
                            announcementEl.remove();
                        }
                    }, 5000);
                })
                .catch((error) => {
                    console.error('ç§»é™¤ç®¡ç†å‘˜æƒé™å¤±è´¥:', error);
                    alert(currentLang === 'zh' ? 'ç§»é™¤ç®¡ç†å‘˜æƒé™å¤±è´¥' : 'Failed to remove admin role');
                });
        }
        
        // å°†å…¬å‘Šä½œä¸ºå¼¹å¹•å‘é€
        function sendDanmaku(text) {
            // é™åˆ¶é•¿åº¦ï¼Œè¿‡é•¿çš„æ–‡æœ¬ä¼šè¢«æˆªæ–­
            const maxLength = 30;
            let danmakuText = text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
            
            // å¦‚æœæ–‡æœ¬ä¸ºç©ºï¼Œä¸æ˜¾ç¤ºå¼¹å¹•
            if (!danmakuText.trim()) return;
            
            // å°è¯•æ ¹æ®å½“å‰è¯­è¨€è¿›è¡Œç¿»è¯‘
            if (currentLang === 'en') {
                // å¦‚æœå½“å‰æ˜¯è‹±æ–‡ç•Œé¢ï¼Œä½†å†…å®¹åŒ…å«ä¸­æ–‡å­—ç¬¦ï¼Œå°è¯•è½¬ä¸ºè‹±æ–‡
                if (/[\u4e00-\u9fa5]/.test(danmakuText)) {
                    // ç®€å•çš„ä¸­è‹±æ–‡å…³é”®è¯æ˜ å°„
                    const cnToEnMap = {
                        'ç‹—': 'dog',
                        'çŒ«': 'cat',
                        'ä½ å¥½': 'hello',
                        'äº¤é€š': 'traffic',
                        'äº‹æ•…': 'accident',
                        'æ³¨æ„': 'attention',
                        'å°å¿ƒ': 'caution',
                        'å±é™©': 'danger',
                        'è­¦å‘Š': 'warning',
                        'å¸®åŠ©': 'help',
                        'è­¦å¯Ÿ': 'police',
                        'ç´§æ€¥æƒ…å†µ': 'emergency',
                        'æ‹¥æŒ¤': 'crowded',
                        'å»¶è¯¯': 'delayed',
                        'å–æ¶ˆ': 'cancelled',
                        'å…³é—­': 'closed',
                        'å¼€æ”¾': 'open',
                        'æ­£å¸¸': 'normal',
                        'æœåŠ¡': 'service',
                        'ç”µè½¦': 'tram',
                        'è½¨é“': 'track',
                        'ç»´ä¿®': 'maintenance',
                        'ç«™': 'stop',
                        'ä¸´æ—¶': 'temporary',
                        'é¢‘ç‡': 'frequency',
                        'é«˜å³°': 'peak',
                        'å¸‚ä¸­å¿ƒ': 'CBD',
                        'çº¿': 'route',
                        'å·çº¿': 'route',
                        'æ¸¸å®¢': 'Guest',
                        'æ·»åŠ ': 'Add',
                        'æŠ¥å‘Š': 'Report',
                        'è¯„è®º': 'Comment',
                        'æ¬¢è¿': 'Welcome',
                        'ä½¿ç”¨': 'using',
                        'åœ°å›¾': 'map',
                        'ç³»ç»Ÿ': 'system'
                    };
                    
                    // å°è¯•æ›¿æ¢ä¸­æ–‡å…³é”®è¯
                    for (const [cn, en] of Object.entries(cnToEnMap)) {
                        danmakuText = danmakuText.replace(new RegExp(cn, 'g'), en);
                    }
                    
                    // å¯¹äºå¸¸è§çš„çº¿è·¯å…¬å‘Šæ ¼å¼è¿›è¡Œç‰¹æ®Šå¤„ç†
                    danmakuText = danmakuText.replace(/(\d+)å·çº¿/g, 'Route $1');
                }
            } else if (currentLang === 'zh') {
                // å¦‚æœå½“å‰æ˜¯ä¸­æ–‡ç•Œé¢ï¼Œä½†å†…å®¹ä¸åŒ…å«ä¸­æ–‡å­—ç¬¦ï¼Œå¯èƒ½æ˜¯è‹±æ–‡
                if (!/[\u4e00-\u9fa5]/.test(danmakuText) && danmakuText.length > 5) {
                    // è¿™é‡Œå¯ä»¥æ·»åŠ è‹±æ–‡åˆ°ä¸­æ–‡çš„ç®€å•è½¬æ¢ï¼Œä½†é»˜è®¤ä¿ç•™è‹±æ–‡ä¹Ÿå¯ä»¥
                    // ç®€å•å¤„ç†Routeæ ¼å¼
                    danmakuText = danmakuText.replace(/Route (\d+)/g, '$1å·çº¿');
                }
            }
            
            // æ·»åŠ åˆ°é˜Ÿåˆ—
            danmakuQueue.push(danmakuText);
            
            // å¦‚æœå¼¹å¹•ç³»ç»Ÿæœªè¿è¡Œï¼Œå¯åŠ¨å®ƒ
            if (!danmakuRunning) {
                processDanmakuQueue();
            }
        }
        
        // å‘å¸ƒå…¨å±€é¡¶éƒ¨å…¬å‘Š
        function publishGlobalAnnouncement() {
            const announcementText = document.getElementById('announcementText').value.trim();
            if (!announcementText) return;
            
            // æ›´æ–°å…¨å±€å…¬å‘Šæ 
            const globalAnnouncementBar = document.getElementById('globalAnnouncementBar');
            const globalAnnouncementText = document.getElementById('globalAnnouncementText');
            
            globalAnnouncementText.textContent = announcementText;
            globalAnnouncementBar.style.display = 'block';
            
            // ä¿å­˜åˆ°æ•°æ®åº“
            const globalAnnouncement = {
                text: announcementText,
                time: new Date().toISOString(),
                userId: currentUserId,
                userName: document.getElementById('userDisplayName').textContent,
                active: true
            };
            
            database.ref('globalAnnouncement').set(globalAnnouncement)
                .then(() => {
                    console.log('å…¨å±€å…¬å‘Šå·²ä¿å­˜åˆ°æ•°æ®åº“');
                })
                .catch((error) => {
                    console.error('ä¿å­˜å…¨å±€å…¬å‘Šå‡ºé”™:', error);
                });
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('announcementText').value = '';
            
            // å°†å…¬å‘Šä½œä¸ºå¼¹å¹•å‘é€
            sendDanmaku(`ğŸ“¢ ${announcementText}`);
        }
        
        // æ¸…é™¤å…¨å±€å…¬å‘Š
        function clearGlobalAnnouncement() {
            // éšè—å…¨å±€å…¬å‘Šæ 
            const globalAnnouncementBar = document.getElementById('globalAnnouncementBar');
            globalAnnouncementBar.style.display = 'none';
            
            // ä»æ•°æ®åº“ä¸­åˆ é™¤å…¨å±€å…¬å‘Š
            database.ref('globalAnnouncement').remove()
                .then(() => {
                    console.log('å…¨å±€å…¬å‘Šå·²ä»æ•°æ®åº“ç§»é™¤');
                })
                .catch((error) => {
                    console.error('ç§»é™¤å…¨å±€å…¬å‘Šå‡ºé”™:', error);
                });
        }
        
        // åŠ è½½å…¨å±€å…¬å‘Š
        function loadGlobalAnnouncement() {
            database.ref('globalAnnouncement').once('value')
                .then((snapshot) => {
                    if (snapshot.exists() && snapshot.val().active) {
                        const announcement = snapshot.val();
                        
                        // æ˜¾ç¤ºå…¨å±€å…¬å‘Š
                        const globalAnnouncementBar = document.getElementById('globalAnnouncementBar');
                        const globalAnnouncementText = document.getElementById('globalAnnouncementText');
                        
                        globalAnnouncementText.textContent = announcement.text;
                        globalAnnouncementBar.style.display = 'block';
                    }
                })
                .catch((error) => {
                    console.error('åŠ è½½å…¨å±€å…¬å‘Šå‡ºé”™:', error);
                });
        }
        
        // ç§»é™¤ç®¡ç†å‘˜æƒé™
        function removeAdminRole(userId) {
            if (!isCurrentUserAdmin) return;
            
            adminUsersRef.child(userId).remove()
                .then(() => {
                    console.log('å·²ç§»é™¤ç®¡ç†å‘˜æƒé™:', userId);
                    
                    // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
                    loadUsersForAdmin();
                    
                    // å‘å¸ƒä¸´æ—¶å…¬å‘Š
                    const adminName = document.getElementById('userDisplayName').textContent;
                    const announcement = currentLang === 'zh' 
                        ? `ç”¨æˆ· ID: ${userId} çš„ç®¡ç†å‘˜æƒé™å·²è¢« ${adminName} ç§»é™¤` 
                        : `Admin privileges for user ID: ${userId} have been revoked by ${adminName}`;
                    
                    const announcementEl = document.createElement('div');
                    announcementEl.className = 'admin-announcement info';
                    
                    const contentEl = document.createElement('div');
                    contentEl.className = 'admin-announcement-content';
                    contentEl.textContent = announcement;
                    announcementEl.appendChild(contentEl);
                    
                    const closeBtn = document.createElement('button');
                    closeBtn.className = 'admin-announcement-close';
                    closeBtn.innerHTML = '&times;';
                    closeBtn.addEventListener('click', function() {
                        announcementEl.remove();
                    });
                    announcementEl.appendChild(closeBtn);
                    
                    // æ·»åŠ åˆ°é¡µé¢
                    document.body.appendChild(announcementEl);
                    
                    // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
                    setTimeout(() => {
                        if (document.body.contains(announcementEl)) {
                            announcementEl.remove();
                        }
                    }, 5000);
                })
                .catch((error) => {
                    console.error('ç§»é™¤ç®¡ç†å‘˜æƒé™å¤±è´¥:', error);
                    alert(currentLang === 'zh' ? 'ç§»é™¤ç®¡ç†å‘˜æƒé™å¤±è´¥' : 'Failed to remove admin role');
                });
        }
        
        // åŠ è½½æŠ¥å‘Šåˆ—è¡¨ï¼ˆç®¡ç†å‘˜ç”¨ï¼‰
        function loadReportsForAdmin() {
            reportsRef.orderByChild('time').once('value')
                .then((snapshot) => {
                    const reportsTableBody = document.getElementById('reportsTableBody');
                    reportsTableBody.innerHTML = '';
                    
                    if (snapshot.exists()) {
                        // å°†æ•°æ®è½¬æ¢ä¸ºæ•°ç»„ä»¥ä¾¿æ’åº
                        const reports = [];
                        snapshot.forEach((childSnapshot) => {
                            reports.push({
                                id: childSnapshot.key,
                                ...childSnapshot.val()
                            });
                        });
                        
                        // æŒ‰æ—¶é—´å€’åºæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                        reports.sort((a, b) => new Date(b.time) - new Date(a.time));
                        
                        // æ˜¾ç¤ºæœ€è¿‘çš„50æ¡æŠ¥å‘Š
                        const recentReports = reports.slice(0, 50);
                        
                        recentReports.forEach((report) => {
                            const row = document.createElement('tr');
                            
                            // IDåˆ—
                            const idCell = document.createElement('td');
                            idCell.textContent = report.id;
                            row.appendChild(idCell);
                            
                            // æ—¶é—´åˆ—
                            const timeCell = document.createElement('td');
                            timeCell.textContent = new Date(report.time).toLocaleString();
                            row.appendChild(timeCell);
                            
                            // ç”¨æˆ·åˆ—
                            const userCell = document.createElement('td');
                            userCell.textContent = report.userName || (currentLang === 'zh' ? 'ç”¨æˆ·' : 'User');
                            row.appendChild(userCell);
                            
                            // æè¿°åˆ—
                            const descCell = document.createElement('td');
                            descCell.textContent = report.description ? 
                                (report.description.length > 30 ? report.description.substring(0, 30) + '...' : report.description) : 
                                (currentLang === 'zh' ? 'æ— æè¿°' : 'No description');
                            row.appendChild(descCell);
                            
                            // æ“ä½œåˆ—
                            const actionCell = document.createElement('td');
                            
                            // æŸ¥çœ‹æŒ‰é’®
                            const viewBtn = document.createElement('button');
                            viewBtn.textContent = 'ğŸ‘ï¸';
                            viewBtn.title = currentLang === 'zh' ? 'æŸ¥çœ‹' : 'View';
                            viewBtn.style.cssText = 'background:none;border:none;cursor:pointer;font-size:16px;padding:5px;';
                            viewBtn.addEventListener('click', () => {
                                // ä¼ é€’æŠ¥å‘Šæ•°æ®ç»™showReportDetails
                                showReportDetails(report);
                            });
                            actionCell.appendChild(viewBtn);
                            
                            // åˆ é™¤æŒ‰é’®
                            const deleteBtn = document.createElement('button');
                            deleteBtn.textContent = 'ğŸ—‘ï¸';
                            deleteBtn.title = currentLang === 'zh' ? 'åˆ é™¤' : 'Delete';
                            deleteBtn.style.cssText = 'background:none;border:none;cursor:pointer;font-size:16px;padding:5px;color:#ff3b30;';
                            deleteBtn.addEventListener('click', () => {
                                confirmDeleteReportAdmin(report.id);
                            });
                            actionCell.appendChild(deleteBtn);
                            
                            row.appendChild(actionCell);
                            
                            reportsTableBody.appendChild(row);
                        });
                    } else {
                        const emptyRow = document.createElement('tr');
                        const emptyCell = document.createElement('td');
                        emptyCell.colSpan = 5;
                        emptyCell.textContent = currentLang === 'zh' ? 'æ²¡æœ‰æŠ¥å‘Šæ•°æ®' : 'No reports found';
                        emptyCell.style.textAlign = 'center';
                        emptyCell.style.padding = '20px';
                        emptyRow.appendChild(emptyCell);
                        reportsTableBody.appendChild(emptyRow);
                    }
                })
                .catch((error) => {
                    console.error('åŠ è½½æŠ¥å‘Šåˆ—è¡¨å‡ºé”™:', error);
                    
                    const reportsTableBody = document.getElementById('reportsTableBody');
                    reportsTableBody.innerHTML = '';
                    
                    const errorRow = document.createElement('tr');
                    const errorCell = document.createElement('td');
                    errorCell.colSpan = 5;
                    errorCell.textContent = currentLang === 'zh' ? 'åŠ è½½æŠ¥å‘Šå‡ºé”™' : 'Error loading reports';
                    errorCell.style.textAlign = 'center';
                    errorCell.style.padding = '20px';
                    errorCell.style.color = '#ff3b30';
                    errorRow.appendChild(errorCell);
                    reportsTableBody.appendChild(errorRow);
                });
        }
        
        // ç¡®è®¤åˆ é™¤æŠ¥å‘Šï¼ˆç®¡ç†å‘˜ï¼‰
        function confirmDeleteReportAdmin(reportId) {
            if (!isCurrentUserAdmin) return;
            
            // åˆ›å»ºç¡®è®¤å¼¹çª—
            const confirmDiv = document.createElement('div');
            confirmDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:rgba(40,40,40,0.95);border-radius:8px;padding:15px;width:80%;max-width:400px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,0.7);z-index:5002;'; // ä¿®æ”¹z-indexä¸º5002ï¼Œé«˜äºç®¡ç†å‘˜é¢æ¿çš„5000
            
            const confirmText = document.createElement('p');
            confirmText.textContent = i18n[currentLang].confirmDelete;
            confirmText.style.cssText = 'margin-bottom:15px;font-size:16px;';
            confirmDiv.appendChild(confirmText);
            
            const btnContainer = document.createElement('div');
            btnContainer.style.cssText = 'display:flex;justify-content:center;gap:15px;';
            
            // ç¡®è®¤æŒ‰é’®
            const yesBtn = document.createElement('button');
            yesBtn.textContent = i18n[currentLang].yes;
            yesBtn.style.cssText = 'padding:8px 16px;border-radius:4px;border:none;background-color:#e53935;color:white;cursor:pointer;';
            yesBtn.onclick = function() {
                deleteReportAdmin(reportId);
                confirmDiv.remove();
            };
            btnContainer.appendChild(yesBtn);
            
            // å–æ¶ˆæŒ‰é’®
            const noBtn = document.createElement('button');
            noBtn.textContent = i18n[currentLang].no;
            noBtn.style.cssText = 'padding:8px 16px;border-radius:4px;border:none;background-color:#3a3a3c;color:white;cursor:pointer;';
            noBtn.onclick = function() {
                confirmDiv.remove();
            };
            btnContainer.appendChild(noBtn);
            
            confirmDiv.appendChild(btnContainer);
            
            // æ·»åŠ åˆ°body
            document.body.appendChild(confirmDiv);
        }
        
        // ç®¡ç†å‘˜åˆ é™¤æŠ¥å‘Š
        function deleteReportAdmin(reportId) {
            if (!isCurrentUserAdmin) return;
            
            reportsRef.child(reportId.toString()).remove()
                .then(() => {
                    console.log('ç®¡ç†å‘˜åˆ é™¤æŠ¥å‘ŠæˆåŠŸ:', reportId);
                    
                    // é‡æ–°åŠ è½½æŠ¥å‘Šåˆ—è¡¨
                    loadReportsForAdmin();
                    
                    // åˆ é™¤å¯¹åº”çš„æ ‡è®°
                    const markerIndex = markers.findIndex(marker => marker.reportData && marker.reportData.id == reportId);
                    if (markerIndex !== -1) {
                        markers[markerIndex].setMap(null);
                        markers.splice(markerIndex, 1);
                    }
                    
                    // å‘å¸ƒä¸´æ—¶å…¬å‘Š
                    const adminName = document.getElementById('userDisplayName').textContent;
                    const announcement = currentLang === 'zh' 
                        ? `ç®¡ç†å‘˜ ${adminName} å·²åˆ é™¤æŠ¥å‘Š ID: ${reportId}` 
                        : `Admin ${adminName} has deleted report ID: ${reportId}`;
                    
                    const announcementEl = document.createElement('div');
                    announcementEl.className = 'admin-announcement info';
                    
                    const contentEl = document.createElement('div');
                    contentEl.className = 'admin-announcement-content';
                    contentEl.textContent = announcement;
                    announcementEl.appendChild(contentEl);
                    
                    const closeBtn = document.createElement('button');
                    closeBtn.className = 'admin-announcement-close';
                    closeBtn.innerHTML = '&times;';
                    closeBtn.addEventListener('click', function() {
                        announcementEl.remove();
                    });
                    announcementEl.appendChild(closeBtn);
                    
                    // æ·»åŠ åˆ°é¡µé¢
                    document.body.appendChild(announcementEl);
                    
                    // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
                    setTimeout(() => {
                        if (document.body.contains(announcementEl)) {
                            announcementEl.remove();
                        }
                    }, 5000);
                })
                .catch((error) => {
                    console.error('ç®¡ç†å‘˜åˆ é™¤æŠ¥å‘Šå¤±è´¥:', error);
                    
                    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                    const errorAnnouncement = document.createElement('div');
                    errorAnnouncement.className = 'admin-announcement error';
                    
                    const errorContent = document.createElement('div');
                    errorContent.className = 'admin-announcement-content';
                    errorContent.textContent = currentLang === 'zh' 
                        ? 'åˆ é™¤æŠ¥å‘Šå¤±è´¥: ' + error.message 
                        : 'Failed to delete report: ' + error.message;
                    errorAnnouncement.appendChild(errorContent);
                    
                    const closeBtn = document.createElement('button');
                    closeBtn.className = 'admin-announcement-close';
                    closeBtn.innerHTML = '&times;';
                    closeBtn.addEventListener('click', function() {
                        errorAnnouncement.remove();
                    });
                    errorAnnouncement.appendChild(closeBtn);
                    
                    // æ·»åŠ åˆ°é¡µé¢
                    document.body.appendChild(errorAnnouncement);
                    
                    // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
                    setTimeout(() => {
                        if (document.body.contains(errorAnnouncement)) {
                            errorAnnouncement.remove();
                        }
                    }, 5000);
                });
        }
    </script>
    
    <!-- æ·»åŠ Google Maps API -->
    <script>
        // Google Maps API åŠ è½½å›è°ƒ
        function googleMapsLoadedCallback() {
            console.log("Google Maps å·²åŠ è½½ï¼Œåˆå§‹åŒ–åœ°å›¾...");
            
            // å¦‚æœinitMapå‡½æ•°å­˜åœ¨ï¼Œè°ƒç”¨å®ƒ
            if (typeof initMap === 'function') {
                initMap();
            }
            
            // åªæœ‰å½“addRefreshTramButtonå‡½æ•°å­˜åœ¨æ—¶æ‰è°ƒç”¨å®ƒ
            if (typeof addRefreshTramButton === 'function') {
                addRefreshTramButton();
            }
        }
    </script>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCE-oMIlcnOeqplgMmL9y1qcU6A9-HBu9U&callback=googleMapsLoadedCallback&libraries=places,visualization&v=weekly" onerror="console.error('Google Maps åŠ è½½å¤±è´¥')"></script>
    
    <!-- DOMå°±ç»ªååˆå§‹åŒ– -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOMå·²åŠ è½½ï¼Œæ£€æŸ¥ç™»å½•çŠ¶æ€...");
            
            // é¦–å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼Œå¦‚æœæœªç™»å½•åˆ™é‡å®šå‘åˆ°ç™»å½•é¡µé¢
            const userLoggedIn = localStorage.getItem('userLoggedIn') === 'true';
            if (!userLoggedIn) {
                console.log('ç”¨æˆ·æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ...');
                window.location.href = 'login.html';
                return;
            }
            
            console.log("ç”¨æˆ·å·²ç™»å½•ï¼Œç­‰å¾…Google Maps APIå›è°ƒ...");
            
            // åˆå§‹åŒ–Firebaseåˆ°CloudflareåŒæ­¥ç³»ç»Ÿ
            if (typeof window.firebaseCloudflareSync !== 'undefined') {
                console.log('åˆå§‹åŒ–Firebaseåˆ°CloudflareåŒæ­¥ç³»ç»Ÿ...');
                window.firebaseCloudflareSync.init();
            }
            
            // å…³é—­æŠ¥å‘Šè®¡æ•°å™¨å¼¹çª—æŒ‰é’®äº‹ä»¶
            document.getElementById('closeCounterPopup').addEventListener('click', function() {
                closeReportCounterPopup();
            });
            
            // æ·»åŠ æŠ¥å‘ŠæŒ‰é’®äº‹ä»¶
            document.getElementById('addReportBtn').addEventListener('click', function(e) {
                e.preventDefault();
                if (isSelectingLocation) return;
                
                isSelectingLocation = true;
                document.getElementById('addReportTip').style.display = 'inline';
                document.getElementById('addReportTip').textContent = i18n[currentLang].selectLocation;
                document.getElementById('addReportBtn').textContent = i18n[currentLang].selecting;
                document.body.style.cursor = 'crosshair';
            });
            
            // è¯­è¨€åˆ‡æ¢æŒ‰é’®äº‹ä»¶
            document.getElementById('langSwitchBtn').addEventListener('click', function() {
                // åˆ‡æ¢è¯­è¨€
                currentLang = currentLang === 'zh' ? 'en' : 'zh';
                
                // æ›´æ–°ç•Œé¢æ–‡æœ¬
                updateFormLanguage();
                
                // æ›´æ–°è¯­è¨€åˆ‡æ¢æŒ‰é’®æ–‡æœ¬
                document.getElementById('langSwitchText').textContent = currentLang === 'zh' ? 'EN' : 'ä¸­';
                
                // å­˜å‚¨è¯­è¨€è®¾ç½®
                localStorage.setItem('language', currentLang);
                
                // æ›´æ–°åˆ·æ–°ç”µè½¦æŒ‰é’®æ–‡æœ¬
                document.getElementById('refreshTramText').textContent = i18n[currentLang].refreshTramInfo;
                
                // å¦‚æœæ˜¯æ¸¸å®¢æ¨¡å¼ï¼Œæ›´æ–°æ¸¸å®¢æ˜¾ç¤ºæ ‡ç­¾
                if (localStorage.getItem('isGuestUser') === 'true') {
                    document.getElementById('userDisplayName').textContent = currentLang === 'zh' ? 'æ¸¸å®¢' : 'Guest';
                }
                
                // é‡æ–°åˆå§‹åŒ–å¼¹å¹•ç³»ç»Ÿï¼Œä½¿å…¶ä½¿ç”¨å½“å‰è¯­è¨€
                initDanmakuSystem();
                
                console.log('è¯­è¨€å·²åˆ‡æ¢ä¸º:', currentLang);
            });
            
            // è¡¨å•å…³é—­æŒ‰é’®äº‹ä»¶
            document.getElementById('formClose').addEventListener('click', function() {
                closeReportForm();
            });
            
            // å–æ¶ˆæŒ‰é’®äº‹ä»¶
            document.getElementById('cancelReport').addEventListener('click', function() {
                closeReportForm();
            });
            
            // é‡æ–°é€‰ç‚¹æŒ‰é’®äº‹ä»¶
            document.getElementById('resetLocationBtn').addEventListener('click', function() {
                closeReportForm();
                
                // å»¶è¿Ÿä¸€ç‚¹å¯åŠ¨é€‰ç‚¹æ¨¡å¼ï¼Œè®©è¡¨å•æœ‰æ—¶é—´å…³é—­
                setTimeout(function() {
                    isSelectingLocation = true;
                    document.getElementById('addReportTip').style.display = 'inline';
                    document.getElementById('addReportTip').textContent = i18n[currentLang].selectLocation;
                    document.getElementById('addReportBtn').textContent = i18n[currentLang].selecting;
                    document.body.style.cursor = 'crosshair';
                }, 300);
            });
            
            // æ ¹æ®æè¿°å®šä½æŒ‰é’®äº‹ä»¶
            document.getElementById('geocodeLocationBtn').addEventListener('click', function() {
                geocodeDescription();
            });
            
            // è·å–å½“å‰ä½ç½®æŒ‰é’®äº‹ä»¶
            document.getElementById('currentLocationBtn').addEventListener('click', function() {
                getCurrentLocation();
            });
            
            // å›¾ç‰‡é¢„è§ˆ
            document.getElementById('imageInput').addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('previewImg').src = e.target.result;
                        document.getElementById('previewImg').style.display = 'block';
                        document.getElementById('imagePlaceholder').style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // ä¸ºæè¿°è¾“å…¥æ¡†æ·»åŠ å›è½¦é”®äº‹ä»¶ï¼Œè‡ªåŠ¨è§¦å‘åœ°ç†ç¼–ç 
            document.getElementById('descriptionInput').addEventListener('keydown', function(e) {
                // å½“æŒ‰ä¸‹Ctrl+Enteræˆ–Command+Enteræ—¶è§¦å‘åœ°ç†ç¼–ç 
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
                    geocodeDescription();
                }
            });
            
            // æäº¤æŠ¥å‘Š
            document.getElementById('submitReport').addEventListener('click', function() {
                const description = document.getElementById('descriptionInput').value.trim();
                if (!description) {
                    alert('è¯·è¾“å…¥æè¿°');
                    return;
                }
                
                if (!selectedLocation) {
                    alert('è¯·å…ˆåœ¨åœ°å›¾ä¸Šé€‰æ‹©ä½ç½®');
                    closeReportForm();
                    return;
                }
                
                let imageData = '';
                if (document.getElementById('previewImg').style.display !== 'none') {
                    imageData = document.getElementById('previewImg').src;
                }
                
                addNewReport(description, imageData, selectedLocation.lat, selectedLocation.lng);
            });
            
            // æ›´æ–°è¡¨å•è¯­è¨€æ–‡æœ¬
            function updateFormLanguage() {
                document.getElementById('formTitle').textContent = i18n[currentLang].newReport;
                document.getElementById('photoLabel').textContent = i18n[currentLang].photo;
                document.getElementById('imagePlaceholder').textContent = i18n[currentLang].imagePlaceholder;
                document.getElementById('descLabel').textContent = i18n[currentLang].description;
                document.getElementById('descriptionInput').placeholder = i18n[currentLang].descriptionPlaceholder;
                document.getElementById('submitReport').textContent = i18n[currentLang].submit;
                document.getElementById('resetLocationBtn').textContent = i18n[currentLang].resetLocation;
                document.getElementById('cancelReport').textContent = i18n[currentLang].cancel;
                document.getElementById('addReportBtn').textContent = i18n[currentLang].addReport;
                document.getElementById('geocodeLocationBtn').textContent = i18n[currentLang].geocodeLocation;
                document.getElementById('currentLocationBtn').textContent = i18n[currentLang].useCurrentLocation;
                
                // æ›´æ–°ç”¨æˆ·èœå•
                document.getElementById('profileMenuItem').textContent = i18n[currentLang].profile;
                document.getElementById('logoutMenuItem').textContent = i18n[currentLang].logout;
            }
            
            // è®¾ç½®è¯­è¨€å‡½æ•°æ‰©å±•
            window.setLang = function(lang) {
                currentLang = lang;
                updateFormLanguage();
                document.getElementById('langSwitchText').textContent = currentLang === 'zh' ? 'EN' : 'ä¸­';
                // å…¶ä»–è¯­è¨€æ›´æ–°é€»è¾‘
            };
            
            // åˆå§‹åŒ–è¡¨å•è¯­è¨€
            updateFormLanguage();
            
            // åˆå§‹åŒ–å¼¹å¹•ç³»ç»Ÿ
            initDanmakuSystem();
            
            // è®¾ç½®ç”¨æˆ·èœå•äº‹ä»¶
            document.getElementById('userDisplayName').addEventListener('click', function() {
                const userMenuDropdown = document.getElementById('userMenuDropdown');
                if (userMenuDropdown.style.display === 'block') {
                    userMenuDropdown.style.display = 'none';
                } else {
                    userMenuDropdown.style.display = 'block';
                }
            });
            
            // è®¾ç½®ç™»å‡ºæŒ‰é’®äº‹ä»¶
            document.getElementById('logoutMenuItem').addEventListener('click', function() {
                // æ¸…é™¤ç™»å½•çŠ¶æ€
                localStorage.removeItem('userLoggedIn');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('isGuestUser');
                localStorage.removeItem('guestId');
                
                // Firebaseç™»å‡º
                if (auth) {
                    auth.signOut().then(() => {
                        console.log('ç”¨æˆ·å·²ç™»å‡ºFirebase');
                    }).catch((error) => {
                        console.error('Firebaseç™»å‡ºé”™è¯¯:', error);
                    });
                }
                
                // é‡å®šå‘åˆ°ç™»å½•é¡µé¢ï¼Œæ·»åŠ ç™»å‡ºæ ‡è®°
                window.location.href = 'login.html?logout=1';
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–ä½ç½®å…³é—­ç”¨æˆ·èœå•
            document.addEventListener('click', function(e) {
                const userMenu = document.getElementById('userMenu');
                const userMenuDropdown = document.getElementById('userMenuDropdown');
                
                if (!userMenu.contains(e.target) && userMenuDropdown.style.display === 'block') {
                    userMenuDropdown.style.display = 'none';
                }
            });
            
            // åˆå§‹åŒ–è¯­è¨€è®¾ç½®
            const savedLang = localStorage.getItem('language') || localStorage.getItem('preferredLanguage');
            if (savedLang) {
                currentLang = savedLang;
                document.getElementById('langSwitchText').textContent = currentLang === 'zh' ? 'EN' : 'ä¸­';
                updateFormLanguage();
                
                // å¦‚æœæ˜¯æ¸¸å®¢æ¨¡å¼ï¼Œæ ¹æ®æ¢å¤çš„è¯­è¨€æ›´æ–°æ¸¸å®¢æ˜¾ç¤ºæ ‡ç­¾
                if (localStorage.getItem('isGuestUser') === 'true') {
                    document.getElementById('userDisplayName').textContent = currentLang === 'zh' ? 'æ¸¸å®¢' : 'Guest';
                }
                
                // ç¡®ä¿å¼¹å¹•ä½¿ç”¨æ­£ç¡®çš„è¯­è¨€
                initDanmakuSystem();
                
                // åˆ·æ–°ç”µè½¦æŒ‰é’®æ–‡æœ¬
                const refreshTramText = document.getElementById('refreshTramText');
                if (refreshTramText) {
                    refreshTramText.textContent = i18n[currentLang].refreshTramInfo;
                }
            }
            
            // ç®¡ç†å‘˜é¢æ¿äº‹ä»¶ç›‘å¬
            // å…³é—­ç®¡ç†å‘˜é¢æ¿
            document.getElementById('adminPanelClose').addEventListener('click', function() {
                closeAdminPanel();
            });
            
            // å‘å¸ƒä¸´æ—¶å…¬å‘Š
            document.getElementById('publishAnnouncement').addEventListener('click', function() {
                publishTemporaryAnnouncement();
            });
            
            // å‘å¸ƒå…¨å±€é¡¶éƒ¨å…¬å‘Š
            document.getElementById('publishGlobalAnnouncement').addEventListener('click', function() {
                publishGlobalAnnouncement();
            });
            
            // æ¸…é™¤å…¨å±€å…¬å‘Š
            document.getElementById('clearGlobalAnnouncement').addEventListener('click', function() {
                clearGlobalAnnouncement();
            });
            
            // åˆ·æ–°æŠ¥å‘Šåˆ—è¡¨
            document.getElementById('refreshReportsBtn').addEventListener('click', function() {
                loadReportsForAdmin();
            });
            
            // æŠ¥å‘Šè¿‡æ»¤
            document.getElementById('reportsFilter').addEventListener('input', function() {
                const filterText = this.value.toLowerCase();
                const rows = document.getElementById('reportsTableBody').getElementsByTagName('tr');
                
                for (let i = 0; i < rows.length; i++) {
                    const descCell = rows[i].getElementsByTagName('td')[3]; // æè¿°åˆ—æ˜¯ç¬¬4åˆ—
                    if (descCell) {
                        const descText = descCell.textContent.toLowerCase();
                        if (descText.includes(filterText)) {
                            rows[i].style.display = '';
                        } else {
                            rows[i].style.display = 'none';
                        }
                    }
                }
            });
            
            // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
            document.getElementById('refreshUsersBtn').addEventListener('click', function() {
                loadUsersForAdmin();
            });
            
            // å°ç¦ç”¨æˆ·
            document.getElementById('banUserBtn').addEventListener('click', function() {
                const userId = document.getElementById('userIdInput').value.trim();
                if (userId) {
                    confirmBanUser(userId, userId);
                }
            });
            
            // è§£é™¤å°ç¦
            document.getElementById('unbanUserBtn').addEventListener('click', function() {
                const userId = document.getElementById('userIdInput').value.trim();
                if (userId) {
                    unbanUser(userId);
                }
            });
            
            // æå‡ä¸ºç®¡ç†å‘˜
            document.getElementById('promoteToAdminBtn').addEventListener('click', function() {
                const userId = document.getElementById('userIdInput').value.trim();
                if (userId) {
                    grantAdminRole(userId);
                }
            });
            
            // ç§»é™¤ç®¡ç†å‘˜æƒé™
            document.getElementById('removeAdminBtn').addEventListener('click', function() {
                const userId = document.getElementById('userIdInput').value.trim();
                if (userId) {
                    removeAdminRole(userId);
                }
            });
            
            // åŠ è½½å…¨å±€å…¬å‘Š
            loadGlobalAnnouncement();
            
            // åˆå§‹åŒ–ç”¨æˆ·è®¤è¯ï¼ˆç§»åˆ°è¿™é‡Œï¼Œç¡®ä¿åœ¨æ‰€æœ‰å‡½æ•°å®šä¹‰ä¹‹åè°ƒç”¨ï¼‰
            checkAuthState();
            
            // æ ¹æ®æè¿°å®šä½
            function geocodeDescription() {
                const description = document.getElementById('descriptionInput').value.trim();
                if (!description) {
                    alert(currentLang === 'zh' ? 'è¯·å…ˆè¾“å…¥æè¿°' : 'Please enter a description first');
                    return;
                }
                
                // æ˜¾ç¤ºå®šä½çŠ¶æ€
                const geocodeStatus = document.getElementById('geocodeStatus');
                geocodeStatus.textContent = i18n[currentLang].geocoding;
                geocodeStatus.style.display = 'block';
                geocodeStatus.style.color = '#ffcc00';

                // åœ¨å¢¨å°”æœ¬åŒºåŸŸå†…è¿›è¡Œåœ°ç†ç¼–ç æŸ¥è¯¢
                const geocoder = new google.maps.Geocoder();
                // æ·»åŠ å¢¨å°”æœ¬ä½œä¸ºåå¥½åœ°ç‚¹
                let searchQuery = description + ' Melbourne Australia';
                
                // å¯¹äºä¸­æ–‡æè¿°ï¼Œæ·»åŠ ç¿»è¯‘
                if (/[\u4e00-\u9fa5]/.test(description)) {
                    // ç®€å•çš„å¸¸è§åœ°ç‚¹ä¸­è‹±æ–‡æ˜ å°„
                    const cnToEnMap = {
                        'å¢¨å°”æœ¬': 'Melbourne',
                        'ä¸­å¤®å•†åŠ¡åŒº': 'CBD',
                        'å—å²¸': 'Southbank',
                        'åœ£åŸºå°”è¾¾': 'St Kilda',
                        'å¡å°”é¡¿': 'Carlton',
                        'è²èŒ¨ç½—ä¼Š': 'Fitzroy',
                        'å¤šå…‹å…°å…¹': 'Docklands',
                        'ç«è½¦ç«™': 'Train Station',
                        'å•†åœº': 'Shopping Centre',
                        'å›¾ä¹¦é¦†': 'Library',
                        'å¤§å­¦': 'University',
                        'åŒ»é™¢': 'Hospital',
                        'å…¬å›­': 'Park',
                        'æ¹–': 'Lake',
                        'æ²³': 'River',
                        'å¹¿åœº': 'Square',
                        'è¡—': 'Street',
                        'è·¯': 'Road',
                        'å¤§é“': 'Avenue'
                    };
                    
                    // å°è¯•æ›¿æ¢ä¸­æ–‡å…³é”®è¯
                    for (const [cn, en] of Object.entries(cnToEnMap)) {
                        if (description.includes(cn)) {
                            searchQuery = description.replace(cn, en) + ' Melbourne Australia';
                            break;
                        }
                    }
                }
                
                geocoder.geocode({
                    'address': searchQuery,
                    'bounds': new google.maps.LatLngBounds(
                        // å¢¨å°”æœ¬åŒºåŸŸå¤§è‡´è¾¹ç•Œ
                        new google.maps.LatLng(-38.0, 144.5),
                        new google.maps.LatLng(-37.5, 145.5)
                    )
                }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const location = results[0].geometry.location;
                        selectedLocation = {
                            lat: location.lat(),
                            lng: location.lng()
                        };
                        
                        // åœ¨åœ°å›¾ä¸Šæ·»åŠ æ ‡è®°ï¼ˆä¼ å…¥trueè¡¨ç¤ºè¿™æ˜¯åœ°ç†ç¼–ç ç»“æœï¼‰
                        addSelectionMarker(selectedLocation, true);
                        
                        // ç§»åŠ¨åœ°å›¾åˆ°è¯¥ä½ç½®
                        map.setCenter(selectedLocation);
                        map.setZoom(16);
                        
                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        geocodeStatus.textContent = i18n[currentLang].geocodeSuccess;
                        geocodeStatus.style.color = '#34c759';
                        
                        // 3ç§’åéšè—çŠ¶æ€
                        setTimeout(() => {
                            geocodeStatus.style.display = 'none';
                        }, 3000);
                        
                        // å‘ç”¨æˆ·å‘é€å¼¹å¹•åé¦ˆ
                        sendDanmaku(currentLang === 'zh' ? 
                            i18n.zh.addedMarkerFromDesc.replace('{desc}', description) : 
                            i18n.en.addedMarkerFromDesc.replace('{desc}', description)
                        );
                        
                        // è‡ªåŠ¨æ‰“å¼€æŠ¥å‘Šè¡¨å•
                        openReportForm();
                    } else {
                        // åœ°ç†ç¼–ç å¤±è´¥ï¼Œå›é€€åˆ°ä½¿ç”¨é¢„è®¾çš„åœ°ç‚¹åæ ‡
                        geocodeStatus.textContent = i18n[currentLang].geocodeError;
                        geocodeStatus.style.color = '#ff9500'; // æ”¹ä¸ºè­¦å‘Šè‰²
                        
                        // å‘ç”¨æˆ·å‘é€å¼¹å¹•æç¤º
                        sendDanmaku(currentLang === 'zh' ? 
                            'åœ°ç†ç¼–ç å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨é¢„è®¾ä½ç½®åŒ¹é…...' : 
                            'Geocoding failed, trying to match with preset locations...'
                        );
                        
                        // ä½¿ç”¨é¢„è®¾ä½ç½®å­—å…¸ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                        const melbourneLocations = {
                            // å¢¨å°”æœ¬ä¸­å¤®å•†åŠ¡åŒº
                            'cbd': { lat: -37.8136, lng: 144.9631 },
                            'melbourne cbd': { lat: -37.8136, lng: 144.9631 },
                            'å¢¨å°”æœ¬ä¸­å¤®å•†åŠ¡åŒº': { lat: -37.8136, lng: 144.9631 },
                            'ä¸­å¤®å•†åŠ¡åŒº': { lat: -37.8136, lng: 144.9631 },

                            // å¢¨å°”æœ¬å¤§å­¦
                            'melbourne university': { lat: -37.7963, lng: 144.9614 },
                            'å¢¨å°”æœ¬å¤§å­¦': { lat: -37.7963, lng: 144.9614 },
                            'å¤§å­¦': { lat: -37.7963, lng: 144.9614 },

                            // å—å²¸
                            'southbank': { lat: -37.8217, lng: 144.9647 },
                            'å—å²¸': { lat: -37.8217, lng: 144.9647 },

                            // åœ£åŸºå°”è¾¾
                            'st kilda': { lat: -37.8680, lng: 144.9809 },
                            'st. kilda': { lat: -37.8680, lng: 144.9809 },
                            'åœ£åŸºå°”è¾¾': { lat: -37.8680, lng: 144.9809 },

                            // å¡å°”é¡¿
                            'carlton': { lat: -37.8008, lng: 144.9675 },
                            'å¡å°”é¡¿': { lat: -37.8008, lng: 144.9675 },

                            // è²èŒ¨ç½—ä¼Š
                            'fitzroy': { lat: -37.7989, lng: 144.9774 },
                            'è²èŒ¨ç½—ä¼Š': { lat: -37.7989, lng: 144.9774 },

                            // å¤šå…‹å…°å…¹
                            'docklands': { lat: -37.8153, lng: 144.9457 },
                            'å¤šå…‹å…°å…¹': { lat: -37.8153, lng: 144.9457 },

                            // ä½›æ—å¾·æ–¯è¡—è½¦ç«™
                            'flinders street station': { lat: -37.8183, lng: 144.9671 },
                            'ä½›æ—å¾·æ–¯è¡—è½¦ç«™': { lat: -37.8183, lng: 144.9671 },
                            'flinders': { lat: -37.8183, lng: 144.9671 },

                            // å—åå­—æ˜Ÿè½¦ç«™
                            'southern cross station': { lat: -37.8183, lng: 144.9527 },
                            'å—åå­—æ˜Ÿè½¦ç«™': { lat: -37.8183, lng: 144.9527 },
                            
                            // é»˜è®¤ä½ç½® - å¢¨å°”æœ¬ä¸­å¿ƒ
                            'default': MELBOURNE_CENTER
                        };
                        
                        // è½¬æ¢æè¿°ä¸ºå°å†™ä»¥ä¾¿åŒ¹é…
                        const lowerDescription = description.toLowerCase();
                        
                        // å°è¯•æŸ¥æ‰¾åŒ¹é…çš„ä½ç½®
                        let matchedLocation = null;
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰ç²¾ç¡®åŒ¹é…
                        Object.keys(melbourneLocations).forEach(key => {
                            if (lowerDescription.includes(key)) {
                                matchedLocation = melbourneLocations[key];
                            }
                        });
                        
                        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®
                        if (!matchedLocation) {
                            // å‘é€ä¸€ä¸ªæç¤ºï¼Œå‘ŠçŸ¥ç”¨æˆ·ä½¿ç”¨äº†é»˜è®¤ä½ç½®
                            sendDanmaku(currentLang === 'zh' ? 
                                'æœªæ‰¾åˆ°ç²¾ç¡®åŒ¹é…ï¼Œä½¿ç”¨å¢¨å°”æœ¬ä¸­å¿ƒä½ç½®' : 
                                'No exact match found, using Melbourne center'
                            );
                            matchedLocation = melbourneLocations.default;
                        } else {
                            // å·²æ‰¾åˆ°é¢„è®¾ä½ç½®åŒ¹é…
                            geocodeStatus.textContent = i18n[currentLang].geocodeSuccess;
                            geocodeStatus.style.color = '#34c759';
                            
                            sendDanmaku(currentLang === 'zh' ? 
                                i18n.zh.usePresetLocation : 
                                i18n.en.usePresetLocation
                            );
                        }
                        
                        // è®¾ç½®é€‰å®šä½ç½®
                        selectedLocation = matchedLocation;
                        
                        // åœ¨åœ°å›¾ä¸Šæ·»åŠ æ ‡è®°
                        addSelectionMarker(selectedLocation, true);
                        
                        // ç§»åŠ¨åœ°å›¾åˆ°è¯¥ä½ç½®
                        map.setCenter(selectedLocation);
                        map.setZoom(16);
                        
                        // 3ç§’åéšè—çŠ¶æ€
                        setTimeout(() => {
                            geocodeStatus.style.display = 'none';
                        }, 3000);
                        
                        // è‡ªåŠ¨æ‰“å¼€æŠ¥å‘Šè¡¨å•
                        openReportForm();
                        
                        // è®°å½•åœ°ç†ç¼–ç å¤±è´¥åŸå› ï¼Œç”¨äºè°ƒè¯•
                        console.error('Geocode failed:', status);
                    }
                });
            }
            
            // è·å–å½“å‰ä½ç½®
            function getCurrentLocation() {
                // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒåœ°ç†ä½ç½®
                if (!navigator.geolocation) {
                    alert(currentLang === 'zh' ? 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®åŠŸèƒ½' : 'Your browser does not support geolocation');
                    return;
                }
                
                // æ˜¾ç¤ºçŠ¶æ€
                const geocodeStatus = document.getElementById('geocodeStatus');
                geocodeStatus.textContent = i18n[currentLang].gettingLocation;
                geocodeStatus.style.display = 'block';
                geocodeStatus.style.color = '#ffcc00';
                
                // ä½¿ç”¨åœ°ç†ä½ç½®APIè·å–å½“å‰ä½ç½®
                navigator.geolocation.getCurrentPosition(
                    // æˆåŠŸå›è°ƒ
                    function(position) {
                        selectedLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // é™åˆ¶åœ¨å¢¨å°”æœ¬åŒºåŸŸå†…
                        const melbourneBounds = {
                            north: -37.5,
                            south: -38.0,
                            east: 145.5,
                            west: 144.5
                        };
                        
                        const inMelbourneBounds = selectedLocation.lat >= melbourneBounds.south && 
                                                 selectedLocation.lat <= melbourneBounds.north && 
                                                 selectedLocation.lng >= melbourneBounds.west && 
                                                 selectedLocation.lng <= melbourneBounds.east;
                        
                        // å¦‚æœä¸åœ¨å¢¨å°”æœ¬èŒƒå›´å†…ï¼Œé»˜è®¤ä½¿ç”¨å¢¨å°”æœ¬ä¸­å¿ƒä½ç½®
                        if (!inMelbourneBounds) {
                            sendDanmaku(currentLang === 'zh' ? 
                                'æ‚¨ä¼¼ä¹ä¸åœ¨å¢¨å°”æœ¬åŒºåŸŸï¼Œå·²é»˜è®¤ä½¿ç”¨å¢¨å°”æœ¬ä¸­å¿ƒä½ç½®' : 
                                'You seem to be outside Melbourne area, using Melbourne center instead'
                            );
                            selectedLocation = MELBOURNE_CENTER;
                        }
                        
                        // åœ¨åœ°å›¾ä¸Šæ·»åŠ æ ‡è®°
                        addSelectionMarker(selectedLocation, true);
                        
                        // ç§»åŠ¨åœ°å›¾åˆ°è¯¥ä½ç½®
                        map.setCenter(selectedLocation);
                        map.setZoom(16);
                        
                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        geocodeStatus.textContent = i18n[currentLang].locationSuccess;
                        geocodeStatus.style.color = '#34c759';
                        
                        // 3ç§’åéšè—çŠ¶æ€
                        setTimeout(() => {
                            geocodeStatus.style.display = 'none';
                        }, 3000);
                        
                        // å‘ç”¨æˆ·å‘é€å¼¹å¹•åé¦ˆ
                        sendDanmaku(currentLang === 'zh' ? 
                            'å·²è·å–å½“å‰ä½ç½®' : 
                            'Current location obtained'
                        );
                        
                        // è‡ªåŠ¨æ‰“å¼€æŠ¥å‘Šè¡¨å•
                        openReportForm();
                    },
                    // é”™è¯¯å›è°ƒ
                    function(error) {
                        console.error('è·å–ä½ç½®é”™è¯¯:', error);
                        
                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        geocodeStatus.textContent = i18n[currentLang].locationError;
                        geocodeStatus.style.color = '#ff3b30';
                        
                        // 5ç§’åéšè—çŠ¶æ€
                        setTimeout(() => {
                            geocodeStatus.style.display = 'none';
                        }, 5000);
                        
                        // é”™è¯¯å¤„ç†
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                alert(currentLang === 'zh' ? 'ç”¨æˆ·æ‹’ç»äº†åœ°ç†ä½ç½®è¯·æ±‚' : 'User denied the geolocation request');
                                break;
                            case error.POSITION_UNAVAILABLE:
                                alert(currentLang === 'zh' ? 'ä½ç½®ä¿¡æ¯ä¸å¯ç”¨' : 'Location information is unavailable');
                                break;
                            case error.TIMEOUT:
                                alert(currentLang === 'zh' ? 'è·å–ç”¨æˆ·ä½ç½®è¶…æ—¶' : 'The request to get user location timed out');
                                break;
                            case error.UNKNOWN_ERROR:
                                alert(currentLang === 'zh' ? 'å‘ç”ŸæœªçŸ¥é”™è¯¯' : 'An unknown error occurred');
                                break;
                        }
                    },
                    // é€‰é¡¹
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            }
        });
    </script>
    
    <!-- ç®¡ç†å‘˜é¢æ¿ -->
    <div id="adminPanel" class="admin-panel">
        <div class="admin-header">
            <h2 class="admin-title" id="adminPanelTitle">ç®¡ç†å‘˜æ§åˆ¶é¢æ¿</h2>
            <button id="adminPanelClose" class="admin-close">&times;</button>
        </div>
        
        <!-- å…¨å±€å…¬å‘Šéƒ¨åˆ† -->
        <div class="admin-section">
            <h3 class="admin-section-title" id="adminAnnouncementTitle">å‘å¸ƒå…¨å±€å…¬å‘Š</h3>
            <div style="margin-bottom:15px;">
                <label style="display:block;margin-bottom:5px;color:#ddd;" id="adminAnnouncementLabel">å…¬å‘Šå†…å®¹</label>
                <textarea id="announcementText" class="admin-input" style="height:80px;resize:vertical;" placeholder="è¾“å…¥è¦å‘å¸ƒçš„å…¬å‘Šå†…å®¹..."></textarea>
            </div>
            <div style="margin-bottom:15px;">
                <label style="display:block;margin-bottom:5px;color:#ddd;" id="adminAnnouncementTypeLabel">å…¬å‘Šç±»å‹</label>
                <select id="announcementType" class="admin-input">
                    <option value="warning">è­¦å‘Š (é»„è‰²)</option>
                    <option value="error">ç´§æ€¥ (çº¢è‰²)</option>
                    <option value="info">ä¿¡æ¯ (è“è‰²)</option>
                </select>
            </div>
            <div style="display:flex;gap:10px;">
                <button id="publishAnnouncement" class="admin-button warning">å‘å¸ƒä¸´æ—¶å…¬å‘Š</button>
                <button id="publishGlobalAnnouncement" class="admin-button danger">å‘å¸ƒå…¨å±€é¡¶éƒ¨å…¬å‘Š</button>
                <button id="clearGlobalAnnouncement" class="admin-button">æ¸…é™¤å…¨å±€å…¬å‘Š</button>
            </div>
        </div>
        
        <!-- æŠ¥å‘Šç®¡ç†éƒ¨åˆ† -->
        <div class="admin-section">
            <h3 class="admin-section-title" id="adminReportsTitle">æŠ¥å‘Šç®¡ç†</h3>
            <div style="margin-bottom:15px;">
                <label style="display:block;margin-bottom:5px;color:#ddd;" id="adminReportsFilterLabel">è¿‡æ»¤æ¡ä»¶</label>
                <input type="text" id="reportsFilter" class="admin-input" placeholder="æŒ‰æè¿°å†…å®¹è¿‡æ»¤...">
            </div>
            <div id="reportsTableContainer" style="max-height:300px;overflow-y:auto;margin-bottom:15px;">
                <table class="admin-table" id="reportsTable">
                    <thead>
                        <tr>
                            <th id="reportIdHeader">ID</th>
                            <th id="reportTimeHeader">æ—¶é—´</th>
                            <th id="reportUserHeader">ç”¨æˆ·</th>
                            <th id="reportDescHeader">æè¿°</th>
                            <th id="reportActionsHeader">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody">
                        <!-- ç”±JavaScriptåŠ¨æ€å¡«å…… -->
                    </tbody>
                </table>
            </div>
            <button id="refreshReportsBtn" class="admin-button">åˆ·æ–°æŠ¥å‘Šåˆ—è¡¨</button>
        </div>
        
        <!-- ç”¨æˆ·ç®¡ç†éƒ¨åˆ† -->
        <div class="admin-section">
            <h3 class="admin-section-title" id="adminUsersTitle">ç”¨æˆ·ç®¡ç†</h3>
            <div style="margin-bottom:15px;">
                <label style="display:block;margin-bottom:5px;color:#ddd;" id="adminUserManageLabel">ç”¨æˆ·IDæˆ–é‚®ç®±</label>
                <input type="text" id="userIdInput" class="admin-input" placeholder="è¾“å…¥ç”¨æˆ·IDæˆ–é‚®ç®±...">
            </div>
            <div style="display:flex;gap:10px;margin-bottom:15px;">
                <button id="banUserBtn" class="admin-button danger">å°ç¦ç”¨æˆ·</button>
                <button id="unbanUserBtn" class="admin-button">è§£é™¤å°ç¦</button>
                <button id="promoteToAdminBtn" class="admin-button warning">æå‡ä¸ºç®¡ç†å‘˜</button>
                <button id="removeAdminBtn" class="admin-button">ç§»é™¤ç®¡ç†å‘˜æƒé™</button>
            </div>
            <div id="usersTableContainer" style="max-height:300px;overflow-y:auto;">
                <table class="admin-table" id="usersTable">
                    <thead>
                        <tr>
                            <th id="userIdHeader">ç”¨æˆ·ID</th>
                            <th id="userNameHeader">ç”¨æˆ·å</th>
                            <th id="userStatusHeader">çŠ¶æ€</th>
                            <th id="userRoleHeader">è§’è‰²</th>
                            <th id="userActionsHeader">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- ç”±JavaScriptåŠ¨æ€å¡«å…… -->
                    </tbody>
                </table>
            </div>
            <button id="refreshUsersBtn" class="admin-button" style="margin-top:15px;">åˆ·æ–°ç”¨æˆ·åˆ—è¡¨</button>
        </div>
    </div>
    
    <!-- å…¨å±€é¡¶éƒ¨å…¬å‘Šæ  -->
    <div id="globalAnnouncementBar" class="global-announcement-bar" style="display:none;">
        <span id="globalAnnouncementText"></span>
    </div>
    
    <script>
        // åˆ›å»ºæµ‹è¯•ç®¡ç†å‘˜ç”¨æˆ·
        function createTestAdmin() {
            // ä½¿ç”¨å›ºå®šçš„IDä½œä¸ºæµ‹è¯•ç®¡ç†å‘˜
            const testAdminId = 'test_admin';
            
            // è®¾ç½®ä¸ºç®¡ç†å‘˜
            adminUsersRef.child(testAdminId).set(true)
                .then(() => {
                    console.log('æµ‹è¯•ç®¡ç†å‘˜è´¦å·å·²åˆ›å»º:', testAdminId);
                    // é€šçŸ¥ç”¨æˆ·
                    alert('æµ‹è¯•ç®¡ç†å‘˜è´¦å·å·²åˆ›å»ºï¼Œè¯·ä½¿ç”¨æµ‹è¯•è´¦å·ç™»å½•ã€‚ç”¨æˆ·ID: test_admin');
                })
                .catch((error) => {
                    console.error('åˆ›å»ºæµ‹è¯•ç®¡ç†å‘˜å¤±è´¥:', error);
                    alert('åˆ›å»ºæµ‹è¯•ç®¡ç†å‘˜å¤±è´¥: ' + error.message);
                });
        }
        
        // å¯ä»¥åœ¨æ§åˆ¶å°ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºæµ‹è¯•ç®¡ç†å‘˜:
        // createTestAdmin();
    </script>

    <!-- æ·»åŠ å¿«é€Ÿæè¿°å¼¹çª— -->
    <div class="quick-desc-popup" id="quickDescPopup" style="display:none;">
        <div class="form-header">
            <h2 class="form-title" id="quickAddTitle">å¿«é€Ÿæ·»åŠ æè¿°</h2>
            <button class="form-close" id="quickDescClose" style="background:none;border:none;color:#fff;font-size:24px;cursor:pointer;">&times;</button>
        </div>
        <div class="form-group">
            <textarea class="form-textarea" id="quickDescInput" placeholder="è¯·è¾“å…¥äº‹ä»¶æè¿°..." style="width:100%;padding:12px;border-radius:8px;border:1px solid #444;background-color:#2c2c2e;color:#fff;font-size:16px;min-height:100px;resize:vertical;"></textarea>
            <div id="quickGeocodeStatus" style="margin-top:5px;font-size:14px;color:#ffcc00;display:none;"></div>
        </div>
        <button class="submit-btn" id="quickDescSubmit">æ·»åŠ åˆ°åœ°å›¾</button>
    </div>

    <!-- æ›´æ–°æŒ‰é’®å’Œå¼¹çª—æ–‡æœ¬ -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ç¡®ä¿i18nå¯¹è±¡åŒ…å«æ‰€éœ€çš„å­—æ®µ
            if (typeof i18n !== 'undefined') {
                // æ·»åŠ å¯èƒ½ç¼ºå¤±çš„ç¿»è¯‘å­—æ®µ
                i18n.zh = i18n.zh || {};
                i18n.en = i18n.en || {};
                
                // æ·»åŠ å¿«é€Ÿæ·»åŠ æè¿°ç›¸å…³çš„ç¿»è¯‘
                i18n.zh.quickAddDesc = i18n.zh.quickAddDesc || 'å¿«é€Ÿæ·»åŠ ';
                i18n.zh.quickAddTitle = i18n.zh.quickAddTitle || 'å¿«é€Ÿæ·»åŠ æè¿°';
                i18n.zh.quickDescPlaceholder = i18n.zh.quickDescPlaceholder || 'è¯·è¾“å…¥äº‹ä»¶æè¿°...';
                i18n.zh.addToMap = i18n.zh.addToMap || 'æ·»åŠ åˆ°åœ°å›¾';
                
                i18n.en.quickAddDesc = i18n.en.quickAddDesc || 'Quick Add';
                i18n.en.quickAddTitle = i18n.en.quickAddTitle || 'Quick Add Description';
                i18n.en.quickDescPlaceholder = i18n.en.quickDescPlaceholder || 'Enter event description...';
                i18n.en.addToMap = i18n.en.addToMap || 'Add to Map';
            } else {
                // å¦‚æœi18nå¯¹è±¡ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªç®€å•çš„ç‰ˆæœ¬
                window.i18n = {
                    zh: {
                        quickAddDesc: 'å¿«é€Ÿæ·»åŠ ',
                        quickAddTitle: 'å¿«é€Ÿæ·»åŠ æè¿°',
                        quickDescPlaceholder: 'è¯·è¾“å…¥äº‹ä»¶æè¿°...',
                        addToMap: 'æ·»åŠ åˆ°åœ°å›¾',
                        geocoding: 'æ­£åœ¨è§£æä½ç½®...',
                        geocodeSuccess: 'ä½ç½®å·²æ‰¾åˆ°',
                        geocodeError: 'ä½ç½®è§£æå¤±è´¥',
                        translation: 'ç¿»è¯‘: '
                    },
                    en: {
                        quickAddDesc: 'Quick Add',
                        quickAddTitle: 'Quick Add Description',
                        quickDescPlaceholder: 'Enter event description...',
                        addToMap: 'Add to Map',
                        geocoding: 'Geocoding...',
                        geocodeSuccess: 'Location found',
                        geocodeError: 'Geocoding failed',
                        translation: 'Translation: '
                    }
                };
                
                // è®¾ç½®é»˜è®¤è¯­è¨€
                window.currentLang = window.currentLang || 'zh';
            }
            
            // æ›´æ–°å¿«é€Ÿæ·»åŠ æè¿°æŒ‰é’®æ–‡æœ¬
            function updateQuickAddText() {
                const quickAddBtn = document.getElementById('quickAddBtn');
                const quickAddTitle = document.getElementById('quickAddTitle');
                const quickDescInput = document.getElementById('quickDescInput');
                const quickDescSubmit = document.getElementById('quickDescSubmit');
                
                if (quickAddBtn) quickAddBtn.textContent = i18n[currentLang].quickAddDesc;
                if (quickAddTitle) quickAddTitle.textContent = i18n[currentLang].quickAddTitle;
                if (quickDescInput) quickDescInput.placeholder = i18n[currentLang].quickDescPlaceholder;
                if (quickDescSubmit) quickDescSubmit.textContent = i18n[currentLang].addToMap;
            }
            
            // åˆå§‹æ›´æ–°
            try {
                updateQuickAddText();
            } catch (error) {
                console.error("Error updating quick add text:", error);
            }
            
            // è¯­è¨€åˆ‡æ¢æ—¶æ›´æ–°æ–‡æœ¬
            const langSwitchBtn = document.getElementById('langSwitchBtn');
            if (langSwitchBtn) {
                const originalLangSwitchHandler = langSwitchBtn.onclick;
                langSwitchBtn.onclick = function(e) {
                    if (originalLangSwitchHandler) {
                        originalLangSwitchHandler.call(this, e);
                    }
                    try {
                        updateQuickAddText();
                    } catch (error) {
                        console.error("Error updating text after language switch:", error);
                    }
                };
            }
        });
    </script>

    <!-- ç›´æ¥æ·»åŠ æè¿°æŒ‰é’®äº‹ä»¶ -->
    <script>
        document.getElementById('quickAddBtn').addEventListener('click', function(e) {
            e.preventDefault();
            // æ˜¾ç¤ºå¿«é€Ÿæè¿°å¼¹çª—
            document.getElementById('quickDescPopup').style.display = 'block';
        });

        // å…³é—­å¿«é€Ÿæè¿°å¼¹çª—
        document.getElementById('quickDescClose').addEventListener('click', function() {
            document.getElementById('quickDescPopup').style.display = 'none';
        });

        // å¤„ç†å¿«é€Ÿæè¿°æäº¤
        document.getElementById('quickDescSubmit').addEventListener('click', function() {
            const description = document.getElementById('quickDescInput').value.trim();
            if (!description) {
                alert(currentLang === 'zh' ? 'è¯·è¾“å…¥æè¿°' : 'Please enter a description');
                return;
            }
            
            // æ˜¾ç¤ºçŠ¶æ€
            const quickGeocodeStatus = document.getElementById('quickGeocodeStatus');
            quickGeocodeStatus.textContent = i18n[currentLang].geocoding;
            quickGeocodeStatus.style.display = 'block';
            quickGeocodeStatus.style.color = '#ffcc00';
            
            // ä½¿ç”¨åœ°ç†ç¼–ç APIæŸ¥æ‰¾ä½ç½®
            const geocoder = new google.maps.Geocoder();
            // æ·»åŠ å¢¨å°”æœ¬ä½œä¸ºåå¥½åœ°ç‚¹
            let searchQuery = description + ' Melbourne Australia';
            
            // å¯¹äºä¸­æ–‡æè¿°ï¼Œæ·»åŠ ç¿»è¯‘
            if (/[\u4e00-\u9fa5]/.test(description)) {
                // ç®€å•çš„å¸¸è§åœ°ç‚¹ä¸­è‹±æ–‡æ˜ å°„
                const cnToEnMap = {
                    'å¢¨å°”æœ¬': 'Melbourne',
                    'ä¸­å¤®å•†åŠ¡åŒº': 'CBD',
                    'å—å²¸': 'Southbank',
                    'åœ£åŸºå°”è¾¾': 'St Kilda',
                    'å¡å°”é¡¿': 'Carlton',
                    'è²èŒ¨ç½—ä¼Š': 'Fitzroy',
                    'å¤šå…‹å…°å…¹': 'Docklands',
                    'ç«è½¦ç«™': 'Train Station',
                    'å•†åœº': 'Shopping Centre',
                    'å›¾ä¹¦é¦†': 'Library',
                    'å¤§å­¦': 'University',
                    'åŒ»é™¢': 'Hospital',
                    'å…¬å›­': 'Park',
                    'æ¹–': 'Lake',
                    'æ²³': 'River',
                    'å¹¿åœº': 'Square',
                    'è¡—': 'Street',
                    'è·¯': 'Road',
                    'å¤§é“': 'Avenue'
                };
                
                // å°è¯•æ›¿æ¢ä¸­æ–‡å…³é”®è¯
                for (const [cn, en] of Object.entries(cnToEnMap)) {
                    if (description.includes(cn)) {
                        searchQuery = description.replace(cn, en) + ' Melbourne Australia';
                        break;
                    }
                }
            }
            
            geocoder.geocode({
                'address': searchQuery,
                'bounds': new google.maps.LatLngBounds(
                    // å¢¨å°”æœ¬åŒºåŸŸå¤§è‡´è¾¹ç•Œ
                    new google.maps.LatLng(-38.0, 144.5),
                    new google.maps.LatLng(-37.5, 145.5)
                )
            }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const location = results[0].geometry.location;
                    
                    // ç›´æ¥æ·»åŠ åˆ°åœ°å›¾ä¸Š
                    addQuickReportMarker({
                        lat: location.lat(),
                        lng: location.lng()
                    }, description);
                    
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    quickGeocodeStatus.textContent = i18n[currentLang].geocodeSuccess;
                    quickGeocodeStatus.style.color = '#34c759';
                    
                    // å…³é—­å¼¹çª—
                    setTimeout(() => {
                        document.getElementById('quickDescPopup').style.display = 'none';
                        document.getElementById('quickDescInput').value = '';
                        quickGeocodeStatus.style.display = 'none';
                    }, 1500);
                    
                    // å‘ç”¨æˆ·å‘é€å¼¹å¹•åé¦ˆ
                    sendDanmaku(currentLang === 'zh' ? 
                        `å·²æ ¹æ®"${description}"æ·»åŠ æ ‡è®°` : 
                        `Added marker based on "${description}"`
                    );
                    
                    // ç§»åŠ¨åœ°å›¾åˆ°è¯¥ä½ç½®
                    map.setCenter(location);
                    map.setZoom(16);
                } else {
                    // åœ°ç†ç¼–ç å¤±è´¥ï¼Œå›é€€åˆ°ä½¿ç”¨é¢„è®¾çš„åœ°ç‚¹åæ ‡
                    quickGeocodeStatus.textContent = i18n[currentLang].geocodeError;
                    quickGeocodeStatus.style.color = '#ff9500'; // æ”¹ä¸ºè­¦å‘Šè‰²
                    
                    // è®°å½•åœ°ç†ç¼–ç å¤±è´¥åŸå› ï¼Œç”¨äºè°ƒè¯•
                    console.error('Geocode failed:', status);
                    
                    // å‘ç”¨æˆ·å‘é€å¼¹å¹•æç¤º
                    sendDanmaku(currentLang === 'zh' ? 
                        'åœ°ç†ç¼–ç å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨é¢„è®¾ä½ç½®åŒ¹é…...' : 
                        'Geocoding failed, trying to match with preset locations...'
                    );
                    
                    // ä½¿ç”¨é¢„è®¾ä½ç½®å­—å…¸ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                    const melbourneLocations = {
                        // å¢¨å°”æœ¬ä¸­å¤®å•†åŠ¡åŒº
                        'cbd': { lat: -37.8136, lng: 144.9631 },
                        'melbourne cbd': { lat: -37.8136, lng: 144.9631 },
                        'å¢¨å°”æœ¬ä¸­å¤®å•†åŠ¡åŒº': { lat: -37.8136, lng: 144.9631 },
                        'ä¸­å¤®å•†åŠ¡åŒº': { lat: -37.8136, lng: 144.9631 },

                        // å¢¨å°”æœ¬å¤§å­¦
                        'melbourne university': { lat: -37.7963, lng: 144.9614 },
                        'å¢¨å°”æœ¬å¤§å­¦': { lat: -37.7963, lng: 144.9614 },
                        'å¤§å­¦': { lat: -37.7963, lng: 144.9614 },

                        // å—å²¸
                        'southbank': { lat: -37.8217, lng: 144.9647 },
                        'å—å²¸': { lat: -37.8217, lng: 144.9647 },

                        // åœ£åŸºå°”è¾¾
                        'st kilda': { lat: -37.8680, lng: 144.9809 },
                        'st. kilda': { lat: -37.8680, lng: 144.9809 },
                        'åœ£åŸºå°”è¾¾': { lat: -37.8680, lng: 144.9809 },

                        // å¡å°”é¡¿
                        'carlton': { lat: -37.8008, lng: 144.9675 },
                        'å¡å°”é¡¿': { lat: -37.8008, lng: 144.9675 },

                        // è²èŒ¨ç½—ä¼Š
                        'fitzroy': { lat: -37.7989, lng: 144.9774 },
                        'è²èŒ¨ç½—ä¼Š': { lat: -37.7989, lng: 144.9774 },

                        // å¤šå…‹å…°å…¹
                        'docklands': { lat: -37.8153, lng: 144.9457 },
                        'å¤šå…‹å…°å…¹': { lat: -37.8153, lng: 144.9457 },

                        // ä½›æ—å¾·æ–¯è¡—è½¦ç«™
                        'flinders street station': { lat: -37.8183, lng: 144.9671 },
                        'ä½›æ—å¾·æ–¯è¡—è½¦ç«™': { lat: -37.8183, lng: 144.9671 },
                        'flinders': { lat: -37.8183, lng: 144.9671 },

                        // å—åå­—æ˜Ÿè½¦ç«™
                        'southern cross station': { lat: -37.8183, lng: 144.9527 },
                        'å—åå­—æ˜Ÿè½¦ç«™': { lat: -37.8183, lng: 144.9527 },
                        
                        // é»˜è®¤ä½ç½® - å¢¨å°”æœ¬ä¸­å¿ƒ
                        'default': MELBOURNE_CENTER
                    };
                    
                    // è½¬æ¢æè¿°ä¸ºå°å†™ä»¥ä¾¿åŒ¹é…
                    const lowerDescription = description.toLowerCase();
                    
                    // å°è¯•æŸ¥æ‰¾åŒ¹é…çš„ä½ç½®
                    let matchedLocation = null;
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰ç²¾ç¡®åŒ¹é…
                    Object.keys(melbourneLocations).forEach(key => {
                        if (lowerDescription.includes(key)) {
                            matchedLocation = melbourneLocations[key];
                        }
                    });
                    
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®
                    if (!matchedLocation) {
                        // å‘é€ä¸€ä¸ªæç¤ºï¼Œå‘ŠçŸ¥ç”¨æˆ·ä½¿ç”¨äº†é»˜è®¤ä½ç½®
                        sendDanmaku(currentLang === 'zh' ? 
                            'æœªæ‰¾åˆ°ç²¾ç¡®åŒ¹é…ï¼Œä½¿ç”¨å¢¨å°”æœ¬ä¸­å¿ƒä½ç½®' : 
                            'No exact match found, using Melbourne center'
                        );
                        matchedLocation = melbourneLocations.default;
                    } else {
                        // å·²æ‰¾åˆ°é¢„è®¾ä½ç½®åŒ¹é…
                        quickGeocodeStatus.textContent = i18n[currentLang].geocodeSuccess;
                        quickGeocodeStatus.style.color = '#34c759';
                        
                        sendDanmaku(currentLang === 'zh' ? 
                            'å·²ä»é¢„è®¾ä½ç½®ä¸­æ‰¾åˆ°åŒ¹é…' : 
                            'Match found in preset locations'
                        );
                    }
                    
                    // ç›´æ¥æ·»åŠ åˆ°åœ°å›¾ä¸Š
                    addQuickReportMarker(matchedLocation, description);
                    
                    // æ›´æ–°çŠ¶æ€
                    setTimeout(() => {
                        document.getElementById('quickDescPopup').style.display = 'none';
                        document.getElementById('quickDescInput').value = '';
                        quickGeocodeStatus.style.display = 'none';
                    }, 1500);
                    
                    // ç§»åŠ¨åœ°å›¾åˆ°è¯¥ä½ç½®
                    map.setCenter(matchedLocation);
                    map.setZoom(16);
                }
            });
        });

        // ä¸ºå¿«é€Ÿæè¿°è¾“å…¥æ¡†æ·»åŠ å›è½¦é”®äº‹ä»¶
        document.getElementById('quickDescInput').addEventListener('keydown', function(e) {
            // å½“æŒ‰ä¸‹Ctrl+Enteræˆ–Command+Enteræ—¶è§¦å‘
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
                document.getElementById('quickDescSubmit').click();
            }
        });

        // æ·»åŠ å¿«é€ŸæŠ¥å‘Šæ ‡è®°
        function addQuickReportMarker(location, description) {
            try {
                if (!map) return null;
                
                // é»˜è®¤ä½¿ç”¨ç‹—emojiä½œä¸ºæ ‡è®°
                let emoji = "ğŸ¶"; // é»˜è®¤ä½¿ç”¨ç‹—çš„emoji
                
                // æ ¹æ®æè¿°å¯ä»¥é€‰æ‹©ä¸åŒè¡¨æƒ…(ä¿ç•™è¿™éƒ¨åˆ†ä»¥ä¾¿æœªæ¥å¯èƒ½éœ€è¦çš„ç‰¹æ®Šæƒ…å†µå¤„ç†)
                if (description && (description.toLowerCase().includes('traffic') || description.toLowerCase().includes('äº¤é€š'))) {
                    emoji = "ğŸš—";
                } else if (description && (description.toLowerCase().includes('food') || description.toLowerCase().includes('é¤'))) {
                    emoji = "ğŸ”";
                } else if (description && (description.toLowerCase().includes('event') || description.toLowerCase().includes('æ´»åŠ¨'))) {
                    emoji = "ğŸª";
                } else if (description && (description.toLowerCase().includes('police') || description.toLowerCase().includes('è­¦å¯Ÿ'))) {
                    emoji = "ğŸ‘®";
                } else if (description && (description.toLowerCase().includes('accident') || description.toLowerCase().includes('äº‹æ•…'))) {
                    emoji = "âš ï¸";
                } else {
                    // å…¶ä»–æ‰€æœ‰æƒ…å†µå‡ä½¿ç”¨ç‹—emoji
                    emoji = "ğŸ¶";
                }
                
                // åˆ›å»ºæ ‡è®°å›¾æ ‡
                const markerIcon = {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(
                        `<svg xmlns="http://www.w3.org/2000/svg" width="42" height="42" viewBox="0 0 42 42">
                            <circle cx="21" cy="21" r="20" fill="white" opacity="0.95"/>
                            <text x="21" y="29" font-size="24" text-anchor="middle" fill="black">${emoji}</text>
                        </svg>`
                    ),
                    scaledSize: new google.maps.Size(42, 42),
                    anchor: new google.maps.Point(21, 21)
                };
                
                // åˆ›å»ºæ ‡è®°æ•°æ®å¯¹è±¡
                const reportData = {
                    id: Date.now(), // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºID
                    lat: location.lat,
                    lng: location.lng,
                    description: description,
                    originalDescription: description,
                    time: new Date().toISOString(),
                    emoji: emoji,
                    userName: document.getElementById('userDisplayName').textContent || (currentLang === 'zh' ? 'ç”¨æˆ·' : 'User'),
                    userId: currentUserId
                };
                
                // ä½¿ç”¨ä¼ ç»ŸMarker APIåˆ›å»ºæ ‡è®°
                const marker = new google.maps.Marker({
                    position: location,
                    map: map,
                    icon: markerIcon,
                    animation: google.maps.Animation.DROP,
                    title: description,
                    zIndex: 999
                });
                
                // å°†æŠ¥å‘Šæ•°æ®ä¿å­˜åˆ°æ ‡è®°
                marker.reportData = reportData;
                
                // åˆ›å»ºä¿¡æ¯çª—å£ï¼Œåœ¨é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºç®€çŸ­æè¿°
                const infoWindow = new google.maps.InfoWindow({
                    content: `<div style="max-width:200px;font-family:sans-serif;">
                        <p style="margin:8px 0;font-weight:bold;">${emoji} ${description}</p>
                        <p style="margin:5px 0;color:#666;font-size:12px;">ğŸ‘¤ ${reportData.userName}</p>
                        <p style="margin:5px 0;color:#777;font-size:11px;">${new Date(reportData.time).toLocaleString()}</p>
                    </div>`
                });
                
                // é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºä¿¡æ¯çª—å£
                marker.addListener('mouseover', function() {
                    infoWindow.open(map, marker);
                });
                
                marker.addListener('mouseout', function() {
                    infoWindow.close();
                });
                
                // ç‚¹å‡»æ ‡è®°æ—¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                marker.addListener("click", function() {
                    console.log('Quick report marker clicked:', this.reportData.id);
                    // å…³é—­æ‰€æœ‰æ´»åŠ¨çš„ä¿¡æ¯çª—å£
                    if (this.infoWindow) this.infoWindow.close();
                    showReportDetails(this.reportData);
                });
                
                // ä¿å­˜infoWindowçš„å¼•ç”¨åˆ°markerå¯¹è±¡ä¸Š
                marker.infoWindow = infoWindow;
                
                // æ·»åŠ åˆ°æ ‡è®°æ•°ç»„
                markers.push(marker);
                
                // å°†æ•°æ®ä¿å­˜åˆ°Firebaseæˆ–Cloudflare
                console.log("ä¿å­˜æ ‡è®°æ•°æ®ï¼Œå­˜å‚¨ç³»ç»Ÿ:", useCloudflare ? "Cloudflare" : "Firebase");
                
                if (useCloudflare) {
                    // ä¿å­˜åˆ°Cloudflare
                    saveReportToCloudflare(reportData);
                } else {
                    // ä¿å­˜åˆ°Firebase
                    reportsRef.child(reportData.id.toString()).set(reportData)
                        .then(() => {
                            console.log("Quick report saved to Firebase", reportData);
                            
                            // å¢åŠ ç”¨æˆ·æŠ¥å‘Šè®¡æ•°
                            incrementUserReportCount();
                            
                            // åŒæ­¥åˆ°Cloudflare
                            if (syncToCloudflare) {
                                syncReportToCloudflare(reportData);
                            }
                        })
                        .catch((error) => {
                            console.error("Error saving quick report to Firebase:", error);
                            sendDanmaku(currentLang === 'zh' ? 
                                'æ ‡è®°å·²æ·»åŠ åˆ°åœ°å›¾ï¼Œä½†ä¿å­˜åˆ°æœåŠ¡å™¨å¤±è´¥' : 
                                'Marker added to map, but failed to save to server'
                            );
                        });
                }
                
                return marker;
            } catch (error) {
                console.error("æ·»åŠ å¿«é€ŸæŠ¥å‘Šæ ‡è®°æ—¶å‡ºé”™:", error, location, description);
                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                sendDanmaku(currentLang === 'zh' ? 
                    'æ·»åŠ æ ‡è®°å¤±è´¥ï¼Œè¯·é‡è¯•' : 
                    'Failed to add marker, please try again'
                );
                return null;
            }
        }
    </script>
    
    <!-- PWAåˆå§‹åŒ–å’Œæ¨é€é€šçŸ¥ -->
    <script>
        // æ³¨å†ŒService Workerï¼Œå¯ç”¨PWAåŠŸèƒ½
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async function() {
                try {
                    // ä¸ºGitHub Pagesç¯å¢ƒå¤„ç†æ­£ç¡®çš„Service Workerè·¯å¾„
                    let swPath = './service-worker.js';
                    
                    // æ£€æµ‹GitHub Pagesç¯å¢ƒå¹¶ä¿®æ­£è·¯å¾„
                    if (window.location.hostname.includes('github.io')) {
                        // è·å–ä»“åº“åç§°(ä»è·¯å¾„çš„ç¬¬ä¸€éƒ¨åˆ†)
                        const pathSegments = window.location.pathname.split('/');
                        if (pathSegments.length >= 2 && pathSegments[1]) {
                            const repoName = pathSegments[1];
                            swPath = '/' + repoName + '/service-worker.js';
                            console.log('[Service Worker] æ£€æµ‹åˆ°GitHub Pagesç¯å¢ƒï¼Œä½¿ç”¨è·¯å¾„:', swPath);
                        }
                    }
                    
                    // æ³¨å†ŒService Worker - ä½¿ç”¨ä¿®æ­£åçš„è·¯å¾„
                    const registration = await navigator.serviceWorker.register(swPath, {
                        scope: './'
                    });
                    console.log('Service Worker æ³¨å†ŒæˆåŠŸï¼Œä½œç”¨åŸŸä¸º:', registration.scope);
                    
                    // åˆå§‹åŒ–é€šçŸ¥åŠŸèƒ½
                    if ('Notification' in window && 'PushManager' in window) {
                        // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼Œè®¾ç½®ç”¨æˆ·ID
                        if (currentUserId) {
                            window.notificationHandler.setCurrentUserId(currentUserId);
                        }
                        
                        // åˆå§‹åŒ–é€šçŸ¥åŠŸèƒ½
                        const notificationSupported = await window.notificationHandler.initNotifications();
                        
                        if (notificationSupported) {
                            console.log('æ¨é€é€šçŸ¥åŠŸèƒ½å·²åˆå§‹åŒ–');
                            
                            // ä¸»åŠ¨è¯·æ±‚é€šçŸ¥æƒé™
                            if (Notification.permission === 'default') {
                                console.log('ä¸»åŠ¨è¯·æ±‚é€šçŸ¥æƒé™...');
                                const permission = await Notification.requestPermission();
                                console.log('é€šçŸ¥æƒé™è¯·æ±‚ç»“æœ:', permission);
                            }
                            
                            // å¦‚æœæœ‰æƒé™ï¼Œå°è¯•è®¢é˜…
                            if (Notification.permission === 'granted') {
                                try {
                                    const isAlreadySubscribed = await window.notificationHandler.isSubscribedToPush();
                                    
                                    if (!isAlreadySubscribed) {
                                        const subscription = await window.notificationHandler.subscribeUserToPush();
                                        console.log('æˆåŠŸè®¢é˜…æ¨é€é€šçŸ¥:', subscription);
                                    }
                                } catch (error) {
                                    console.error('è®¢é˜…æ¨é€é€šçŸ¥å¤±è´¥:', error);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Service Worker æ³¨å†Œå¤±è´¥:', error);
                }
            });
        }
    </script>
    
    <!-- æ·»åŠ é€šçŸ¥æƒé™è¯·æ±‚æŒ‰é’® -->
    <div id="notificationPrompt" style="position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background-color:rgba(0,0,0,0.8);color:white;padding:12px 20px;border-radius:10px;font-size:14px;text-align:center;display:none;z-index:2000;box-shadow:0 4px 12px rgba(0,0,0,0.3);width:90%;max-width:300px;">
        <p style="margin:0 0 10px 0;">å…è®¸æ¥æ”¶æœ€æ–°çš„åœ°å›¾æ ‡è®°é€šçŸ¥ï¼Ÿ</p>
        <div style="display:flex;justify-content:space-between;gap:10px;">
            <button id="enableNotifications" style="background:#0071e3;border:none;color:white;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:bold;flex:1;">å¯ç”¨é€šçŸ¥</button>
            <button id="dismissPrompt" style="background:rgba(255,255,255,0.2);border:none;color:white;padding:8px 16px;border-radius:6px;cursor:pointer;flex:1;">å–æ¶ˆ</button>
        </div>
    </div>
    
    <script>
        // æ˜¾ç¤ºé€šçŸ¥æƒé™æç¤º
        setTimeout(function() {
            // å¦‚æœé€šçŸ¥æƒé™çŠ¶æ€æ˜¯é»˜è®¤(æœªå†³å®š)ï¼Œæ˜¾ç¤ºæç¤º
            if (Notification.permission === 'default') {
                document.getElementById('notificationPrompt').style.display = 'block';
            }
        }, 3000); // é¡µé¢åŠ è½½3ç§’åæ˜¾ç¤º
        
        // å¯ç”¨é€šçŸ¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('enableNotifications').addEventListener('click', async function() {
            try {
                // è¯·æ±‚æƒé™
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    // è®¢é˜…æ¨é€
                    await window.notificationHandler.subscribeUserToPush();
                    alert('æ¨é€é€šçŸ¥å·²å¯ç”¨ï¼Œä½ å°†æ”¶åˆ°æ–°æ ‡è®°çš„é€šçŸ¥ï¼');
                }
            } catch (error) {
                console.error('å¯ç”¨é€šçŸ¥å¤±è´¥:', error);
            } finally {
                // éšè—æç¤º
                document.getElementById('notificationPrompt').style.display = 'none';
            }
        });
        
        // å–æ¶ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('dismissPrompt').addEventListener('click', function() {
            document.getElementById('notificationPrompt').style.display = 'none';
        });
    </script>

    <!-- æ·»åŠ é€šçŸ¥æŒ‰é’®åˆ°é¡µé¢å¯¼èˆª/æ§åˆ¶åŒºåŸŸ -->
    <div class="map-control-buttons" style="position:fixed;top:15px;right:15px;z-index:1000;display:flex;flex-direction:column;gap:10px;">
        <!-- é€šçŸ¥æŒ‰é’® -->
        <button id="notificationBtn" style="background-color:white;width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:none;box-shadow:0 2px 6px rgba(0,0,0,0.3);cursor:pointer;font-size:20px;color:#333;">ğŸ””</button>
        
        <!-- è¯­è¨€åˆ‡æ¢æŒ‰é’® (ä¿ç•™åŸæœ‰çš„) -->
        <button id="langSwitchBtn" style="background-color:white;width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:none;box-shadow:0 2px 6px rgba(0,0,0,0.3);cursor:pointer;color:#333;font-weight:bold;">
            <span id="langSwitchText">ä¸­</span>
        </button>
    </div>

    <!-- æ·»åŠ é€šçŸ¥æŒ‰é’®çš„äº‹ä»¶å¤„ç† -->
    <script>
        // é€šçŸ¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆåˆ‡æ¢é€šçŸ¥è®¢é˜…çŠ¶æ€ï¼‰
        document.getElementById('notificationBtn').addEventListener('click', async function() {
            try {
                // æ ¹æ®å½“å‰æƒé™çŠ¶æ€å¤„ç†
                switch (Notification.permission) {
                    case 'granted':
                        // å·²æœ‰æƒé™ï¼Œæ£€æŸ¥æ˜¯å¦å·²è®¢é˜…
                        const isSubscribed = await window.notificationHandler.isSubscribedToPush();
                        if (isSubscribed) {
                            if (confirm(currentLang === 'zh' ? 
                                'ä½ å·²å¼€å¯é€šçŸ¥ã€‚æ˜¯å¦è¦å…³é—­æ¨é€é€šçŸ¥ï¼Ÿ' : 
                                'You have enabled notifications. Do you want to disable them?')) {
                                await window.notificationHandler.unsubscribeFromPush();
                                alert(currentLang === 'zh' ? 
                                    'é€šçŸ¥å·²å…³é—­' : 
                                    'Notifications disabled');
                                this.innerText = 'ğŸ”•';
                            }
                        } else {
                            // æœ‰æƒé™ä½†æœªè®¢é˜…
                            await window.notificationHandler.subscribeUserToPush();
                            alert(currentLang === 'zh' ? 
                                'é€šçŸ¥å·²å¼€å¯ï¼Œä½ å°†æ”¶åˆ°æ–°æ ‡è®°çš„æé†’' : 
                                'Notifications enabled. You will be notified of new markers');
                            this.innerText = 'ğŸ””';
                        }
                        break;
                    
                    case 'default':
                        // è¯·æ±‚æƒé™
                        const permission = await Notification.requestPermission();
                        if (permission === 'granted') {
                            await window.notificationHandler.subscribeUserToPush();
                            alert(currentLang === 'zh' ? 
                                'é€šçŸ¥å·²å¼€å¯ï¼Œä½ å°†æ”¶åˆ°æ–°æ ‡è®°çš„æé†’' : 
                                'Notifications enabled. You will be notified of new markers');
                            this.innerText = 'ğŸ””';
                        }
                        break;
                    
                    case 'denied':
                        // æƒé™è¢«æ‹’ç»ï¼Œæé†’ç”¨æˆ·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­æ›´æ”¹
                        alert(currentLang === 'zh' ? 
                            'é€šçŸ¥æƒé™å·²è¢«æ‹’ç»ã€‚è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸é€šçŸ¥ä»¥æ¥æ”¶æ›´æ–°ã€‚' : 
                            'Notification permission denied. Please enable notifications in your browser settings to receive updates.');
                        this.innerText = 'ğŸ”•';
                        break;
                }
            } catch (error) {
                console.error('é€šçŸ¥æ“ä½œå¤±è´¥:', error);
                alert(currentLang === 'zh' ? 
                    'è®¾ç½®é€šçŸ¥æ—¶å‡ºé”™' : 
                    'Error while setting up notifications');
            }
        });
        
        // æ·»åŠ é•¿æŒ‰å‘é€æµ‹è¯•é€šçŸ¥åŠŸèƒ½
        let pressTimer;
        let isLongPress = false;

        document.getElementById('notificationBtn').addEventListener('mousedown', function() {
            // å¼€å§‹è®¡æ—¶
            isLongPress = false;
            pressTimer = window.setTimeout(function() {
                isLongPress = true;
                sendTestNotification();
            }, 800); // é•¿æŒ‰800æ¯«ç§’
        });

        document.getElementById('notificationBtn').addEventListener('mouseup', function() {
            // æ¸…é™¤è®¡æ—¶å™¨
            clearTimeout(pressTimer);
        });

        document.getElementById('notificationBtn').addEventListener('mouseleave', function() {
            // å¦‚æœé¼ æ ‡ç¦»å¼€æŒ‰é’®ï¼Œä¹Ÿæ¸…é™¤è®¡æ—¶å™¨
            clearTimeout(pressTimer);
        });
        
        // ç§»åŠ¨è®¾å¤‡æ”¯æŒ
        document.getElementById('notificationBtn').addEventListener('touchstart', function(e) {
            // å¼€å§‹è®¡æ—¶
            isLongPress = false;
            pressTimer = window.setTimeout(function() {
                isLongPress = true;
                sendTestNotification();
            }, 800); // é•¿æŒ‰800æ¯«ç§’
            e.preventDefault(); // é˜²æ­¢è§¦å‘ç‚¹å‡»äº‹ä»¶
        });

        document.getElementById('notificationBtn').addEventListener('touchend', function() {
            // æ¸…é™¤è®¡æ—¶å™¨
            clearTimeout(pressTimer);
            if (!isLongPress) {
                // å¦‚æœä¸æ˜¯é•¿æŒ‰ï¼Œæ¨¡æ‹Ÿç‚¹å‡»äº‹ä»¶
                this.click();
            }
        });
        
        // æµ‹è¯•é€šçŸ¥å‡½æ•°
        async function sendTestNotification() {
            if (Notification.permission !== 'granted') {
                alert(currentLang === 'zh' ? 
                    'éœ€è¦å…ˆæˆäºˆé€šçŸ¥æƒé™' : 
                    'Notification permission needed first');
                return;
            }
            
            try {
                // æ£€æŸ¥æ˜¯å¦å·²è®¢é˜…
                const isSubscribed = await window.notificationHandler.isSubscribedToPush();
                
                if (!isSubscribed) {
                    if (confirm(currentLang === 'zh' ? 
                        'éœ€è¦å…ˆè®¢é˜…æ¨é€é€šçŸ¥æ‰èƒ½æµ‹è¯•ã€‚æ˜¯å¦ç°åœ¨è®¢é˜…ï¼Ÿ' : 
                        'You need to subscribe to push notifications first. Subscribe now?')) {
                        await window.notificationHandler.subscribeUserToPush();
                    } else {
                        return;
                    }
                }
                
                // å‘é€æµ‹è¯•é€šçŸ¥
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.ready;
                    
                    // æœ¬åœ°æµ‹è¯•é€šçŸ¥
                    registration.showNotification('PtvAlert æµ‹è¯•é€šçŸ¥', {
                        body: currentLang === 'zh' ? 
                            'è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥ï¼Œæ¨é€åŠŸèƒ½å·¥ä½œæ­£å¸¸ï¼' : 
                            'This is a test notification. Push function works!',
                        icon: './images/icon-192x192.png',
                        badge: './images/icon-72x72.png',
                        vibrate: [100, 50, 100],
                        data: {
                            time: new Date().getTime(),
                            url: './'
                        },
                        actions: [
                            {
                                action: 'view',
                                title: currentLang === 'zh' ? 'æŸ¥çœ‹' : 'View'
                            }
                        ]
                    });
                    
                    // å°è¯•ä¹Ÿé€šè¿‡æœåŠ¡å™¨å‘é€æµ‹è¯•é€šçŸ¥
                    try {
                        await window.notificationHandler.sendTestNotification();
                    } catch (error) {
                        console.warn('æœåŠ¡å™¨æµ‹è¯•é€šçŸ¥å¤±è´¥ï¼Œä½†æœ¬åœ°æµ‹è¯•é€šçŸ¥å·²å‘é€:', error);
                    }
                }
            } catch (error) {
                console.error('å‘é€æµ‹è¯•é€šçŸ¥å¤±è´¥:', error);
                alert(currentLang === 'zh' ? 
                    'å‘é€æµ‹è¯•é€šçŸ¥å¤±è´¥: ' + error.message : 
                    'Failed to send test notification: ' + error.message);
            }
        }
        
        // åˆå§‹åŒ–é€šçŸ¥æŒ‰é’®çŠ¶æ€
        window.addEventListener('load', async function() {
            const notificationBtn = document.getElementById('notificationBtn');
            
            if (Notification.permission === 'granted') {
                const isSubscribed = await window.notificationHandler.isSubscribedToPush()
                    .catch(() => false);
                
                notificationBtn.innerText = isSubscribed ? 'ğŸ””' : 'ğŸ”•';
            } else {
                notificationBtn.innerText = 'ğŸ”•';
            }
            
            // æ·»åŠ æç¤ºå·¥å…·æç¤º
            notificationBtn.title = currentLang === 'zh' ? 
                'ç‚¹å‡»å¼€å¯/å…³é—­é€šçŸ¥ï¼Œé•¿æŒ‰å‘é€æµ‹è¯•é€šçŸ¥' : 
                'Click to enable/disable notifications, long press to send a test notification';
        });
    </script>

    <!-- å…¨å±€å˜é‡å£°æ˜ -->
    <script>
    // å…¨å±€å˜é‡å£°æ˜
    window.currentLang = 'zh'; // é»˜è®¤è¯­è¨€
    </script>

    <script>
        // åœ¨é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å¹¶å¸è½½æ‰€æœ‰æœåŠ¡å·¥ä½œçº¿ç¨‹
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async function() {
                try {
                    console.log('å¼€å§‹å¤„ç†Service Workeræ³¨å†Œ...');
                    
                    // å¸è½½æ‰€æœ‰æœåŠ¡å·¥ä½œçº¿ç¨‹ä»¥ç¡®ä¿ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        console.log('å¸è½½æ—§çš„æœåŠ¡å·¥ä½œçº¿ç¨‹', registration.scope);
                        await registration.unregister();
                    }
                    console.log('æ‰€æœ‰æœåŠ¡å·¥ä½œçº¿ç¨‹å·²å¸è½½ï¼Œå°†é‡æ–°æ³¨å†Œæœ€æ–°ç‰ˆæœ¬');
                    
                    // ä½¿ç”¨ç®€å•çš„ç›¸å¯¹è·¯å¾„æ³¨å†ŒService Worker
                    try {
                        console.log('å°è¯•ä½¿ç”¨ç›¸å¯¹è·¯å¾„æ³¨å†ŒService Worker...');
                        const registration = await navigator.serviceWorker.register('./service-worker.js', {
                            scope: './'
                        });
                        console.log('Service Workeræ³¨å†ŒæˆåŠŸ:', registration.scope);
                    } catch (mainError) {
                        console.error('ä½¿ç”¨ä¸»Service Workeræ³¨å†Œå¤±è´¥:', mainError);
                        
                        // å°è¯•ä½¿ç”¨å¤‡ç”¨Service Worker
                        try {
                            console.log('å°è¯•æ³¨å†Œå¤‡ç”¨Service Worker...');
                            const fallbackReg = await navigator.serviceWorker.register('./fallback-service-worker.js', {
                                scope: './'
                            });
                            console.log('å¤‡ç”¨Service Workeræ³¨å†ŒæˆåŠŸ:', fallbackReg.scope);
                        } catch (fallbackError) {
                            console.error('å¤‡ç”¨Service Workeræ³¨å†Œä¹Ÿå¤±è´¥:', fallbackError);
                            
                            // æœ€åçš„å›é€€ - å†…è”æœ€å°Service Worker
                            if (window.location.hostname.includes('github.io')) {
                                console.log('å°è¯•ä½¿ç”¨å†…è”Service Workerä½œä¸ºæœ€åçš„å›é€€...');
                                
                                const minimalSWBlob = new Blob([`
                                    // æœ€å°åŒ–å†…è”Service Worker
                                    self.addEventListener('install', () => self.skipWaiting());
                                    self.addEventListener('activate', event => event.waitUntil(clients.claim()));
                                    self.addEventListener('fetch', event => event.respondWith(fetch(event.request)));
                                    console.log('å†…è”æœ€å°Service Workerå·²æ¿€æ´»');
                                `], {type: 'application/javascript'});
                                
                                const minimalSWUrl = URL.createObjectURL(minimalSWBlob);
                                
                                try {
                                    const inlineReg = await navigator.serviceWorker.register(minimalSWUrl, {
                                        scope: './'
                                    });
                                    console.log('å†…è”Service Workeræ³¨å†ŒæˆåŠŸ:', inlineReg.scope);
                                } catch (inlineError) {
                                    console.error('æ‰€æœ‰Service Workeræ³¨å†Œæ–¹æ³•éƒ½å¤±è´¥:', inlineError);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('å¤„ç†æœåŠ¡å·¥ä½œçº¿ç¨‹æ—¶å‡ºé”™:', error);
                }
            });
        }
    </script>

    <!-- æ·»åŠ ä¸»åŠ¨æ¨é€è¯·æ±‚æç¤ºåŠŸèƒ½ -->
    <div id="notification-prompt-banner" style="display: none; position: fixed; bottom: 20px; left: 10px; right: 10px; max-width: 600px; margin: 0 auto; background: rgba(0,0,0,0.8); color: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000; font-size: 14px;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center;">
                <div style="font-size: 24px; margin-right: 10px;">ğŸ””</div>
                <div>
                    <div style="font-weight: bold; margin-bottom: 5px;">æ¥æ”¶åœ°å›¾æ ‡è®°æ›´æ–°</div>
                    <div>å¼€å¯é€šçŸ¥ï¼ŒåŠæ—¶è·å–åœ°å›¾ä¸Šçš„æ–°æ ‡è®°ä¿¡æ¯ï¼</div>
                </div>
            </div>
            <div>
                <button id="enable-notifications-btn" style="background: #0071e3; color: white; border: none; padding: 8px 15px; border-radius: 5px; margin-right: 10px; cursor: pointer;">å¼€å¯é€šçŸ¥</button>
                <button id="dismiss-prompt-btn" style="background: transparent; color: #ccc; border: 1px solid #ccc; padding: 8px 15px; border-radius: 5px; cursor: pointer;">æš‚ä¸éœ€è¦</button>
            </div>
        </div>
    </div>
    
    <!-- å¤„ç†æ¨é€é€šçŸ¥æ¶ˆæ¯ -->
    <script>
        // å¤„ç†ä»Service Workerå‘æ¥çš„æ¶ˆæ¯
        navigator.serviceWorker.addEventListener('message', function(event) {
            console.log('æ”¶åˆ°Service Workeræ¶ˆæ¯:', event.data);
            
            // å¤„ç†æ˜¾ç¤ºæ ‡è®°æ¶ˆæ¯
            if (event.data.type === 'SHOW_MARKER' && event.data.markerId) {
                // å°è¯•æŸ¥æ‰¾å¹¶æ˜¾ç¤ºå¯¹åº”æ ‡è®°
                if (window.showMarkerById && typeof window.showMarkerById === 'function') {
                    window.showMarkerById(event.data.markerId, event.data.action === 'view-map');
                } else {
                    console.log('æ ‡è®°æ˜¾ç¤ºå‡½æ•°æœªå®šä¹‰ï¼Œæ— æ³•æ˜¾ç¤ºæŒ‡å®šæ ‡è®°');
                }
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å¹¶ä¸»åŠ¨è¯·æ±‚é€šçŸ¥æƒé™
        window.addEventListener('load', function() {
            // å¦‚æœå·²ç»è¯·æ±‚è¿‡æƒé™å¹¶è®°å½•åœ¨æœ¬åœ°å­˜å‚¨ä¸­ï¼Œä¸å†æ˜¾ç¤º
            if (localStorage.getItem('notification-prompt-shown')) {
                return;
            }
            
            // æ£€æŸ¥Notification APIæ”¯æŒ
            if (!('Notification' in window)) {
                console.log('æ­¤æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥åŠŸèƒ½');
                return;
            }
            
            // å¦‚æœå·²æœ‰æƒé™ï¼Œç›´æ¥åˆå§‹åŒ–
            if (Notification.permission === 'granted') {
                initNotifications();
                return;
            }
            
            // å¦‚æœå·²è¢«æ‹’ç»ï¼Œä¸å†æç¤º
            if (Notification.permission === 'denied') {
                return;
            }
            
            // å»¶è¿Ÿ5ç§’æ˜¾ç¤ºé€šçŸ¥æƒé™æç¤º
            setTimeout(function() {
                document.getElementById('notification-prompt-banner').style.display = 'block';
            }, 5000);
        });
        
        // åˆå§‹åŒ–é€šçŸ¥åŠŸèƒ½
        async function initNotifications() {
            if (window.notificationHandler) {
                try {
                    // åˆå§‹åŒ–é€šçŸ¥ç³»ç»Ÿ
                    await window.notificationHandler.initNotifications();
                    
                    // è®¾ç½®ç”¨æˆ·ID
                    let userId = localStorage.getItem('user-id');
                    if (!userId) {
                        userId = 'user_' + Math.random().toString(36).substr(2, 9);
                        localStorage.setItem('user-id', userId);
                    }
                    window.notificationHandler.setCurrentUserId(userId);
                    
                    // å¦‚æœæœ‰æƒé™ä½†æœªè®¢é˜…ï¼Œè‡ªåŠ¨è®¢é˜…
                    if (Notification.permission === 'granted' && 
                        !(await window.notificationHandler.isSubscribedToPush())) {
                        await window.notificationHandler.subscribeUserToPush();
                        console.log('å·²è‡ªåŠ¨è®¢é˜…æ¨é€é€šçŸ¥');
                    }
                } catch (error) {
                    console.error('åˆå§‹åŒ–é€šçŸ¥åŠŸèƒ½å¤±è´¥:', error);
                }
            }
        }
        
        // æŒ‰é’®äº‹ä»¶å¤„ç†
        document.getElementById('enable-notifications-btn').addEventListener('click', async function() {
            try {
                document.getElementById('notification-prompt-banner').style.display = 'none';
                
                // æ ‡è®°ä¸ºå·²æ˜¾ç¤ºæç¤º
                localStorage.setItem('notification-prompt-shown', 'true');
                
                // ä½¿ç”¨é€šçŸ¥å¤„ç†ç¨‹åºè¯·æ±‚æƒé™
                if (window.notificationHandler) {
                    const granted = await window.notificationHandler.requestNotificationPermission();
                    if (granted) {
                        console.log('é€šçŸ¥æƒé™å·²è·å¾—ï¼Œå·²è®¢é˜…æ¨é€');
                    }
                } else {
                    console.error('é€šçŸ¥å¤„ç†ç¨‹åºæœªåŠ è½½');
                }
            } catch (error) {
                console.error('è¯·æ±‚é€šçŸ¥æƒé™å¤±è´¥:', error);
            }
        });
        
        // æ‹’ç»æŒ‰é’®äº‹ä»¶
        document.getElementById('dismiss-prompt-btn').addEventListener('click', function() {
            document.getElementById('notification-prompt-banner').style.display = 'none';
            localStorage.setItem('notification-prompt-shown', 'true');
        });
        
        // æ˜¾ç¤ºåœ°å›¾æ ‡è®°çš„å‡½æ•° - åº”ç”±åœ°å›¾ç»„ä»¶å®ç°
        window.showMarkerById = function(markerId, centerOnMap) {
            console.log('æ˜¾ç¤ºæ ‡è®°:', markerId, centerOnMap ? 'å¹¶å±…ä¸­æ˜¾ç¤º' : '');
            // åœ°å›¾ç»„ä»¶åº”å®ç°æ­¤å‡½æ•°çš„å®é™…é€»è¾‘
        };
    </script>
    
    <!-- æ·»åŠ è¯Šæ–­æ§åˆ¶å°åŠŸèƒ½ï¼Œæ–¹ä¾¿åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­è°ƒè¯• -->
    <script>
        // åˆ›å»ºä¸€ä¸ªå…¨å±€è¯Šæ–­å‡½æ•°ï¼Œæ–¹ä¾¿åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­ä½¿ç”¨
        window.diagnose = function() {
            console.log('===== PtvAlert è¯Šæ–­å·¥å…· =====');
            
            // ç¯å¢ƒä¿¡æ¯
            console.log('ã€ç¯å¢ƒä¿¡æ¯ã€‘');
            console.log('- é¡µé¢URL:', window.location.href);
            console.log('- ä¸»æœºå:', window.location.hostname);
            console.log('- æ˜¯å¦GitHub Pages:', window.IS_GITHUB_PAGES ? 'æ˜¯' : 'å¦');
            
            if (window.IS_GITHUB_PAGES) {
                console.log('- GitHub PagesåŸºç¡€è·¯å¾„:', window.GITHUB_PAGES_BASE_PATH);
                console.log('- APIåŸºç¡€URL:', window.API_BASE_URL);
            }
            
            // Service Workerè¯Šæ–­
            console.log('\nã€Service WorkerçŠ¶æ€ã€‘');
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations()
                    .then(registrations => {
                        if (registrations.length === 0) {
                            console.log('- æœªæ³¨å†ŒService Worker');
                        } else {
                            registrations.forEach((reg, idx) => {
                                console.log(`- Service Worker #${idx+1}:`);
                                console.log('  Â· ä½œç”¨åŸŸ:', reg.scope);
                                console.log('  Â· çŠ¶æ€:', reg.active ? 'æ´»åŠ¨' : (reg.installing ? 'å®‰è£…ä¸­' : (reg.waiting ? 'ç­‰å¾…' : 'æœªçŸ¥')));
                                
                                if (reg.active) {
                                    console.log('  Â· è„šæœ¬URL:', reg.active.scriptURL);
                                }
                                
                                console.log('  Â· æ˜¯å¦ä¼ªService Worker:', reg.__fake ? 'æ˜¯' : 'å¦');
                            });
                        }
                    })
                    .catch(err => {
                        console.error('- è·å–Service Workeræ³¨å†Œä¿¡æ¯å¤±è´¥:', err);
                    });
            } else {
                console.log('- æµè§ˆå™¨ä¸æ”¯æŒService Worker');
            }
            
            // é€šçŸ¥æƒé™
            console.log('\nã€é€šçŸ¥æƒé™ã€‘');
            if ('Notification' in window) {
                console.log('- å½“å‰æƒé™çŠ¶æ€:', Notification.permission);
                
                if (window.notificationHandler) {
                    console.log('- é€šçŸ¥å¤„ç†ç¨‹åºå·²åŠ è½½');
                    window.notificationHandler.isSubscribedToPush()
                        .then(isSubscribed => {
                            console.log('- æ˜¯å¦å·²è®¢é˜…æ¨é€:', isSubscribed ? 'æ˜¯' : 'å¦');
                        })
                        .catch(err => {
                            console.error('- æ£€æŸ¥æ¨é€è®¢é˜…çŠ¶æ€å¤±è´¥:', err);
                        });
                } else {
                    console.log('- é€šçŸ¥å¤„ç†ç¨‹åºæœªåŠ è½½');
                }
            } else {
                console.log('- æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥API');
            }
            
            // ç¼“å­˜ä¿¡æ¯
            console.log('\nã€ç¼“å­˜ä¿¡æ¯ã€‘');
            if ('caches' in window) {
                caches.keys()
                    .then(cacheNames => {
                        if (cacheNames.length === 0) {
                            console.log('- æ— ç¼“å­˜');
                        } else {
                            console.log('- ç¼“å­˜åˆ—è¡¨:');
                            cacheNames.forEach(name => {
                                console.log('  Â· ' + name);
                            });
                        }
                    })
                    .catch(err => {
                        console.error('- è·å–ç¼“å­˜åˆ—è¡¨å¤±è´¥:', err);
                    });
            } else {
                console.log('- æµè§ˆå™¨ä¸æ”¯æŒCache API');
            }
            
            // æ•…éšœæ’é™¤æŒ‡å—
            console.log('\nã€å¸¸è§æ•…éšœæ’é™¤ã€‘');
            console.log('1. å¦‚æœService Workeræ³¨å†Œå¤±è´¥ï¼Œå°è¯•ä»¥ä¸‹æ­¥éª¤:');
            console.log('   - æ¸…é™¤æµè§ˆå™¨ç¼“å­˜: Chrome -> è®¾ç½® -> éšç§è®¾ç½®å’Œå®‰å…¨æ€§ -> æ¸…é™¤æµè§ˆæ•°æ®');
            console.log('   - ç¡®ä¿URLä½¿ç”¨httpsæˆ–localhost');
            console.log('   - åœ¨æ§åˆ¶å°è¿è¡Œ: navigator.serviceWorker.getRegistrations().then(r => r.forEach(reg => reg.unregister()))');
            
            console.log('2. å¦‚æœæ¨é€é€šçŸ¥ä¸å·¥ä½œ:');
            console.log('   - æ£€æŸ¥æµè§ˆå™¨é€šçŸ¥æƒé™è®¾ç½®');
            console.log('   - é‡æ–°è®¢é˜…æ¨é€: window.notificationHandler.subscribeUserToPush()');
            
            console.log('3. ä¿®å¤GitHub Pagesè·¯å¾„é—®é¢˜:');
            console.log('   - åˆ·æ–°é¡µé¢å¹¶æ¸…é™¤ç¼“å­˜: Ctrl+F5 æˆ– Cmd+Shift+R');
            console.log('   - åœ¨æ§åˆ¶å°è¿è¡Œ: window.runGitHubPagesDiagnostics()');
            
            console.log('\nå¦‚éœ€é‡æ–°è¿è¡Œè¯Šæ–­ï¼Œè¯·åœ¨æ§åˆ¶å°è¾“å…¥: window.diagnose()');
            console.log('===== è¯Šæ–­ç»“æŸ =====');
        };
        
        // åœ¨æ§åˆ¶å°ä¸­æç¤ºç”¨æˆ·å¯ä»¥ä½¿ç”¨çš„è¯Šæ–­åŠŸèƒ½
        console.log('%c ğŸ› ï¸ PtvAlert è¯Šæ–­å·¥å…·å¯ç”¨! è¾“å…¥ window.diagnose() æˆ– diagnose() ä»¥è·å–è¯¦ç»†ä¿¡æ¯', 'background:#0071e3;color:white;padding:5px 10px;border-radius:4px;font-weight:bold;');
    </script>

    <!-- æ·»åŠ ä¸»åŠ¨æ¨é€è¯·æ±‚æç¤ºåŠŸèƒ½ -->
    <div id="notification-prompt-banner" style="display: none; position: fixed; bottom: 20px; left: 10px; right: 10px; max-width: 600px; margin: 0 auto; background: rgba(0,0,0,0.8); color: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000; font-size: 14px;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center;">
                <div style="font-size: 24px; margin-right: 10px;">ğŸ””</div>
                <div>
                    <div style="font-weight: bold; margin-bottom: 5px;">æ¥æ”¶åœ°å›¾æ ‡è®°æ›´æ–°</div>
                    <div>å¼€å¯é€šçŸ¥ï¼ŒåŠæ—¶è·å–åœ°å›¾ä¸Šçš„æ–°æ ‡è®°ä¿¡æ¯ï¼</div>
                </div>
            </div>
            <div>
                <button id="enable-notifications-btn" style="background: #0071e3; color: white; border: none; padding: 8px 15px; border-radius: 5px; margin-right: 10px; cursor: pointer;">å¼€å¯é€šçŸ¥</button>
                <button id="dismiss-prompt-btn" style="background: transparent; color: #ccc; border: 1px solid #ccc; padding: 8px 15px; border-radius: 5px; cursor: pointer;">æš‚ä¸éœ€è¦</button>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ æ¨é€æŒ‰é’®äº‹ä»¶å¤„ç† -->
    <script>
        // ä¸ºæ·»åŠ çš„æ¨é€é€šçŸ¥æŒ‰é’®æ·»åŠ äº‹ä»¶å¤„ç†
        document.addEventListener('DOMContentLoaded', function() {
            const pushButton = document.getElementById('requestPushPermission');
            if (pushButton) {
                pushButton.addEventListener('click', function() {
                    if (window.notificationHandler && typeof window.notificationHandler.requestNotificationPermission === 'function') {
                        window.notificationHandler.requestNotificationPermission();
                    } else {
                        console.error('é€šçŸ¥å¤„ç†ç¨‹åºä¸å¯ç”¨æˆ–ç¼ºå°‘requestNotificationPermissionæ–¹æ³•');
                        // å›é€€åˆ°ç®€å•å®ç°
                        requestPushPermissionFallback();
                    }
                });
                
                // æ›´æ–°åˆå§‹æŒ‰é’®çŠ¶æ€
                updatePushButtonState();
            }
            
            // ç®€å•çš„å›é€€å®ç°ï¼Œç”¨äºå¤„ç†é€šçŸ¥å¤„ç†ç¨‹åºä¸å¯ç”¨çš„æƒ…å†µ
            function requestPushPermissionFallback() {
                if (!('Notification' in window)) {
                    alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥åŠŸèƒ½');
                    return;
                }
                
                Notification.requestPermission().then(function(permission) {
                    console.log('é€šçŸ¥æƒé™ç»“æœ:', permission);
                    updatePushButtonState();
                    
                    if (permission === 'granted') {
                        // æ˜¾ç¤ºæ¬¢è¿é€šçŸ¥
                        new Notification('åœ°å›¾æ ‡è®°é€šçŸ¥å·²å¯ç”¨', {
                            body: 'æ‚¨å°†æ”¶åˆ°åœ°å›¾ä¸Šæ–°æ ‡è®°çš„é€šçŸ¥',
                            icon: './images/icon-192x192.png'
                        });
                        
                        // è®¾ç½®æ ‡è®°è§‚å¯Ÿå™¨
                        setupMarkerObserverFallback();
                    }
                });
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            function updatePushButtonState() {
                const pushButton = document.getElementById('requestPushPermission');
                const pushBtnText = document.getElementById('pushBtnText');
                
                if (!pushButton || !pushBtnText) return;
                
                if (Notification.permission === 'granted') {
                    pushButton.style.backgroundColor = '#34c759';
                    pushBtnText.textContent = 'é€šçŸ¥å·²å¯ç”¨';
                } else if (Notification.permission === 'denied') {
                    pushButton.style.backgroundColor = '#ff3b30';
                    pushBtnText.textContent = 'é€šçŸ¥å·²ç¦ç”¨';
                } else {
                    pushButton.style.backgroundColor = '#0071e3';
                    pushBtnText.textContent = 'å¯ç”¨æ¨é€é€šçŸ¥';
                }
            }
            
            // ç®€å•çš„æ ‡è®°è§‚å¯Ÿå™¨å›é€€å®ç°
            function setupMarkerObserverFallback() {
                if (window._markerObserverInterval) {
                    clearInterval(window._markerObserverInterval);
                }
                
                let currentMarkerCount = window.mapMarkers ? window.mapMarkers.length : 0;
                
                window._markerObserverInterval = setInterval(() => {
                    if (!window.mapMarkers) return;
                    
                    if (window.mapMarkers.length > currentMarkerCount) {
                        const newMarkersCount = window.mapMarkers.length - currentMarkerCount;
                        const newMarkers = window.mapMarkers.slice(-newMarkersCount);
                        
                        if (Notification.permission === 'granted') {
                            new Notification('åœ°å›¾æœ‰æ–°æ ‡è®°', {
                                body: `æ·»åŠ äº†${newMarkersCount}ä¸ªæ–°æ ‡è®°`,
                                icon: './images/icon-192x192.png'
                            });
                        }
                        
                        currentMarkerCount = window.mapMarkers.length;
                    }
                }, 5000);
            }
        });
    </script>

    <!-- æ·»åŠ Service Workeræ¶ˆæ¯å¤„ç† -->
    <script>
        // ç›‘å¬æ¥è‡ªService Workerçš„æ¶ˆæ¯
        navigator.serviceWorker.addEventListener('message', function(event) {
            console.log('æ”¶åˆ°Service Workeræ¶ˆæ¯:', event.data);
            
            // å¤„ç†é€šçŸ¥ç‚¹å‡»æ¶ˆæ¯
            if (event.data.type === 'NOTIFICATION_CLICK') {
                const notificationData = event.data.data || {};
                console.log('å¤„ç†é€šçŸ¥ç‚¹å‡»:', notificationData);
                
                // å¦‚æœæœ‰ç‰¹å®šæ ‡è®°IDï¼Œè·³è½¬åˆ°è¯¥æ ‡è®°
                if (notificationData.markerId && typeof window.showMarkerById === 'function') {
                    console.log('æ˜¾ç¤ºæ ‡è®°:', notificationData.markerId);
                    window.showMarkerById(notificationData.markerId, true);
                    
                    // æ˜¾ç¤ºé€šçŸ¥æ¨ªå¹…
                    if (notificationData.markerInfo) {
                        showNotificationBanner(`æ ‡è®°: ${notificationData.markerInfo.title || 'æ–°æ ‡è®°'}`, 
                            notificationData.markerInfo.description || '');
                    }
                }
            }
        });
        
        // æ˜¾ç¤ºé€šçŸ¥æ¨ªå¹…
        function showNotificationBanner(title, message) {
            // åˆ›å»ºé€šçŸ¥æ¨ªå¹…
            const banner = document.createElement('div');
            banner.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: rgba(0,0,0,0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                max-width: 90%;
                min-width: 300px;
                display: flex;
                align-items: center;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            const iconDiv = document.createElement('div');
            iconDiv.style.cssText = `
                font-size: 24px;
                margin-right: 10px;
            `;
            iconDiv.textContent = 'ğŸ“';
            
            const contentDiv = document.createElement('div');
            contentDiv.style.flexGrow = '1';
            
            const titleDiv = document.createElement('div');
            titleDiv.style.fontWeight = 'bold';
            titleDiv.style.marginBottom = '4px';
            titleDiv.textContent = title;
            
            const messageDiv = document.createElement('div');
            messageDiv.style.fontSize = '14px';
            messageDiv.textContent = message;
            
            contentDiv.appendChild(titleDiv);
            contentDiv.appendChild(messageDiv);
            
            banner.appendChild(iconDiv);
            banner.appendChild(contentDiv);
            
            document.body.appendChild(banner);
            
            // åŠ¨ç”»æ˜¾ç¤º
            setTimeout(() => {
                banner.style.opacity = '1';
            }, 10);
            
            // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                banner.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(banner);
                }, 300);
            }, 5000);
        }
        
        // æ·»åŠ æµ‹è¯•åŠŸèƒ½
        window.testPushNotification = function() {
            if (window.notificationHandler && typeof window.notificationHandler.sendTestNotification === 'function') {
                window.notificationHandler.sendTestNotification()
                    .then(result => {
                        console.log('æµ‹è¯•é€šçŸ¥å‘é€ç»“æœ:', result);
                        alert('æµ‹è¯•é€šçŸ¥å·²å‘é€');
                    })
                    .catch(error => {
                        console.error('å‘é€æµ‹è¯•é€šçŸ¥å¤±è´¥:', error);
                        alert('å‘é€æµ‹è¯•é€šçŸ¥å¤±è´¥: ' + error.message);
                    });
            } else {
                alert('é€šçŸ¥å¤„ç†ç¨‹åºä¸å¯ç”¨');
            }
        };
    </script>

    <!-- æ·»åŠ æ¨é€æŒ‰é’®äº‹ä»¶å¤„ç† -->
// ... existing code ...
</body>
</html>
